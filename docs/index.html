<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£ï¼šCPå€¼èˆ‡å››éšæ®µé‡å¡‘ç³»çµ±</title>
    <style>
        :root {
            --bg-color: #F8F9FA;
            --text-main: #2C3E50;
            --cue: #95A5A6;     /* æç¤º */
            --craving: #F39C12; /* æ¸´æœ› */
            --response: #8E44AD;/* å›æ‡‰ */
            --reward: #E74C3C;  /* çè³ */
            --good: #2ECC71;
            --bad: #E74C3C;
            --st-color: #3498DB;
            --lt-color: #34495E;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px;
        }

        .container {
            max-width: 1100px; margin: 0 auto; background: white;
            padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { text-align: center; }
        .text-center { text-align: center; }
        
        button {
            padding: 10px 20px; font-size: 1rem; color: white; background: var(--text-main);
            border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        button:hover { opacity: 0.8; }
        button.primary { background: var(--st-color); }
        button.success { background: var(--good); }

        input, select {
            width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box;
            border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;
        }

        .step { display: none; animation: fadeIn 0.5s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å››éšæ®µæ©«å‘ Pipeline UI */
        .pipeline-container {
            display: flex; gap: 15px; margin: 30px 0; overflow-x: auto; padding-bottom: 10px;
        }
        .stage-box {
            flex: 1; min-width: 200px; border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; min-height: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid;
            background: #FAFAFA; transition: 0.3s;
        }
        .stage-box.dragover { background: #E8F8F5; transform: scale(1.02); }
        
        #stage-cue { border-color: var(--cue); }
        #stage-craving { border-color: var(--craving); }
        #stage-response { border-color: var(--response); }
        #stage-reward { border-color: var(--reward); }

        .stage-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; text-align: center; }
        .stage-desc { font-size: 0.85rem; color: #7f8c8d; text-align: center; margin-bottom: 15px; }

        .drop-zone { flex: 1; border: 2px dashed #ccc; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 10px; }

        /* CP Token (ç‰©ä»¶) */
        .token-creator {
            background: #EDF2F8; padding: 20px; border-radius: 10px; margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
        }
        .cp-token {
            padding: 8px 12px; border-radius: 20px; color: white; cursor: grab;
            font-size: 0.9rem; font-weight: bold; display: flex; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); user-select: none;
        }
        .cp-token:active { cursor: grabbing; }
        .st-token { background: var(--st-color); }
        .lt-token { background: var(--lt-color); }

        /* è¨˜åˆ†æ¿èˆ‡ç‹€æ…‹å€ */
        .score-board {
            display: flex; justify-content: space-around; background: #eee;
            padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 1.2rem; font-weight: bold;
        }
        .score-st { color: var(--st-color); }
        .score-lt { color: var(--lt-color); }

        /* Tree UI */
        .tree-view {
            background: #2C3E50; color: white; padding: 20px; border-radius: 10px; margin-top: 30px;
            font-family: monospace; font-size: 1.1rem; white-space: pre; overflow-x: auto;
        }
        
        .alert-box {
            background: #FDEDEC; border-left: 5px solid var(--bad); padding: 15px; margin: 20px 0;
            color: #C0392B; display: none; font-weight: bold; border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- Step 1: Base Demand & Action Init -->
    <div id="step-1" class="step active">
        <h1>ğŸŒ² ç¿’æ…£åº•å±¤æ¶æ§‹ç³»çµ± (Human Tree)</h1>
        <p class="text-center">æ¯ä¸€å€‹ç¿’æ…£ï¼Œéƒ½æ˜¯ç‚ºäº†è§£æ±ºæŸå€‹åº•å±¤éœ€æ±‚ (Base Demand) çš„æ–¹æ¡ˆ (Action)ã€‚</p>
        
        <div style="max-width: 500px; margin: 0 auto;">
            <label>1. åº•å±¤éœ€æ±‚ (Base Demand)</label>
            <input type="text" id="demand-input" placeholder="ä¾‹ï¼šç´“è§£å·¥ä½œå£“åŠ›ã€ç²å¾—ç¤¾äº¤èªåŒ...">
            
            <label>2. æ¡å–çš„è¡Œå‹•/ç¿’æ…£ (Action)</label>
            <input type="text" id="action-input" placeholder="ä¾‹ï¼šæŠ½è¸ã€å¥èº«ã€åƒç”œé£Ÿ...">
            
            <label>3. é€™æ˜¯ä»€éº¼å±¬æ€§çš„ç¿’æ…£ï¼Ÿ</label>
            <select id="habit-type">
                <option value="bad">âŒ å£ç¿’æ…£ (æƒ³æˆ’é™¤ï¼Œé•·æœŸ CP å€¼ < 0)</option>
                <option value="good">âœ… å¥½ç¿’æ…£ (æƒ³åŸ¹é¤Šï¼Œé•·æœŸ CP å€¼ > 0)</option>
            </select>
            
            <button class="primary" onclick="initAction()" style="width: 100%; margin-top: 20px;">åˆå§‹åŒ–ç¿’æ…£çµæ§‹</button>
        </div>
    </div>

    <!-- Step 2: 4-Stage Loop & CP Builder -->
    <div id="step-2" class="step">
        <h2>ç¿’æ…£è¿´è·¯ï¼š<span id="display-action" style="color:var(--st-color);"></span></h2>
        <p class="text-center">åº•å±¤éœ€æ±‚ï¼š<span id="display-demand" style="font-weight:bold;"></span> | å±¬æ€§ï¼š<span id="display-type"></span></p>
        
        <!-- CP Token ç”¢ç”Ÿå™¨ -->
        <div class="token-creator">
            <div style="flex: 2; min-width: 200px;">
                <input type="text" id="cp-name" placeholder="CP è®Šæ•¸åç¨± (ä¾‹ï¼šçœ‹åˆ°ç”œé»åº—ã€å¤šå·´èƒºåˆ†æ³Œã€è®Šèƒ–...)">
            </div>
            <div style="flex: 1; min-width: 100px;">
                <input type="number" id="cp-score" placeholder="åˆ†æ•¸ (+/-)">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <select id="cp-time">
                    <option value="st">çŸ­æœŸ CP (Short-term)</option>
                    <option value="lt">é•·æœŸ CP (Long-term)</option>
                </select>
            </div>
            <button class="primary" onclick="createCPToken()">å»ºç«‹ CP ç‰©ä»¶</button>
        </div>

        <div id="token-dock" style="min-height: 50px; border: 2px dashed #999; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <span style="color: #777;">ï¼ˆæ–°ç”¢ç”Ÿçš„ CP ç‰©ä»¶æœƒåœ¨é€™è£¡ï¼Œè«‹æ‹–æ›³åˆ°ä¸‹æ–¹å››å€‹éšæ®µä¸­ï¼‰</span>
        </div>

        <!-- 4éšæ®µ Pipeline (å·¦è‡³å³) -->
        <div class="pipeline-container">
            <!-- æç¤º -->
            <div class="stage-box" id="stage-cue">
                <div class="stage-title" style="color: var(--cue);">1. æç¤º (Cue)</div>
                <div class="stage-desc">è§¸ç™¼å¤§è…¦çš„èµ·é»<br>(æ™‚é–“ã€åœ°é»ã€æƒ…ç·’)</div>
                <div class="drop-zone" id="zone-cue" ondragover="allowDrop(event)" ondrop="drop(event, 'cue')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <!-- æ¸´æœ› -->
            <div class="stage-box" id="stage-craving">
                <div class="stage-title" style="color: var(--craving);">2. æ¸´æœ› (Craving)</div>
                <div class="stage-desc">æƒ³æ”¹è®Šç‹€æ…‹çš„å‹•åŠ›<br>(é æœŸèƒ½è§£æ±ºéœ€æ±‚)</div>
                <div class="drop-zone" id="zone-craving" ondragover="allowDrop(event)" ondrop="drop(event, 'craving')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <!-- å›æ‡‰ -->
            <div class="stage-box" id="stage-response">
                <div class="stage-title" style="color: var(--response);">3. å›æ‡‰ (Response)</div>
                <div class="stage-desc">å¯¦éš›åŸ·è¡Œçš„å‹•ä½œ<br>(é˜»åŠ›èˆ‡æ‘©æ“¦åŠ›)</div>
                <div class="drop-zone" id="zone-response" ondragover="allowDrop(event)" ondrop="drop(event, 'response')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <!-- çè³ -->
            <div class="stage-box" id="stage-reward">
                <div class="stage-title" style="color: var(--reward);">4. çè³ (Reward)</div>
                <div class="stage-desc">æœ€çµ‚ç²å¾—çš„å›é¥‹<br>(çŸ­æœŸçˆ½åº¦/é•·æœŸä»£åƒ¹)</div>
                <div class="drop-zone" id="zone-reward" ondragover="allowDrop(event)" ondrop="drop(event, 'reward')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
        </div>

        <!-- è¨˜åˆ†æ¿ -->
        <div class="score-board">
            <div>çŸ­æœŸç¸½ CP å€¼ï¼š<span id="score-st-total" class="score-st">0</span></div>
            <div>é•·æœŸç¸½ CP å€¼ï¼š<span id="score-lt-total" class="score-lt">0</span></div>
        </div>

        <!-- ç³»çµ±å¼·åˆ¶æ ¡æ­£è­¦å‘Šå€ -->
        <div id="alert-box" class="alert-box"></div>

        <div style="text-align: center;">
            <button class="success" onclick="validateAndShowTree()" style="font-size: 1.2rem; padding: 15px 40px;">ç³»çµ±æ ¡æ­£èˆ‡æª¢æ ¸ (Check)</button>
        </div>
    </div>

    <!-- Step 3: Final Tree Display -->
    <div id="step-3" class="step">
        <h2>ğŸŒ ä½ çš„è¡Œç‚ºæ±ºç­–æ¨¹ (Human Action Tree)</h2>
        <p class="text-center">å¤§è…¦æœƒè‡ªå‹•åœ¨åŒä¸€å€‹éœ€æ±‚ä¸‹ï¼Œé¸æ“‡ã€Œç¸½åˆæ€§åƒ¹æ¯”ã€æœ€é«˜çš„é¸é …ã€‚<br>é€™å°±æ˜¯ä½ åœ¨ Python çµæ§‹ä¸­ `human.children[-1].data` çš„æœ€çµ‚æ¨¡æ¨£ï¼š</p>
        
        <div class="tree-view" id="tree-display"></div>
        
        <button class="primary" onclick="location.reload()" style="margin-top: 30px;">æ¸¬è©¦å…¶ä»–ç¿’æ…£</button>
    </div>

</div>

<script>
    // Python çµæ§‹æ¨¡æ“¬
    let treeData = {
        name: "human",
        demand: "",
        actionName: "",
        habitType: "",
        actionsMap: {} // å­˜æ”¾ä¸åŒæ–¹æ¡ˆçš„ CP å€¼
    };

    let cpTokens = []; // å­˜æ”¾æ‰€æœ‰çš„ token
    let draggedTokenId = null;

    // éš¨æ©Ÿç”¢ç”Ÿ ID çš„ Helper
    function generateId() { return Math.random().toString(36).substr(2, 9); }

    // Step 1 -> Step 2
    function initAction() {
        const demand = document.getElementById('demand-input').value.trim();
        const action = document.getElementById('action-input').value.trim();
        const type = document.getElementById('habit-type').value;

        if(!demand || !action) return alert("è«‹å¡«å¯«éœ€æ±‚èˆ‡è¡Œå‹•ï¼");

        treeData.demand = demand;
        treeData.actionName = action;
        treeData.habitType = type;

        document.getElementById('display-demand').innerText = demand;
        document.getElementById('display-action').innerText = action;
        document.getElementById('display-type').innerHTML = type === 'bad' ? 'âŒ å£ç¿’æ…£' : 'âœ… å¥½ç¿’æ…£';

        // æ¨¡æ“¬æ¨¹è£¡æœ¬ä¾†å°±å­˜æœ‰å¹¾å€‹é è¨­çš„å¤§è…¦è¡Œå‹• (Python çš„ for i in range(1, 11))
        treeData.actionsMap = {
            "Action 1 (ç™¼å‘†)": { cp: 0.5 },
            "Action 2 (æ»‘æ‰‹æ©Ÿ)": { cp: 2.5 }
        };

        switchStep(2);
    }

    // å‰µå»º CP Token
    function createCPToken() {
        const name = document.getElementById('cp-name').value.trim();
        const score = parseFloat(document.getElementById('cp-score').value);
        const timeType = document.getElementById('cp-time').value;

        if(!name || isNaN(score)) return alert("è«‹å¡«å¯«å®Œæ•´çš„åç¨±èˆ‡åˆ†æ•¸ï¼");

        const token = {
            id: 't_' + generateId(),
            name: name,
            score: score,
            timeType: timeType,
            stage: null // å°šæœªåˆ†é… stage
        };

        cpTokens.push(token);
        renderToken(token, 'token-dock');

        document.getElementById('cp-name').value = '';
        document.getElementById('cp-score').value = '';
        updateScores();
    }

    // å°‡ Token æ¸²æŸ“åˆ°ç•«é¢ä¸Š
    function renderToken(token, containerId) {
        const el = document.createElement('div');
        el.className = `cp-token ${token.timeType === 'st' ? 'st-token' : 'lt-token'}`;
        el.id = token.id;
        el.draggable = true;
        el.innerHTML = `<span>${token.name}</span> <span>${token.score > 0 ? '+'+token.score : token.score}</span>`;
        
        el.addEventListener('dragstart', (e) => {
            draggedTokenId = token.id;
            setTimeout(() => el.style.opacity = '0.5', 0);
        });
        el.addEventListener('dragend', (e) => { el.style.opacity = '1'; });

        document.getElementById(containerId).appendChild(el);
    }

    // Drag & Drop é‚è¼¯
    function allowDrop(ev) { ev.preventDefault(); }
    function dragEnter(ev) { ev.currentTarget.parentElement.classList.add('dragover'); }
    function dragLeave(ev) { ev.currentTarget.parentElement.classList.remove('dragover'); }
    
    function drop(ev, stage) {
        ev.preventDefault();
        ev.currentTarget.parentElement.classList.remove('dragover');
        
        if (draggedTokenId) {
            const tokenEl = document.getElementById(draggedTokenId);
            ev.currentTarget.appendChild(tokenEl);
            
            // æ›´æ–°è³‡æ–™å…§çš„ stage
            const tokenData = cpTokens.find(t => t.id === draggedTokenId);
            if(tokenData) tokenData.stage = stage;
            
            draggedTokenId = null;
        }
    }

    // è¨ˆç®—åˆ†æ•¸
    function updateScores() {
        let stTotal = cpTokens.filter(t => t.timeType === 'st').reduce((acc, curr) => acc + curr.score, 0);
        let ltTotal = cpTokens.filter(t => t.timeType === 'lt').reduce((acc, curr) => acc + curr.score, 0);

        document.getElementById('score-st-total').innerText = stTotal;
        document.getElementById('score-lt-total').innerText = ltTotal;
        
        return { stTotal, ltTotal };
    }

    // ==========================================
    // æ ¸å¿ƒæ ¡æ­£é‚è¼¯ (The CP Validation Force Rule)
    // ==========================================
    function validateAndShowTree() {
        const alertBox = document.getElementById('alert-box');
        const { stTotal, ltTotal } = updateScores();
        
        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ token éƒ½å·²ç¶“æ”¾å…¥å››å€‹éšæ®µä¸­
        const unassigned = cpTokens.filter(t => !t.stage);
        if(unassigned.length > 0) {
            alertBox.innerHTML = `âš ï¸ è«‹å°‡ä¸Šæ–¹çš„ CP ç‰©ä»¶æ‹–æ›³åˆ°ä¸‹æ–¹ã€Œæç¤ºã€æ¸´æœ›ã€å›æ‡‰ã€çè³ã€çš„å°æ‡‰éšæ®µä¸­ï¼é€™ä¸æœƒå½±éŸ¿ç¸½åˆ†ï¼Œä½†èƒ½å¹«ä½ é‡æ¸…åœ¨å“ªå€‹éšæ®µä¸‹æ‰‹ã€‚`;
            alertBox.style.display = 'block';
            return;
        }

        // è¦å‰‡ 1ï¼šå¦‚æœæ˜¯å£ç¿’æ…£ï¼Œå¼·è¿«çŸ­æœŸ CP å€¼å¿…é ˆ < 0
        if(treeData.habitType === 'bad' && stTotal >= 0) {
            alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±æ ¡æ­£æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå£ç¿’æ…£ã€ï¼<br>
            ä½ çš„çŸ­æœŸ CP å€¼ç›®å‰æ˜¯ ${stTotal} (>=0)ã€‚<br>
            åªè¦çŸ­æœŸ CP æ˜¯æ­£çš„ï¼Œå¤§è…¦çš„å¤šå·´èƒºè¿´è·¯å°±ä¸æœƒæ”¾æ£„ï¼<br>
            ğŸ‘‰ <b>è«‹ç¹¼çºŒå»ºç«‹è² é¢çš„çŸ­æœŸ CP (æ‘©æ“¦åŠ›/æ‡²ç½°)ï¼Œä¸¦æ‹–æ›³é€²å»ï¼Œç›´åˆ°çŸ­æœŸ CP è®Šæˆè² æ•¸ï¼</b>`;
            alertBox.style.display = 'block';
            return;
        }

        // è¦å‰‡ 2ï¼šå¦‚æœæ˜¯å¥½ç¿’æ…£ï¼Œå¼·è¿«çŸ­æœŸ CP å€¼å¿…é ˆ > 0
        if(treeData.habitType === 'good' && stTotal <= 0) {
            alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±æ ¡æ­£æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå¥½ç¿’æ…£ã€ï¼<br>
            ä½ çš„çŸ­æœŸ CP å€¼ç›®å‰æ˜¯ ${stTotal} (<=0)ã€‚<br>
            å¤§è…¦æ˜¯çŸ­è¦–çš„ï¼Œå¦‚æœçŸ­æœŸå¤ªç—›è‹¦ä¸”æ²’çå‹µï¼Œå¤§è…¦çµ•å°ç„¡æ³•å …æŒï¼<br>
            ğŸ‘‰ <b>è«‹ç¹¼çºŒå»ºç«‹æ­£é¢çš„çŸ­æœŸ CP (ç«‹å³çå‹µ/é™ä½é›£åº¦)ï¼Œä¸¦æ‹–æ›³é€²å»ï¼Œç›´åˆ°çŸ­æœŸ CP è®Šæˆæ­£æ•¸ï¼</b>`;
            alertBox.style.display = 'block';
            return;
        }

        alertBox.style.display = 'none';

        // é€šéæª¢æ ¸ï¼Œå°‡é€™å€‹æ–°ç¿’æ…£å¯«å…¥å¤§è…¦æ¸…å–®ä¸­ (æ¨¡æ“¬ Map)
        // æœ€çµ‚çš„å¤§è…¦æ±ºç­–åˆ† = çŸ­æœŸ CP + (é•·æœŸ CP * 0.1 åèª¤æŠ˜åƒ¹)
        let finalBrainScore = stTotal + (ltTotal * 0.1);
        treeData.actionsMap[treeData.actionName] = { 
            cp: finalBrainScore.toFixed(2), 
            st: stTotal, 
            lt: ltTotal 
        };

        renderTree();
        switchStep(3);
    }

    // æ¸²æŸ“ Python æ¨¹ç‹€çµæ§‹
    function renderTree() {
        const treeDiv = document.getElementById('tree-display');
        
        // å°‡ Map æ’åº (Sort by cp_value)
        const sortedActions = Object.entries(treeData.actionsMap)
            .sort((a, b) => b[1].cp - a[1].cp); // é™å†ªæ’åº

        let output = `â””â”€â”€ human (root)\n`;
        output += `    â””â”€â”€ base_demand: ${treeData.demand}\n`;
        output += `        â””â”€â”€ data_name: "action for the base demand"\n`;
        output += `        â””â”€â”€ data (Sorted by Brain CP Value):\n`;
        
        sortedActions.forEach(([name, data], index) => {
            const isTarget = name === treeData.actionName;
            const prefix = isTarget ? 'âœ¨ ' : '   ';
            output += `            ${prefix}${index + 1}. [${name}]\n`;
            if (isTarget) {
                output += `                  â”œâ”€ çŸ­æœŸ CP: ${data.st}\n`;
                output += `                  â”œâ”€ é•·æœŸ CP: ${data.lt}\n`;
                output += `                  â””â”€ å¤§è…¦æœ€çµ‚è©•ä¼°ç¸½ CP: ${data.cp}\n`;
            } else {
                output += `                  â””â”€ å¤§è…¦æœ€çµ‚è©•ä¼°ç¸½ CP: ${data.cp}\n`;
            }
        });

        treeDiv.innerText = output;
    }

    function switchStep(stepNum) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${stepNum}`).classList.add('active');
    }

</script>
</body>
</html>