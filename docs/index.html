<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£ï¼šå¤§è…¦è¡Œç‚ºæ¨¹ç³»çµ±</title>
    <style>
        /* ================= TOS Block Overlay ================= */
        .tos-block-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            z-index: 90;
            /* å¿…é ˆä½æ–¼ Auth-bar (100) èˆ‡ Modal (9000+)ï¼Œé˜»æ“‹å…¶é¤˜å…§å®¹ */
            pointer-events: auto;
            /* æ””æˆªé»æ“Š */
        }

        .tos-block-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            display: none;
        }

        .tos-block-overlay.show .tos-block-content {
            display: block;
        }

        .tos-block-overlay.show {
            display: block;
        }

        /* ================= åŸºç¤é¡è‰²èˆ‡å…¨åŸŸè¨­å®š ================= */
        :root {
            --bg-color: #F4F7F6;
            --text-main: #2C3E50;
            --cue: #95A5A6;
            --craving: #F39C12;
            --response: #8E44AD;
            --reward: #E74C3C;
            --good: #2ECC71;
            --bad: #E74C3C;
            --st-color: #3498DB;
            --lt-color: #34495E;
            --line-color: #BDC3C7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            /* ç•«å¸ƒæ¨¡å¼ä¸‹ç§»é™¤ padding */
            overflow-x: hidden;
        }

        /* é™åˆ¶ä¸€èˆ¬è¡¨å–®ç•«é¢çš„æœ€å¤§å¯¬åº¦ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            text-align: center;
        }

        /* ================= HTML æç¤ºç³»çµ± (Toast) ================= */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 2px solid;
            pointer-events: auto;
        }

        .toast .toast-close {
            margin-left: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .toast .toast-close:hover {
            opacity: 1;
        }

        .toast.error {
            border-color: var(--bad);
            color: var(--bad);
        }

        .toast.success {
            border-color: var(--good);
            color: var(--good);
        }

        .toast.warning {
            border-color: var(--craving);
            color: var(--craving);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ================= æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† ================= */
        button {
            padding: 12px 24px;
            font-size: 1rem;
            color: white;
            background: var(--text-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.8;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        button.primary {
            background: var(--st-color);
        }

        button.success {
            background: var(--good);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.2s;
        }

        input:focus {
            border-color: var(--st-color);
            outline: none;
        }

        /* ================= è¦–åœ–åˆ‡æ› ================= */
        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ================= View 0: æ­¡è¿ç•«é¢ ================= */
        .welcome-box {
            background: white;
            max-width: 600px;
            margin: 80px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 6px solid var(--st-color);
        }

        /* ================= View 1: ç„¡é‚Šç•Œç•«å¸ƒæ¨¹ç‹€åœ– (Infinite Canvas) ================= */
        .tree-canvas-container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            /* éš±è—åŸç”Ÿæ‹‰æ¢ */
            background: radial-gradient(circle, #EAECEE 2px, transparent 2px);
            /* ç¶²æ ¼èƒŒæ™¯ */
            background-size: 30px 30px;
            background-color: var(--bg-color);
            position: fixed;
            top: 0;
            left: 0;
            cursor: grab;
            z-index: 1;
        }

        .tree-canvas-container:active {
            cursor: grabbing;
        }

        .tree-zoom-layer {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            /* ç¢ºä¿æ˜¯ä»¥å·¦ä¸Šè§’ç‚ºåŸºæº–é»è¨ˆç®—ç¸®æ”¾ï¼Œä¸¦ç”± JS æ§åˆ¶å¹³ç§» */
            will-change: transform;
            padding: 100px;
            /* çµ¦äºˆå…§éƒ¨ä¸€é»åˆå§‹ç·©è¡ç©ºé–“ */
        }

        /* æµ®å‹•çš„æ¨™é¡Œ UI (è“‹åœ¨ç•«å¸ƒä¸Šæ–¹) */
        .canvas-ui-layer {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .canvas-ui-layer>* {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        /* æ¨¹ç‹€åœ–æ ¸å¿ƒä½ˆå±€ */
        ul.tree {
            list-style: none;
            padding-left: 0;
            display: flex;
            margin: 0;
            align-items: center;
            justify-content: flex-start;
        }

        ul.tree ul {
            list-style: none;
            padding-left: 120px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        ul.tree li {
            display: flex;
            align-items: center;
            position: relative;
            padding: 20px 0;
        }

        .node-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 180px;
            text-align: center;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .node-box.root-node {
            border-color: var(--text-main);
            background: var(--text-main);
            color: white;
            cursor: default;
        }

        .node-box.demand-node {
            border-left: 8px solid var(--st-color);
        }

        .node-box.action-node {
            border-color: #eee;
            background: #F8F9FA;
        }

        .node-box.action-node:hover {
            border-color: var(--st-color);
            transform: scale(1.05);
            background: #EDF2F8;
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
        }

        .node-box.action-node.lt-negative {
            border: 2px dashed var(--bad);
        }

        .node-box.action-node.lt-positive {
            border: 2px dashed var(--good);
        }

        .node-box.add-node {
            border: 2px dashed var(--good);
            color: var(--good);
            background: #E8F8F5;
            font-weight: bold;
        }

        .node-box.add-node:hover {
            background: var(--good);
            color: white;
        }

        .cp-crown {
            font-size: 1.5rem;
            position: absolute;
            top: -15px;
            left: -10px;
            transform: rotate(-20deg);
        }

        .action-cp-text {
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 8px;
            color: #7f8c8d;
        }

        /* Hover "x" delete button on top-right of nodes */
        .node-delete-x {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bad);
            color: white;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5;
            font-weight: bold;
        }

        .node-box:hover>.node-delete-x {
            opacity: 1;
        }

        .node-delete-x:hover {
            transform: scale(1.2);
        }

        /* é€£æ¥ç·š (has-children æ©«ç·šå·²ç§»é™¤ï¼Œåƒ…ä¿ç•™ li ä¸Šçš„çµæ§‹ç·š) */

        .rel-text {
            position: absolute;
            right: -105px;
            top: -20px;
            font-size: 0.8rem;
            color: var(--text-main);
            font-weight: bold;
            width: 90px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3;
            padding: 4px 0;
            border-radius: 4px;
        }

        .rel-text.action-rel {
            color: var(--craving);
        }

        .best-action-label {
            position: absolute;
            right: calc(100% + 5px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: var(--craving);
            font-weight: bold;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3;
            padding: 4px 6px;
            border-radius: 4px;
        }

        /* å¤§è…¦çŸ­æœŸé è¨­ç·šï¼šå¾ demand åˆ°çŸ­æœŸCPæœ€é«˜çš„ action */
        ul.tree ul li.st-default-line-red::before {
            background: var(--bad) !important;
            height: 2px;
        }

        ul.tree ul li.st-default-line-green::before {
            background: var(--good) !important;
            height: 2px;
        }

        /* å‚ç›´è‰²ç·šï¼šç”¨ overlay div è¦†è“‹åœ¨åŸæœ¬çš„ç°è‰²ç·šä¸Šé¢ */
        .st-vert-overlay {
            position: absolute;
            left: -120px;
            top: 0;
            bottom: 0;
            width: 2px;
            z-index: 2;
            pointer-events: none;
        }

        .st-vert-overlay.red {
            background: var(--bad);
        }

        .st-vert-overlay.green {
            background: var(--good);
        }

        /* èµ·é»ï¼šåœåœ¨æ°´å¹³ç·šçš„å‚ç›´ä¸­å¿ƒ (é€šå¸¸å¾€ä¸‹å»¶å±•) */
        li:first-child>.st-vert-overlay,
        .st-vert-overlay.start {
            top: 50%;
        }

        /* çµ‚é»ï¼šåœåœ¨æ°´å¹³ç·šçš„å‚ç›´ä¸­å¿ƒ (é€šå¸¸å¾€ä¸Šå»¶å±•) */
        .st-vert-overlay.end {
            bottom: calc(50% - 2px);
            /* overlap exactly with the 2px horizontal line */
        }

        /* å¦‚æœåŒä¸€å€‹é»æ—¢æ˜¯èµ·é»åˆæ˜¯çµ‚é»ï¼ˆæ°´å¹³å°é€£ï¼‰å°±ä¹¾è„†éš±è—ï¼Œå› ç‚ºä¸éœ€è¦å‚ç›´ç·š */
        .st-vert-overlay.start.end {
            display: none;
        }

        .st-default-label {
            position: absolute;
            right: calc(100% + 5px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            z-index: 3;
            padding: 4px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
        }

        .best-action-label.up {
            top: calc(50% - 15px);
        }

        .st-default-label.down {
            top: calc(50% + 15px);
        }

        .st-default-label.bad {
            color: var(--bad);
        }

        .st-default-label.good {
            color: var(--good);
        }

        ul.tree ul li::before {
            content: '';
            position: absolute;
            left: -120px;
            top: 50%;
            width: 120px;
            height: 2px;
            background: var(--line-color);
            z-index: 1;
        }

        ul.tree ul li::after {
            content: '';
            position: absolute;
            left: -120px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--line-color);
            z-index: 1;
        }

        ul.tree ul li:first-child::after {
            top: 50%;
        }

        ul.tree ul li:last-child::after {
            bottom: 50%;
        }

        ul.tree ul li:first-child:last-child::after {
            display: none;
        }

        /* ================= View 2: å››éšæ®µç·¨è¼¯å™¨ ================= */
        .editor-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 15px;
        }

        .stage-box {
            flex: 1;
            min-width: 240px;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 280px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-top: 6px solid;
            transition: all 0.2s ease;
        }

        .stage-box.dragover {
            background: #F4F6F6;
            transform: scale(1.02);
        }

        #stage-cue {
            border-color: var(--cue);
        }

        #stage-craving {
            border-color: var(--craving);
        }

        #stage-response {
            border-color: var(--response);
        }

        #stage-reward {
            border-color: var(--reward);
        }

        /* Drop zone å…§éƒ¨ç½®ä¸­è¨­å®š */
        .drop-zone {
            flex: 1;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 120px;
            margin-top: 15px;
        }

        #token-dock {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border-color: var(--st-color);
        }

        .dock-hint {
            width: 100%;
            text-align: center;
            color: #999;
            font-size: 0.95rem;
            user-select: none;
        }

        .token-creator {
            background: #EDF2F8;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .cp-token {
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            cursor: grab;
            font-size: 0.95rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            user-select: none;
            z-index: 10;
        }

        .cp-token:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .st-token {
            background: var(--st-color);
        }

        .lt-token {
            background: var(--lt-color);
        }

        .token-del {
            margin-left: 15px;
            cursor: pointer;
            color: #fff;
            opacity: 0.7;
        }

        .token-del:hover {
            opacity: 1;
        }

        .score-board {
            display: block;
            text-align: center;
            background: white;
            padding: 20px 20px 35px 20px;
            /* enough space for absolute item */
            border-radius: 12px;
            margin: 25px 0;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* ç³»çµ±å¼·åˆ¶é˜²è­·çš„ HTML æ–‡å­—æ¡† */
        .alert-box {
            background: #FDEDEC;
            border: 2px solid var(--bad);
            border-left-width: 8px;
            padding: 20px;
            margin: 25px 0;
            color: #C0392B;
            display: none;
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .alert-box.success-box {
            background: #EAFAF1;
            border-color: var(--good);
            color: #1E8449;
        }

        /* ================= Google Auth UI ================= */
        .auth-bar {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-bar .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 16px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .auth-bar .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 22px;
            background: white;
            color: #444;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .btn-google:hover {
            background: #f8f8f8;
            border-color: #4285F4;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.2);
        }

        .btn-drive {
            padding: 8px 18px;
            background: #0F9D58;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-drive:hover {
            background: #0B8043;
            transform: scale(1.03);
        }

        .btn-logout {
            padding: 6px 14px;
            background: transparent;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            color: var(--bad);
            border-color: var(--bad);
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            margin-left: 5px;
            vertical-align: middle;
        }

        .sync-indicator.synced {
            background: var(--good);
        }

        .sync-indicator.syncing {
            background: var(--craving);
            animation: pulse 1s infinite;
        }

        .sync-indicator.error {
            background: var(--bad);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .welcome-auth {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 12px;
        }

        .welcome-auth p {
            margin: 8px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* ================= More Options (â˜°) Menu ================= */
        .more-options-wrapper {
            position: relative;
            display: inline-block;
        }

        .btn-more {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.4rem;
            color: #555;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .btn-more:hover {
            border-color: var(--st-color);
            color: var(--st-color);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .more-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 260px;
            z-index: 200;
            overflow: hidden;
            animation: dropIn 0.2s ease;
        }

        @keyframes dropIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .more-dropdown.show {
            display: block;
        }

        .more-dropdown-header {
            padding: 14px 18px;
            font-weight: bold;
            font-size: 0.85rem;
            color: #999;
            border-bottom: 1px solid #f0f0f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .more-dropdown-item {
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.92rem;
            color: #333;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .more-dropdown-item:hover {
            background: #f4f7fc;
        }

        .more-dropdown-item.active {
            background: #eef5ff;
            color: var(--st-color);
            font-weight: bold;
        }

        .more-dropdown-item .item-icon {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }

        .more-dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 4px 0;
        }

        /* ================= Conflict Modal ================= */
        .conflict-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .conflict-overlay.show {
            display: flex;
        }

        .conflict-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: dropIn 0.3s ease;
        }

        .conflict-modal h2 {
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .conflict-modal .conflict-subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .conflict-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .conflict-side {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }

        .conflict-side.local-side {
            border-color: var(--craving);
        }

        .conflict-side.drive-side {
            border-color: var(--st-color);
        }

        .conflict-side h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .conflict-side .tree-preview {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
        }

        .conflict-side .tree-preview .demand-item {
            font-weight: bold;
            color: var(--text-main);
            margin-top: 8px;
        }

        .conflict-side .tree-preview .action-item {
            padding-left: 16px;
            color: #666;
        }

        .conflict-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .conflict-actions button {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-use-local {
            background: var(--craving);
            color: white;
            border: none;
        }

        .btn-use-local:hover {
            background: #e67e22;
            transform: scale(1.03);
        }

        .btn-use-drive {
            background: var(--st-color);
            color: white;
            border: none;
        }

        .btn-use-drive:hover {
            background: #2980b9;
            transform: scale(1.03);
        }

        .conflict-note {
            margin-top: 16px;
            font-size: 0.82rem;
            color: #999;
            text-align: center;
            line-height: 1.5;
        }

        /* ================= Welcome top-right More ================= */
        .welcome-top-bar {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 100;
        }

        /* ================= Loading Overlay ================= */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #e0e0e0;
            border-top: 5px solid var(--st-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-status {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-main);
            text-align: center;
        }

        .loading-sub {
            font-size: 0.85rem;
            color: #999;
        }

        /* ================= Generic Modal (replaces confirm/prompt) ================= */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 9500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            padding: 28px;
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.25);
            animation: dropIn 0.25s ease;
            text-align: center;
        }

        .modal-box h3 {
            margin: 0 0 12px 0;
            font-size: 1.15rem;
            color: var(--text-main);
        }

        .modal-box p {
            margin: 0 0 18px 0;
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
        }

        .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .modal-box input:focus {
            border-color: var(--st-color);
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-actions button {
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: var(--st-color);
            color: white;
        }

        .modal-btn-primary:hover {
            background: #2980b9;
        }

        .modal-btn-danger {
            background: var(--bad);
            color: white;
        }

        .modal-btn-danger:hover {
            background: #c0392b;
        }

        .modal-btn-cancel {
            background: #eee;
            color: #555;
        }

        .modal-btn-cancel:hover {
            background: #ddd;
        }

        /* ================= Picker List ================= */
        .picker-list {
            max-height: 250px;
            overflow-y: auto;
            margin: 12px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            text-align: left;
        }

        .picker-item {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.15s;
            font-size: 0.9rem;
        }

        .picker-item:hover {
            background: #f0f7ff;
        }

        .picker-item.active {
            background: #e3f2fd;
            font-weight: bold;
        }

        .picker-item:last-child {
            border-bottom: none;
        }

        .picker-item .picker-meta {
            color: #999;
            font-size: 0.75rem;
            margin-left: auto;
        }

        .picker-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .picker-loading {
            padding: 30px;
            text-align: center;
            color: #999;
        }

        .picker-create-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .picker-create-row input {
            flex: 1;
            margin-bottom: 0;
        }
    </style>
</head>

<body>

    <!-- ================= Loading Overlay ================= -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-status" id="loading-status">â³ æ­£åœ¨å•Ÿå‹•ç³»çµ±...</div>
        <div class="loading-sub">è«‹ç¨å€™ï¼Œæˆ‘å€‘æ­£åœ¨ç‚ºæ‚¨æº–å‚™è³‡æ–™</div>
    </div>

    <!-- HTML Toast æç¤ºå®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ================= Generic Modal ================= -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <input type="text" id="modal-input" style="display:none;" placeholder="">
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <!-- éš±è—çš„æœ¬æ©Ÿæª”æ¡ˆ input -->
    <input type="file" id="local-file-input" accept=".json" style="display: none;"
        onchange="handleLocalFileImport(event)">

    <!-- ================= Conflict Modal (Generic / Dynamic Labels) ================= -->
    <div class="conflict-overlay" id="conflict-overlay">
        <div class="conflict-modal">
            <h2>âš ï¸ è³‡æ–™ç‰ˆæœ¬ä¸ä¸€è‡´</h2>
            <p class="conflict-subtitle" id="conflict-subtitle">
                åµæ¸¬åˆ°è³‡æ–™ç‰ˆæœ¬ä¸åŒï¼Œè«‹é¸æ“‡è¦ä½¿ç”¨å“ªä¸€å€‹ç‰ˆæœ¬ã€‚<br>
                ç³»çµ±æœƒä»¥æ‚¨é¸æ“‡çš„ç‰ˆæœ¬å»ºç«‹æ–°æª”æ¡ˆã€‚
            </p>
            <div class="conflict-compare">
                <div class="conflict-side local-side">
                    <h3 id="conflict-left-title">ğŸ“‚ ç‰ˆæœ¬ A</h3>
                    <div class="tree-preview" id="conflict-local-preview"></div>
                </div>
                <div class="conflict-side drive-side">
                    <h3 id="conflict-right-title">â˜ï¸ ç‰ˆæœ¬ B</h3>
                    <div class="tree-preview" id="conflict-drive-preview"></div>
                </div>
            </div>
            <div class="conflict-actions">
                <button class="btn-use-local" id="conflict-btn-left" onclick="resolveConflict('left')">ğŸ“‚ ä½¿ç”¨ç‰ˆæœ¬
                    A</button>
                <button class="btn-use-drive" id="conflict-btn-right" onclick="resolveConflict('right')">â˜ï¸ ä½¿ç”¨ç‰ˆæœ¬
                    B</button>
            </div>
            <p class="conflict-note">
                ğŸ’¡ æˆ‘å€‘ä¸æœƒåˆªé™¤æ‚¨çš„ä»»ä½•æª”æ¡ˆï¼Œæ‰€æœ‰èˆŠæª”æ¡ˆéƒ½ä¿ç•™åœ¨åŸè™•ï¼Œæ‚¨å¯è‡ªè¡Œç®¡ç†ã€‚
            </p>
        </div>
    </div>

    <!-- ================= TOS Blocking Overlay ================= -->
    <div id="tos-block-overlay" class="tos-block-overlay">
        <div class="tos-block-content">
            <h2 style="color: var(--bad);">âš ï¸ è«‹å…ˆåŒæ„æœå‹™æ¢æ¬¾</h2>
            <p>æ‚¨å¿…é ˆåŒæ„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ¬Šæ”¿ç­–æ‰èƒ½ç¹¼çºŒä½¿ç”¨æœ¬ç³»çµ±ã€‚</p>
            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 15px; align-items: center;">
                <a href="privacy.html" target="_blank"
                    style="color: var(--st-color); text-decoration: none; font-weight: bold; font-size: 1.1rem;">ğŸ“„
                    éš±ç§æ¬Šæ”¿ç­– (Privacy Policy)</a>
                <a href="tos.html" target="_blank"
                    style="color: var(--st-color); text-decoration: none; font-weight: bold; font-size: 1.1rem;">ğŸ“œ
                    æœå‹™æ¢æ¬¾ (Terms of Service)</a>
            </div>
            <p style="font-size: 0.95rem; color: #777; margin-top: 30px; line-height: 1.6;">
                ğŸ’¡ <b>ä¸‹ä¸€æ­¥ï¼š</b><br>
                è«‹é»æ“Šå³ä¸Šè§’çš„ã€Œâ˜°ã€é¸å–®ï¼Œ<br>
                å‹¾é¸ä¸¦åŒæ„æ¢æ¬¾ï¼Œå³å¯è§£é™¤é–å®šã€‚
            </p>
        </div>
    </div>

    <!-- ================= View 0: åˆå§‹ç•«é¢ ================= -->
    <div id="view-welcome" class="view">
        <!-- Welcome é é¢å³ä¸Šè§’ More Options -->
        <div class="welcome-top-bar">
            <div class="more-options-wrapper">
                <button class="btn-more" onclick="toggleMoreMenu('welcome-more-dropdown')" title="æ›´å¤šé¸é …">â˜°</button>
                <div class="more-dropdown" id="welcome-more-dropdown"></div>
            </div>
        </div>
        <div class="container">
            <div class="welcome-box">
                <h1 style="color: var(--st-color);">ğŸ§  å¤§è…¦é‡å¡‘ç³»çµ±</h1>

                <!-- Google ç™»å…¥å€ -->
                <div class="welcome-auth" id="welcome-auth-section" style="position: relative; z-index: 95;">
                    <div id="welcome-logged-out">
                        <div style="margin-bottom: 15px; text-align: center; font-size: 0.95rem;">
                            <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="tos-checkbox" style="width: 18px; height: 18px;"
                                    onchange="handleTosCheckboxChange(this.checked)">
                                <span>æˆ‘å·²é–±è®€ä¸¦åŒæ„ <a href="privacy.html" target="_blank"
                                        style="color: var(--st-color);">éš±ç§æ¬Šæ”¿ç­–</a> èˆ‡ <a href="tos.html" target="_blank"
                                        style="color: var(--st-color);">æœå‹™æ¢æ¬¾</a></span>
                            </label>
                        </div>
                        <p>â˜ï¸ ç™»å…¥ Google å¸³æˆ¶ä»¥åŒæ­¥è³‡æ–™åˆ° Google Drive</p>
                        <button class="btn-google" onclick="loginGoogle()">
                            <svg width="18" height="18" viewBox="0 0 48 48">
                                <path fill="#4285F4"
                                    d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                                <path fill="#34A853"
                                    d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                                <path fill="#FBBC05"
                                    d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
                                <path fill="#EA4335"
                                    d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                            </svg>
                            ä½¿ç”¨ Google ç™»å…¥
                        </button>
                    </div>
                    <div id="welcome-logged-in" style="display: none;">
                        <p>âœ… å·²ç™»å…¥ç‚º <strong id="welcome-user-name"></strong></p>
                        <button class="btn-drive" id="btn-welcome-picker" onclick="openDrivePicker()"
                            style="display: none;">ğŸ“‚ é¸æ“‡åŒæ­¥æª”æ¡ˆ</button>
                        <span id="welcome-file-status"></span>
                    </div>
                </div>

                <p style="font-size: 1.1rem; line-height: 1.6;">
                    ç³»çµ±å·²é è¼‰äº†ä¸€äº›çœŸå¯¦çš„äººé¡åº•å±¤éœ€æ±‚ï¼ˆå¦‚ï¼šç´“è§£å£“åŠ›ã€ç¤¾äº¤é€£çµï¼‰ã€‚<br>
                    åœ¨é–‹å•Ÿç„¡é‚Šç•Œç•«å¸ƒä¹‹å‰ï¼Œè«‹å…ˆè¼¸å…¥ <strong>ä½ æƒ³åˆ†æçš„ç¬¬ä¸€å€‹ç¿’æ…£</strong>ï¼
                </p>
                <div style="text-align: left; margin-top: 30px;">
                    <label style="font-weight: bold;">1. ä½ çœŸæ­£çš„ã€Œåº•å±¤éœ€æ±‚ (Base Demand)ã€æ˜¯ä»€éº¼ï¼Ÿ</label>
                    <input type="text" id="init-demand" placeholder="ä¾‹å¦‚ï¼šç„¡èŠæƒ³æ‰¾åˆºæ¿€ã€è‚šå­é¤“ã€ç²å¾—èªåŒ...">

                    <label style="margin-top: 20px; display: block; font-weight: bold;">2. ç‚ºäº†æ»¿è¶³é€™å€‹éœ€æ±‚ï¼Œä½ é€šå¸¸çš„ã€Œç¿’æ…£è¡Œå‹•
                        (Action)ã€æ˜¯ï¼Ÿ</label>
                    <input type="text" id="init-action" placeholder="ä¾‹å¦‚ï¼šæ»‘TikTokã€å–æ‰‹æ–é£²ã€å’¬æŒ‡ç”²...">
                </div>
                <button class="primary" onclick="initFirstAction()"
                    style="margin-top: 35px; width: 100%; font-size: 1.2rem; padding: 15px;">
                    ğŸš€ åˆå§‹åŒ–è³‡æ–™ä¸¦é–‹å§‹è¨­å®š
                </button>
                <div style="margin-top: 30px; text-align: center; font-size: 0.85rem;">
                    <a href="privacy.html" target="_blank"
                        style="color: #666; text-decoration: none; margin: 0 10px;">éš±ç§æ¬Šæ”¿ç­– (Privacy Policy)</a> |
                    <a href="tos.html" target="_blank" style="color: #666; text-decoration: none; margin: 0 10px;">æœå‹™æ¢æ¬¾
                        (Terms of Service)</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= View 1: ç„¡é‚Šç•Œç•«å¸ƒæ¨¹ç‹€åœ– ================= -->
    <div id="view-tree" class="view">
        <!-- å³ä¸Šè§’ Auth Bar -->
        <div class="auth-bar" id="tree-auth-bar">
            <!-- More Options æ”¾æœ€å·¦é‚Š(ç¬¬ä¸€å€‹) -->
            <div class="more-options-wrapper">
                <button class="btn-more" onclick="toggleMoreMenu('tree-more-dropdown')" title="æ›´å¤šé¸é …">â˜°</button>
                <div class="more-dropdown" id="tree-more-dropdown"></div>
            </div>
            <div id="tree-logged-out">
                <button class="btn-google" onclick="loginGoogle()" style="font-size: 0.85rem; padding: 8px 16px;">
                    ğŸ” ç™»å…¥
                </button>
            </div>
            <div id="tree-logged-in" style="display: none;">
                <div class="user-info">
                    <img class="user-avatar" id="tree-user-avatar" src="" alt="">
                    <span id="tree-user-name"></span>
                    <span class="sync-indicator" id="sync-dot" title="åŒæ­¥ç‹€æ…‹"></span>
                </div>
                <button class="btn-drive" id="btn-tree-picker" onclick="openDrivePicker()" style="display: none;">ğŸ“‚
                    é¸æ“‡æª”æ¡ˆ</button>
                <button class="btn-logout" onclick="logoutGoogle()">ç™»å‡º</button>
            </div>
        </div>

        <div class="canvas-ui-layer">
            <div style="position: relative;">
                <span id="info-toggle" onclick="toggleInfoPanel()"
                    style="cursor:pointer; position:absolute; left:-5px; top:2px; font-size:1rem; color:#999; user-select:none;">â–¼</span>
                <h2 style="margin: 0; color: var(--text-main); padding-left: 20px;">ğŸ§  å¤§è…¦è¡Œç‚ºæ±ºç­–æ¨¹</h2>
                <div id="info-panel" style="padding-left: 20px;">
                    <p
                        style="margin: 5px 0 0 0; color: var(--craving); font-size: 0.95rem; font-weight: bold; line-height: 1.8;">
                        æŒ‰ä½æ»‘é¼ æ‹–æ›³å¹³ç§»ç•«å¸ƒï¼Œä½¿ç”¨æ»¾è¼ªç¸®æ”¾ã€‚<br>
                        ğŸ‘‘ = é•·æœŸCPæœ€é«˜çš„è¡Œå‹•ï¼ˆç†æƒ³é¸æ“‡ï¼‰ã€‚<br>
                        <span style="color:var(--bad);">â– </span><span style="color:var(--good);">â– </span> è‰²ç·š =
                        å¤§è…¦é è¨­åŸ·è¡Œçš„çŸ­æœŸCPæœ€é«˜è¡Œå‹•<br>
                        <span style="font-size:0.85rem;">ï¼ˆç´…=é•·æœŸæœ‰å®³ï¼Œç¶ =é•·æœŸæœ‰ç›Šï¼‰</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- ç„¡é‚Šç•Œç•«å¸ƒå®¹å™¨ -->
        <div class="tree-canvas-container" id="tree-canvas">
            <div class="tree-zoom-layer" id="tree-zoom-layer">
                <div id="tree-render-area">
                    <!-- Javascript å‹•æ…‹æ¸²æŸ“ Real Tree -->
                </div>
            </div>
        </div>
    </div>

    <!-- ================= View 2: å››éšæ®µç·¨è¼¯å™¨ ================= -->
    <div id="view-editor" class="view">
        <div class="container">
            <div class="editor-header">
                <button id="btn-back-tree" onclick="goToTree()" style="background: var(--cue); margin-bottom: 20px;">â¬…ï¸
                    è¿”å›ç•«å¸ƒ</button>
                <h2 id="editor-title">åˆå§‹åŒ– / ç·¨è¼¯ç¿’æ…£</h2>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label style="font-weight: bold;">è¡Œå‹•åç¨± (Action):</label>
                        <input type="text" id="action-name" placeholder="ä¾‹å¦‚ï¼šæŠ½è¸ã€è·‘æ­¥ã€å–æ°´...">
                    </div>
                </div>
                <p style="color: #7f8c8d; font-size: 1rem; margin-top: 15px; line-height: 1.6;">
                    ğŸ’¡ ç¿’æ…£é¤Šæˆå–æ±ºæ–¼ 4 å€‹éšæ®µï¼š<strong>æç¤º â” æ¸´æœ› â” å›æ‡‰ â” çè³</strong>ã€‚<br>
                    ğŸ’¡ è«‹å°‡ CP å€¼ç‰©ä»¶æ‹–æ›³åˆ°å°æ‡‰éšæ®µ (é€™ä¸å½±éŸ¿ç¸½åˆ†ï¼Œä½†èƒ½å¹«åŠ©é‡æ¸…å•é¡Œ)ã€‚<br>
                    ğŸ’¡ <strong style="color: var(--bad);">ã€ç³»çµ±é˜²è­·æ©Ÿåˆ¶ã€‘ç¬¬äºŒæ¬¡æª¢è¦–æ™‚ï¼Œç³»çµ±å°‡å¼·åˆ¶è¦æ±‚ï¼šå¥½ç¿’æ…£çŸ­æœŸ CP > 0ï¼Œå£ç¿’æ…£çŸ­æœŸ CP < 0ï¼</strong>
                </p>
            </div>

            <div class="token-creator">
                <input type="text" id="cp-name" placeholder="CP è®Šæ•¸åç¨± (ä¾‹ï¼šçœ‹åˆ°ç”œé»ã€å¤šå·´èƒºåˆ†æ³Œ)" style="flex: 2; min-width: 250px;">
                <input type="number" id="cp-score" placeholder="åˆ†æ•¸ (+/-)" style="flex: 1; min-width: 120px;">
                <select id="cp-time" style="flex: 1; min-width: 180px;">
                    <option value="st">çŸ­æœŸ CP (Short-term)</option>
                    <option value="lt">é•·æœŸ CP (Long-term)</option>
                </select>
                <button class="primary" onclick="createCPToken()">â• å»ºç«‹ CP ç‰©ä»¶</button>
            </div>

            <div id="token-dock" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event, 'dock')"
                ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <span class="dock-hint" id="dock-hint-text">(å‰›å»ºç«‹ã€æœªåˆ†é¡çš„ CP ç‰©ä»¶æœƒæ”¾åœ¨é€™è£¡ï¼Œè«‹ç”¨æ»‘é¼ æ‹–æ›³åˆ°ä¸‹æ–¹å››éšæ®µä¸­)</span>
            </div>

            <div class="pipeline-container">
                <div class="stage-box" id="stage-cue">
                    <div style="color: var(--cue); font-weight: bold; text-align: center; font-size: 1.2rem;">1. æç¤º
                        (Cue)</div>
                    <div class="drop-zone" id="zone-cue" ondragover="allowDrop(event)" ondrop="drop(event, 'cue')"
                        ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
                <div class="stage-box" id="stage-craving">
                    <div style="color: var(--craving); font-weight: bold; text-align: center; font-size: 1.2rem;">2. æ¸´æœ›
                        (Craving)</div>
                    <div class="drop-zone" id="zone-craving" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'craving')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    </div>
                </div>
                <div class="stage-box" id="stage-response">
                    <div style="color: var(--response); font-weight: bold; text-align: center; font-size: 1.2rem;">3. å›æ‡‰
                        (Response)</div>
                    <div class="drop-zone" id="zone-response" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'response')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    </div>
                </div>
                <div class="stage-box" id="stage-reward">
                    <div style="color: var(--reward); font-weight: bold; text-align: center; font-size: 1.2rem;">4. çè³
                        (Reward)</div>
                    <div class="drop-zone" id="zone-reward" ondragover="allowDrop(event)" ondrop="drop(event, 'reward')"
                        ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
            </div>

            <div class="score-board">
                <div style="display:flex; align-items:center; justify-content:center; gap:40px; flex-wrap:wrap;">
                    <!-- çŸ­æœŸ -->
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:2.5rem;">âš¡</div>
                        <div style="color: var(--st-color); font-weight:bold; font-size:1.1rem;">çŸ­æœŸç¸½ CP</div>
                        <div style="font-size:1.8rem; font-weight:bold; color: var(--st-color);"><span
                                id="score-st">0</span></div>
                    </div>
                    <!-- å¤©å¹³ -->
                    <div style="font-size:3rem;">âš–ï¸</div>
                    <!-- é•·æœŸ -->
                    <div style="display:flex; flex-direction:column; align-items:center; position:relative;">
                        <div style="font-size:2.5rem;">ğŸŒ±</div>
                        <div style="color: var(--lt-color); font-weight:bold; font-size:1.1rem;">é•·æœŸç¸½ CP</div>
                        <div style="font-size:1.8rem; font-weight:bold; color: var(--lt-color);"><span
                                id="score-lt">0</span></div>
                        <div id="lt-multiplier-wrapper"
                            style="position:absolute; top:calc(100% + 5px); left:50%; transform:translateX(-50%);">
                            <span id="lt-multiplier"
                                style="background:#f0f0f0; padding:4px 10px; border-radius:8px; font-size:0.9rem; font-weight:bold; color:#666; cursor:pointer; border:1px solid #ddd; white-space:nowrap;"
                                onclick="openSleepSliderModal()">Ã— 0.1</span>
                        </div>
                    </div>
                    <!-- æœ€çµ‚è©•ä¼° -->
                    <div style="font-size:1.2rem; font-weight:bold;">
                        å¤§è…¦æœ€çµ‚è©•ä¼°ï¼š<span id="score-final" style="font-size:1.5rem;">0</span>
                    </div>
                </div>
            </div>

            <div id="alert-box" class="alert-box"></div>
            <button class="success" onclick="saveAction()"
                style="width: 100%; font-size: 1.3rem; padding: 20px; margin-top: 10px;">ğŸ’¾ å„²å­˜ä¸¦å¯«å…¥å¤§è…¦æ±ºç­–ç¶²è·¯</button>
        </div>
    </div>

    <script>
        // =========================================================================
        // TOS & Privacy Policy Logic
        // =========================================================================
        function getTosAccepted() {
            return localStorage.getItem('brain_tos_accepted') === 'true';
        }

        async function setTosAccepted(accepted) {
            localStorage.setItem('brain_tos_accepted', accepted ? 'true' : 'false');
            handleTosUI();

            // å¦‚æœå·²ç™»å…¥ï¼ŒåŒæ­¥åˆ°å¾Œç«¯
            if (currentUser) {
                try {
                    const res = await fetch(API_BASE + '/api/auth/me', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ tosAccepted: accepted })
                    });
                    if (!res.ok) throw new Error('åŒæ­¥ TOS ç‹€æ…‹å¤±æ•—');
                    showToast('âœ… å·²å°‡åŒæ„ç‹€æ…‹åŒæ­¥è‡³é›²ç«¯', 'success');
                } catch (err) {
                    console.error('TOS sync error:', err);
                    showToast('âš ï¸ ç„¡æ³•åŒæ­¥åŒæ„ç‹€æ…‹åˆ°é›²ç«¯', 'error');
                }
            }
        }

        function handleTosCheckboxChange(checked) {
            setTosAccepted(checked);
        }

        function handleTosUI() {
            const accepted = getTosAccepted();
            const overlay = document.getElementById('tos-block-overlay');
            const checkbox = document.getElementById('tos-checkbox');
            const welcomeView = document.getElementById('view-welcome');
            const isWelcomeVisible = welcomeView && welcomeView.style.display !== 'none';

            if (checkbox) checkbox.checked = accepted;

            // å¦‚æœå·²åŒæ„ï¼Œéš±è—é®ç½©
            if (accepted) {
                overlay.classList.remove('show');
                return;
            }

            // å¦‚æœæœªåŒæ„ï¼š
            // 1. å¦‚æœåœ¨ç•«å¸ƒé é¢ (Tree View)ï¼Œå¿…é ˆé¡¯ç¤ºé®ç½©
            // 2. å¦‚æœåœ¨ Welcome é é¢ä¸”å·²ç™»å…¥ï¼Œå¿…é ˆé¡¯ç¤ºé®ç½© (å¼·è¿«ç¢ºèª)
            // 3. å¦‚æœåœ¨ Welcome é é¢ä¸”æœªç™»å…¥ï¼Œä¸é¡¯ç¤ºé®ç½© (å› ç‚º Welcome é é¢è‡ªæœ‰ Checkboxï¼Œä¸”ç‚ºäº†ä¸æ“‹ä½ç™»å…¥æŒ‰éˆ•)
            if (!isWelcomeVisible || currentUser) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }

            const welcomeDropdown = document.getElementById('welcome-more-dropdown');
            const treeDropdown = document.getElementById('tree-more-dropdown');
            if (welcomeDropdown && welcomeDropdown.classList.contains('show')) buildMoreDropdown('welcome-more-dropdown');
            if (treeDropdown && treeDropdown.classList.contains('show')) buildMoreDropdown('tree-more-dropdown');
        }

        // =========================================================================
        // HTML æç¤ºç³»çµ± (å–ä»£ alert)
        // =========================================================================
        function showToast(message, type = 'warning') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let icon = type === 'error' ? 'ğŸš¨ ' : type === 'success' ? 'âœ… ' : 'ğŸ’¡ ';
            toast.className = `toast ${type}`;
            toast.innerHTML = icon + message + `<span class="toast-close" onclick="this.parentElement.remove()">âœ•</span>`;
            container.appendChild(toast);
        }

        // Reusable modal: replaces confirm() and prompt()
        // Usage:
        //   const ok = await showModal({ title, message, confirmText, cancelText })           â†’ returns true/false
        //   const val = await showModal({ title, message, inputPlaceholder, confirmText })    â†’ returns string/null
        //   await showModal({ title, message, buttons: [{text, className, value}] })          â†’ returns value
        function showModal(opts) {
            return new Promise(resolve => {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                const inputEl = document.getElementById('modal-input');
                const actionsEl = document.getElementById('modal-actions');

                titleEl.textContent = opts.title || '';
                msgEl.innerHTML = opts.message || '';

                // Input mode
                if (opts.inputPlaceholder !== undefined) {
                    inputEl.style.display = 'block';
                    inputEl.value = opts.inputDefault || '';
                    inputEl.placeholder = opts.inputPlaceholder;
                    setTimeout(() => inputEl.focus(), 100);
                } else {
                    inputEl.style.display = 'none';
                }

                function close(val) {
                    overlay.classList.remove('show');
                    resolve(val);
                }

                // Build buttons
                let btnsHTML = '';
                if (opts.buttons) {
                    opts.buttons.forEach((b, i) => {
                        btnsHTML += `<button class="${b.className || 'modal-btn-primary'}" id="modal-btn-${i}">${b.text}</button>`;
                    });
                } else {
                    const confirmText = opts.confirmText || 'ç¢ºå®š';
                    const cancelText = opts.cancelText || 'å–æ¶ˆ';
                    const confirmClass = opts.danger ? 'modal-btn-danger' : 'modal-btn-primary';
                    btnsHTML = `<button class="modal-btn-cancel" id="modal-btn-cancel">${cancelText}</button>`;
                    btnsHTML += `<button class="${confirmClass}" id="modal-btn-confirm">${confirmText}</button>`;
                }
                actionsEl.innerHTML = btnsHTML;

                // Bind events
                if (opts.buttons) {
                    opts.buttons.forEach((b, i) => {
                        document.getElementById(`modal-btn-${i}`).onclick = () => close(b.value);
                    });
                } else {
                    document.getElementById('modal-btn-cancel').onclick = () => {
                        close(opts.inputPlaceholder !== undefined ? null : false);
                    };
                    document.getElementById('modal-btn-confirm').onclick = () => {
                        close(opts.inputPlaceholder !== undefined ? inputEl.value : true);
                    };
                }

                // Enter key for input mode
                if (opts.inputPlaceholder !== undefined) {
                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') close(inputEl.value);
                    };
                }

                overlay.classList.add('show');
            });
        }

        // =========================================================================
        // ç„¡é‚Šç•Œç•«å¸ƒï¼šæ»‘é¼ ç¸®æ”¾èˆ‡å¹³ç§»é‚è¼¯
        // =========================================================================
        const canvas = document.getElementById('tree-canvas');
        const zoomLayer = document.getElementById('tree-zoom-layer');
        let scale = 1;
        let panX = 0, panY = 0;
        let isDragging = false;
        let startX, startY;

        // æ»‘é¼ æ»¾è¼ªï¼šå°æº–æ¸¸æ¨™ç¸®æ”¾
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSensitivity = 0.0015;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = scale * (1 + delta);
            newScale = Math.max(0.3, Math.min(newScale, 2.5)); // é™åˆ¶ç¸®æ”¾æ¯”ä¾‹

            // å–å¾—ç•«å¸ƒé‚Šç•Œï¼Œè¨ˆç®—æ»‘é¼ ç›¸å°ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // æ•¸å­¸è¨ˆç®—ï¼šç¢ºä¿ç¸®æ”¾çš„ä¸­å¿ƒé»æ˜¯æ»‘é¼ æ¸¸æ¨™çš„ä½ç½®
            panX = mouseX - (mouseX - panX) * (newScale / scale);
            panY = mouseY - (mouseY - panY) * (newScale / scale);
            scale = newScale;

            updateCanvasTransform();
        });

        // æ»‘é¼ æ‹–æ›³ï¼šå¹³ç§»
        canvas.addEventListener('mousedown', (e) => {
            // å¦‚æœé»æ“Šçš„æ˜¯ç¯€é»æœ¬èº«ï¼Œå‰‡ä¸è§¸ç™¼å¹³ç§» (è®“ click äº‹ä»¶ç”Ÿæ•ˆ)
            if (e.target.closest('.node-box')) return;
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            updateCanvasTransform();
        });

        window.addEventListener('mouseup', () => { isDragging = false; });

        function updateCanvasTransform() {
            zoomLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        }

        // å°‡è¦–è§’é‡ç½®ç½®ä¸­
        function resetCanvasView() {
            scale = 1; panX = 50; panY = 100; // é ç•™ä¸€é»ä¸Šå·¦é‚Šè·
            updateCanvasTransform();
        }

        // =========================================================================
        // ç³»çµ±ç‹€æ…‹èˆ‡è³‡æ–™åˆå§‹åŒ–
        // =========================================================================
        let humanTree = { name: "human", children: [] };
        let currentDemandId = null, currentActionId = null, currentTokens = [], draggedTokenId = null;
        let hasInitialized = false;

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        // å»ºç«‹çœŸå¯¦ä¸”æœ‰æ„ç¾©çš„é è¨­è³‡æ–™ï¼Œå–ä»£åŸæœ¬çš„ 1-10
        function buildDefaultPythonTree() {
            const defaultData = [
                {
                    demand: "ç´“è§£å·¥ä½œå£“åŠ›",
                    actions: [
                        { name: "æŠ½è¸", st: 15, lt: -80 },
                        { name: "åƒé«˜ç†±é‡å®µå¤œ", st: 10, lt: -40 },
                        { name: "æ·±å‘¼å¸èˆ‡å†¥æƒ³", st: 2, lt: 30 }
                    ]
                },
                {
                    demand: "ç²å¾—ç¤¾äº¤é€£çµèˆ‡èªåŒ",
                    actions: [
                        { name: "ç‹‚åˆ·çŸ­å½±éŸ³èˆ‡IG", st: 8, lt: -15 },
                        { name: "åƒåŠ å¯¦é«”ç¤¾ç¾¤èšæœƒ", st: 5, lt: 40 }
                    ]
                }
            ];

            defaultData.forEach((d, i) => {
                let demandNode = { id: 'demand_def_' + i, name: d.demand, actions: [] };
                d.actions.forEach((a, j) => {
                    let finalCp = a.st + (a.lt * 0.1);
                    demandNode.actions.push({
                        id: `action_def_${i}_${j}`, name: a.name, cp: finalCp, st: a.st, lt: a.lt, isNew: false, tokens: []
                    });
                });
                humanTree.children.push(demandNode);
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            // åˆ‡æ› Body çš„ Overflow é˜²æ­¢ç•«é¢éŒ¯ä½
            if (viewId === 'view-tree') { document.body.style.overflow = 'hidden'; }
            else { document.body.style.overflow = 'auto'; }
        }

        function initApp() {
            if (!hasInitialized) switchView('view-welcome');
            else {
                renderTree();
                switchView('view-tree');
                resetCanvasView();
                checkDailySleepPrompt(); // å•ä»Šå¤©æœ‰æ²’æœ‰ç†¬å¤œ
            }
            handleTosUI();
        }

        function initFirstAction() {
            if (!getTosAccepted()) return showToast("âš ï¸ è«‹å…ˆå‹¾é¸åŒæ„éš±ç§æ¬Šæ”¿ç­–èˆ‡æœå‹™æ¢æ¬¾ï¼", "error");

            let demandInput = document.getElementById('init-demand').value.trim();
            let actionInput = document.getElementById('init-action').value.trim();

            if (!demandInput || !actionInput) return showToast("è«‹å®Œæ•´å¡«å¯«éœ€æ±‚èˆ‡è¡Œå‹•ï¼", "error");

            buildDefaultPythonTree();

            let newDemandId = generateId(), newActionId = generateId();
            humanTree.children.unshift({
                id: newDemandId, name: demandInput, actions: [{ id: newActionId, name: actionInput, cp: 0, st: 0, lt: 0, isNew: true, tokens: [] }]
            });

            hasInitialized = true;
            document.getElementById('btn-back-tree').style.display = 'none';
            openEditor(newDemandId, newActionId);
        }

        async function addBaseDemand() {
            const name = await showModal({
                title: 'â• æ–°å¢åº•å±¤éœ€æ±‚',
                message: 'è«‹è¼¸å…¥æ–°çš„åº•å±¤éœ€æ±‚åç¨±',
                inputPlaceholder: 'ä¾‹å¦‚ï¼šé€ƒé¿ç¾å¯¦ã€å°‹æ±‚åˆºæ¿€',
                confirmText: 'æ–°å¢',
            });
            if (name && name.trim()) {
                humanTree.children.push({ id: generateId(), name: name.trim(), actions: [] });
                renderTree();
                syncToDrive('addBaseDemand');
            }
        }

        // =========================================================================
        // View 1: å¯¦é«”æ¨¹ç‹€åœ–æ¸²æŸ“é‚è¼¯ (ç„¡é‚Šç•Œç•«å¸ƒ)
        // =========================================================================
        async function deleteNode(demandId, actionId, event) {
            event.stopPropagation();
            let demand = humanTree.children.find(d => d.id === demandId);
            if (actionId) {
                let action = demand.actions.find(a => a.id === actionId);
                const ok = await showModal({
                    title: 'ğŸ—‘ï¸ åˆªé™¤è¡Œå‹•',
                    message: `ç¢ºå®šè¦åˆªé™¤è¡Œå‹•ã€Œ<strong>${action.name}</strong>ã€å—ï¼Ÿ`,
                    confirmText: 'åˆªé™¤',
                    danger: true,
                });
                if (ok) {
                    demand.actions = demand.actions.filter(a => a.id !== actionId);
                    renderTree();
                    showToast('è¡Œå‹•å·²åˆªé™¤', 'success');
                    syncToDrive('deleteNode');
                }
            } else {
                let childCount = demand.actions.length;
                let msg = `ç¢ºå®šè¦åˆªé™¤éœ€æ±‚ã€Œ<strong>${demand.name}</strong>ã€`;
                if (childCount > 0) msg += `åŠå…¶ä¸‹ <strong>${childCount}</strong> å€‹è¡Œå‹•æ–¹æ¡ˆ`;
                msg += 'å—ï¼Ÿ';
                const ok = await showModal({
                    title: 'ğŸ—‘ï¸ åˆªé™¤éœ€æ±‚',
                    message: msg,
                    confirmText: 'å…¨éƒ¨åˆªé™¤',
                    danger: true,
                });
                if (ok) {
                    humanTree.children = humanTree.children.filter(d => d.id !== demandId);
                    renderTree();
                    showToast('åº•å±¤éœ€æ±‚å·²åˆªé™¤', 'success');
                    syncToDrive('deleteNode');
                }
            }
        }

        function renderTree() {
            let renderArea = document.getElementById('tree-render-area');
            if (humanTree.children.length === 0) return renderArea.innerHTML = "<h2 style='color:#999;'>ç•«å¸ƒä¸Šç›®å‰ç©ºç„¡ä¸€ç‰©...</h2>";

            let html = `<ul class="tree"><li>
            <div class="node-box root-node has-children"><strong>Human (å¤§è…¦)</strong><br><small>é è¨­å°‹æ±‚é«˜æ€§åƒ¹æ¯”</small></div><ul>`;

            // Use the global multiplier for on-the-fly calculation
            const currentLtMultiplier = ltMultiplier;

            humanTree.children.forEach(demand => {
                // Calculate dynamic CP and sort
                demand.actions.forEach(a => {
                    a._dynamicCp = a.st + (a.lt * currentLtMultiplier);
                });
                demand.actions.sort((a, b) => b._dynamicCp - a._dynamicCp); // é™å†ªæ’åºï¼ˆé¡¯ç¤ºç”¨ï¼‰

                let hasActions = demand.actions.length > 0;

                // æ‰¾å‡ºé•·æœŸCPæœ€é«˜çš„ action (ç†æƒ³é¸æ“‡ ğŸ‘‘)
                let bestLtIdx = -1;
                if (hasActions) {
                    let maxLt = -Infinity;
                    demand.actions.forEach((a, i) => { if (a.lt > maxLt) { maxLt = a.lt; bestLtIdx = i; } });
                }

                // æ‰¾å‡ºçŸ­æœŸCPæœ€é«˜(é æœŸå¤§è…¦åŸ·è¡Œçš„) actionï¼Œä½†å› ç‚ºå·²ç¶“ä»¥ dynamicCp æ’åºï¼Œ
                // çŸ­æœŸCPæœ€é«˜çš„ä¹Ÿå¯èƒ½éš¨ multiplier æ”¹è®Šã€‚é€™è£¡ç¶­æŒæ‰¾ st æœ€é«˜è€…ç‚ºå¤§è…¦é è¨­ã€‚
                let bestStIdx = -1;
                if (hasActions) {
                    let maxSt = -Infinity;
                    demand.actions.forEach((a, i) => { if (a.st > maxSt) { maxSt = a.st; bestStIdx = i; } });
                }

                html += `<li><div class="node-box demand-node ${hasActions ? "has-children" : ""}">
                        <span class="node-delete-x" onclick="deleteNode('${demand.id}', null, event)">âœ•</span>
                        <strong>Demand: <br>${demand.name}</strong>
                     </div><ul>`;

                const totalItems = demand.actions.length + 1; // actions + add button
                const midIdx = (totalItems - 1) / 2; // Exact vertical center of the <ul> where parent line connects

                demand.actions.forEach((act, j) => {
                    let cpColor = act._dynamicCp >= 0 ? 'var(--good)' : 'var(--bad)';
                    let ltClass = act.lt < 0 ? 'lt-negative' : (act.lt > 0 ? 'lt-positive' : '');
                    const isCrown = (j === bestLtIdx);
                    const isStDefault = (j === bestStIdx);
                    const stColor = bestStIdx >= 0 ? (demand.actions[bestStIdx].lt <= 0 ? 'red' : 'green') : '';
                    const stLineClass = isStDefault ? `st-default-line-${stColor}` : '';

                    const y1 = Math.min(midIdx, bestStIdx);
                    const y2 = Math.max(midIdx, bestStIdx);

                    const overlapStart = Math.max(j - 0.5, y1);
                    const overlapEnd = Math.min(j + 0.5, y2);
                    const inStPath = (overlapStart < overlapEnd && bestStIdx >= 0);

                    let overlayClass = '';
                    if (inStPath) {
                        overlayClass = stColor;
                        if (overlapStart > j - 0.5) overlayClass += ' start'; // Crop top half (start from middle down)
                        if (overlapEnd < j + 0.5) overlayClass += ' end';     // Crop bottom half (start from middle up)
                    }

                    const isBoth = isCrown && isStDefault;
                    const bestClass = isBoth ? 'best-action-label up' : 'best-action-label';
                    const stLabelBad = isStDefault && demand.actions[bestStIdx].lt <= 0;
                    const stClass = isBoth ? `st-default-label down ${stLabelBad ? 'bad' : 'good'}` : `st-default-label ${stLabelBad ? 'bad' : 'good'}`;

                    html += `<li class="${stLineClass}">`;
                    if (inStPath) html += `<div class="st-vert-overlay ${overlayClass}"></div>`;
                    html += `<div class="node-box action-node ${ltClass}" onclick="openEditor('${demand.id}', '${act.id}')">
                                <span class="node-delete-x" onclick="deleteNode('${demand.id}', '${act.id}', event)">âœ•</span>
                                ${isCrown ? `<div class="cp-crown">ğŸ‘‘</div><div class="${bestClass}">é•·æœŸæœ€ä½³è§£ â¡</div>` : ''}
                                ${isStDefault ? `<div class="${stClass}">å¤§è…¦é è¨­ â¡</div>` : ''}
                                <strong>${act.name}</strong><div class="action-cp-text" style="color: ${cpColor};">ç•¶ä¸‹é«”æ„Ÿ CP: ${act._dynamicCp.toFixed(2)}</div>
                            </div></li>`;
                });

                // Also check if the 'Add Action' button itself is part of the colored path
                const addBtnIdx = demand.actions.length;
                const y1 = Math.min(midIdx, bestStIdx);
                const y2 = Math.max(midIdx, bestStIdx);
                const overlapStartAdd = Math.max(addBtnIdx - 0.5, y1);
                const overlapEndAdd = Math.min(addBtnIdx + 0.5, y2);
                const inStPathAddBtn = (overlapStartAdd < overlapEndAdd && bestStIdx >= 0);

                let addBtnOverlay = '';
                if (inStPathAddBtn) {
                    const stColor = demand.actions[bestStIdx].lt <= 0 ? 'red' : 'green';
                    let overlayClass = stColor;
                    if (overlapStartAdd > addBtnIdx - 0.5) overlayClass += ' start';
                    if (overlapEndAdd < addBtnIdx + 0.5) overlayClass += ' end';
                    addBtnOverlay = `<div class="st-vert-overlay ${overlayClass}"></div>`;
                }

                html += `<li>${addBtnOverlay}<div class="node-box add-node" onclick="openEditor('${demand.id}', null)">â• æ–°å¢è¡Œå‹•æ–¹æ¡ˆ</div></li></ul></li>`;
            });
            html += `<li><div class="node-box add-node" onclick="addBaseDemand()">â• æ–°å¢åº•å±¤éœ€æ±‚</div></li></ul></li></ul>`;
            renderArea.innerHTML = html;
        }

        // =========================================================================
        // View 2: å››éšæ®µç·¨è¼¯å™¨ (init_action_of_base_demand)
        // =========================================================================
        function openEditor(dId, aId) {
            currentDemandId = dId; currentActionId = aId; currentTokens = [];
            document.getElementById('alert-box').style.display = 'none';
            if (hasInitialized) document.getElementById('btn-back-tree').style.display = 'inline-block';

            ['zone-cue', 'zone-craving', 'zone-response', 'zone-reward', 'token-dock'].forEach(id => {
                Array.from(document.getElementById(id).children).forEach(c => { if (c.classList.contains('cp-token')) c.remove(); });
            });
            checkDockHint();

            if (aId !== null) {
                let action = humanTree.children.find(d => d.id === dId).actions.find(a => a.id === aId);
                document.getElementById('editor-title').innerText = `ç·¨è¼¯ç¿’æ…£ï¼š${action.name}`;
                document.getElementById('action-name').value = action.name;
                currentTokens = JSON.parse(JSON.stringify(action.tokens));
                currentTokens.forEach(t => renderToken(t));
            } else {
                document.getElementById('editor-title').innerText = `ç‚ºæ­¤éœ€æ±‚å»ºç«‹æ–°ç¿’æ…£`;
                document.getElementById('action-name').value = '';
            }
            updateScores();
            switchView('view-editor');
        }

        function goToTree() { initApp(); }

        function createCPToken() {
            let nameInput = document.getElementById('cp-name').value.trim();
            let scoreInput = parseFloat(document.getElementById('cp-score').value);
            if (!nameInput || isNaN(scoreInput)) return showToast("è«‹å¡«å¯«å®Œæ•´çš„åç¨±èˆ‡åˆ†æ•¸ï¼", "error");

            let newToken = { id: 'token_' + generateId(), name: nameInput, score: scoreInput, timeType: document.getElementById('cp-time').value, stage: 'dock' };
            currentTokens.push(newToken);
            renderToken(newToken);

            document.getElementById('cp-name').value = ''; document.getElementById('cp-score').value = '';
            updateScores();
        }

        function renderToken(token) {
            let el = document.createElement('div');
            el.className = `cp-token ${token.timeType === 'st' ? 'st-token' : 'lt-token'}`;
            el.id = token.id; el.draggable = true;
            el.innerHTML = `<span>${token.name} (${token.score > 0 ? '+' + token.score : token.score})</span><span class="token-del" onclick="deleteToken('${token.id}')">âœ–</span>`;

            el.addEventListener('dragstart', () => { draggedTokenId = token.id; setTimeout(() => el.style.opacity = '0.5', 0); });
            el.addEventListener('dragend', () => el.style.opacity = '1');

            document.getElementById(token.stage === 'dock' ? 'token-dock' : `zone-${token.stage}`).appendChild(el);
            checkDockHint();
        }

        function deleteToken(tokenId) {
            currentTokens = currentTokens.filter(t => t.id !== tokenId);
            document.getElementById(tokenId).remove();
            updateScores();
            checkDockHint();
        }

        function checkDockHint() {
            let dock = document.getElementById('token-dock');
            let hint = document.getElementById('dock-hint-text');
            // å¦‚æœ dock è£¡é¢é™¤äº† hint é‚„æœ‰å…¶ä»– tokenï¼Œå°±éš±è— hint
            if (dock.querySelectorAll('.cp-token').length > 0) hint.style.display = 'none';
            else hint.style.display = 'block';
        }

        function allowDrop(ev) { ev.preventDefault(); }
        function dragEnter(ev) { ev.currentTarget.classList.add('dragover'); }
        function dragLeave(ev) { ev.currentTarget.classList.remove('dragover'); }

        function drop(ev, targetStage) {
            ev.preventDefault(); ev.currentTarget.classList.remove('dragover');
            if (draggedTokenId !== null) {
                ev.currentTarget.appendChild(document.getElementById(draggedTokenId));
                let tokenData = currentTokens.find(t => t.id === draggedTokenId);
                if (tokenData) tokenData.stage = targetStage;
                draggedTokenId = null;
                checkDockHint();
            }
        }

        let ltMultiplier = parseFloat(localStorage.getItem('brain_lt_multiplier')) || 0.1;

        // Initialize display value on load
        document.addEventListener('DOMContentLoaded', () => {
            const m = parseFloat(localStorage.getItem('brain_lt_multiplier')) || 0.1;
            document.getElementById('lt-multiplier').textContent = `Ã— ${m}`;
            handleTosUI();
        });

        function toggleInfoPanel() {
            const panel = document.getElementById('info-panel');
            const toggle = document.getElementById('info-toggle');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                panel.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        async function openSleepSliderModal() {
            // Reusable modal with exact HTML for slider
            const html = `
                <div style="text-align:center; padding-top: 10px;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">æœ€è¿‘ 7 å¤©ï¼Œä½ ç¡æœ€å°‘çš„é‚£å¤©ç¡äº†å¹¾å€‹å°æ™‚ï¼Ÿ</p>
                    <input type="range" id="modal-sleep-range" min="0" max="14" step="0.5" value="7" oninput="document.getElementById('modal-sleep-val').innerText = this.value + ' å°æ™‚'" style="width: 80%; cursor: pointer;">
                    <p id="modal-sleep-val" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 15px 0;">7 å°æ™‚</p>
                </div>
            `;
            const hoursStr = await showModal({
                title: 'ğŸŒ™ æ¯æ—¥ç¡çœ ç‹€æ…‹ç¢ºèª',
                message: html,
                confirmText: 'ç¢ºå®š',
                cancelText: 'å–æ¶ˆ'
            });

            if (hoursStr) {
                // Determine hours from the DOM (since modal resolves when clicking enter/confirm)
                // Unfortunately showModal only resolves `true` or `inputEl.value`. We can read the DOM before it closes, 
                // but the cleanest way is just to grab it by ID if it's still there. Actually `showModal` hides the overlay when done but elements remain until overwritten.
            }
            // To make this robust, we should create a custom implementation or extract value.
        }

        async function checkDailySleepPrompt() {
            const today = new Date().toISOString().slice(0, 10);
            const lastSleepDate = localStorage.getItem('brain_sleep_date');

            if (lastSleepDate !== today) {
                await doSleepSliderFlow();
                localStorage.setItem('brain_sleep_date', today);
            }
        }

        async function doSleepSliderFlow() {
            const html = `
                <div style="text-align:center; padding-top: 10px;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">æœ€è¿‘ 7 å¤©ï¼Œä½ ç¡æœ€å°‘çš„é‚£å¤©ç¡äº†å¹¾å€‹å°æ™‚ï¼Ÿ</p>
                    <input type="range" id="modal-sleep-range" min="0" max="14" step="0.5" value="7" oninput="document.getElementById('modal-sleep-val').innerText = this.value + ' å°æ™‚'" style="width: 80%; cursor: pointer;">
                    <p id="modal-sleep-val" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 15px 0;">7 å°æ™‚</p>
                </div>
            `;
            const ok = await showModal({
                title: 'ğŸŒ™ æ¯æ—¥ç¡çœ ç‹€æ…‹ç¢ºèª',
                message: html,
                buttons: [
                    { text: 'ğŸ˜´ ç¢ºå¯¦æœ‰ç†¬å¤œ (Yes)', className: 'modal-btn-danger', value: 'yes' },
                    { text: 'ğŸ˜Š æ²’æœ‰ç†¬å¤œ (No)', className: 'modal-btn-primary', value: 'no' }
                ]
            });

            if (ok) {
                const hours = parseFloat(document.getElementById('modal-sleep-range').value);
                setSleepFromHours(hours, ok);
            }
        }

        // We override openSleepSliderModal to reuse doSleepSliderFlow
        function openSleepSliderModal() {
            doSleepSliderFlow();
        }

        function setSleepFromHours(hours, choice) {
            const isStayedUp = (choice === 'yes') || (hours < 6);
            ltMultiplier = isStayedUp ? 0.01 : 0.2;
            localStorage.setItem('brain_lt_multiplier', ltMultiplier.toString());

            const multEl = document.getElementById('lt-multiplier');
            if (multEl) multEl.textContent = `Ã— ${ltMultiplier}`;

            updateScores();
            if (document.getElementById('view-tree').classList.contains('active')) {
                renderTree(); // refresh canvas if we are viewing it
            }

            let msg = '';
            let toastType = 'success';
            if (isStayedUp) {
                toastType = 'error';
                if (choice === 'yes') {
                    msg = 'ğŸ˜´ ç†¬å¤œæ¨¡å¼ï¼šä½ è¡¨ç¤ºæœ‰ç†¬å¤œã€‚å¤§è…¦åˆ¤æ–·åŠ›ä¸‹é™ï¼Œé•·æœŸCPå½±éŸ¿åŠ›é™è‡³æœ€ä½ (Ã— 0.01)';
                } else {
                    msg = `ğŸ˜´ ç†¬å¤œæ¨¡å¼ï¼šç¡çœ æ™‚æ•¸ä¸è¶³ (${hours} å°æ™‚ < 6 å°æ™‚)ã€‚å¤§è…¦åˆ¤æ–·åŠ›ä¸‹é™ï¼Œé•·æœŸCPå½±éŸ¿åŠ›é™è‡³æœ€ä½ (Ã— 0.01)`;
                }
            } else {
                msg = 'ğŸ˜Š ç²¾ç¥é£½æ»¿ï¼šå¤§è…¦ç´€å¾‹ç¶­æŒï¼Œé•·æœŸCPå½±éŸ¿åŠ›æå‡ (Ã— 0.2)';
            }
            showToast(msg, toastType);
        }

        function updateScores() {
            let stSum = currentTokens.filter(t => t.timeType === 'st').reduce((sum, t) => sum + t.score, 0);
            let ltSum = currentTokens.filter(t => t.timeType === 'lt').reduce((sum, t) => sum + t.score, 0);
            let finalCp = stSum + (ltSum * ltMultiplier);

            document.getElementById('score-st').innerText = stSum;
            document.getElementById('score-lt').innerText = ltSum;
            document.getElementById('score-final').innerText = finalCp.toFixed(2);
            return { st: stSum, lt: ltSum, final: finalCp };
        }

        // =========================================================================
        // å„²å­˜èˆ‡å¼·åˆ¶é˜²è­·é‚è¼¯ (ç¬¬äºŒæ¬¡ç·¨è¼¯æ™‚å¼·è¡Œæ ¡æ­£)
        // =========================================================================
        function saveAction() {
            let actionNameInput = document.getElementById('action-name').value.trim();
            if (!actionNameInput) return showToast("è«‹å¡«å¯«è¡Œå‹•åç¨±ï¼", "error");

            let scores = updateScores();
            let demand = humanTree.children.find(d => d.id === currentDemandId);
            let isGoodHabit = (scores.lt >= 0);

            let existingAction = currentActionId !== null ? demand.actions.find(a => a.id === currentActionId) : null;
            let isNewAction = existingAction !== null ? existingAction.isNew : true;
            let alertBox = document.getElementById('alert-box');

            // ç¬¬äºŒæ¬¡çœ‹è¦‹ -> å¼·åˆ¶é˜²è­·æ©Ÿåˆ¶ (HTML æ¡†æ¡†å‘ˆç¾)
            if (!isNewAction) {
                if (isGoodHabit && scores.st <= 0) {
                    alertBox.className = 'alert-box';
                    alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±é˜²è­·æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå¥½ç¿’æ…£ (é•·æœŸ >= 0)ã€ï¼<br>
                ä½ çš„çŸ­æœŸ CP ç›®å‰æ˜¯ ${scores.st}ã€‚<br>
                å¤§è…¦æ˜¯çŸ­è¦–çš„ï¼Œå¦‚æœçŸ­æœŸç—›è‹¦æ²’æœ‰çå‹µï¼Œå¤§è…¦å°±æœƒæ”¾æ£„ï¼<br>
                ğŸ‘‰ <b>è«‹å¼·åˆ¶åŠ å…¥ã€ŒçŸ­æœŸçš„æ­£é¢ CP (çè³)ã€ï¼Œè®“çŸ­æœŸ CP > 0ï¼</b>`;
                    alertBox.style.display = 'block';
                    return;
                } else if (!isGoodHabit && scores.st >= 0) {
                    alertBox.className = 'alert-box';
                    alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±é˜²è­·æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå£ç¿’æ…£ (é•·æœŸ < 0)ã€ï¼<br>
                ä½ çš„çŸ­æœŸ CP ç›®å‰æ˜¯ ${scores.st}ã€‚<br>
                åªè¦çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ï¼Œä½ çš„å¤§è…¦å°±æœƒè¦ºå¾—æ€§åƒ¹æ¯”å¾ˆé«˜è€Œç¹¼çºŒåšï¼<br>
                ğŸ‘‰ <b>è«‹å¼·åˆ¶åŠ å…¥ã€ŒçŸ­æœŸçš„è² é¢ CP (æ‘©æ“¦åŠ›/æ‡²ç½°)ã€ï¼Œè®“çŸ­æœŸ CP < 0ï¼</b>`;
                    alertBox.style.display = 'block';
                    return;
                }
            } else {
                // ç¬¬ä¸€æ¬¡ -> Toast æé†’ä½†ä¸é˜»æ“‹
                if (isGoodHabit && scores.st <= 0) {
                    showToast("ã€ç³»çµ±æç¤ºã€‘ä½ æ­£åœ¨å»ºç«‹å¥½ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP å°šæœªå¤§æ–¼ 0ã€‚å¤§è…¦å¾ˆå®¹æ˜“æ”¾æ£„å–”ï¼(ä¸‹æ¬¡ç·¨è¼¯å°‡å¼·åˆ¶ä¿®æ­£)", "warning");
                } else if (!isGoodHabit && scores.st >= 0) {
                    showToast("ã€ç³»çµ±æç¤ºã€‘ä½ æ­£åœ¨ç´€éŒ„å£ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ã€‚å¤§è…¦é‚„æ˜¯æœƒç¹¼çºŒé€™å€‹è¿´è·¯ï¼(ä¸‹æ¬¡ç·¨è¼¯å°‡å¼·åˆ¶ä¿®æ­£)", "warning");
                }
            }

            alertBox.style.display = 'none';

            if (existingAction !== null) {
                existingAction.name = actionNameInput; existingAction.st = scores.st; existingAction.lt = scores.lt;
                existingAction.cp = scores.final; existingAction.tokens = currentTokens; existingAction.isNew = false;
            } else {
                demand.actions.push({ id: generateId(), name: actionNameInput, st: scores.st, lt: scores.lt, cp: scores.final, tokens: currentTokens, isNew: false });
            }

            showToast("å·²æˆåŠŸå¯«å…¥å¤§è…¦æ±ºç­–ç¶²è·¯ï¼", "success");
            syncToDrive('saveAction');
            initApp();
        }

        // =========================================================================
        // Storage Mode & Local Persistence
        // =========================================================================
        const STORAGE_KEY_TREE = 'brain_tree_data';
        const STORAGE_KEY_MODE = 'brain_storage_mode';
        const STORAGE_KEY_INIT = 'brain_has_initialized';
        const STORAGE_KEY_SAVE_DATE = 'brain_last_save_date';

        // Loading overlay helpers
        function updateLoadingStatus(text) {
            const el = document.getElementById('loading-status');
            if (el) el.textContent = text;
        }
        function hideLoadingOverlay() {
            const el = document.getElementById('loading-overlay');
            if (el) { el.classList.add('hidden'); setTimeout(() => el.remove(), 500); }
        }
        function isFirstTimeUser() {
            return !localStorage.getItem(STORAGE_KEY_MODE)
                && !localStorage.getItem(STORAGE_KEY_TREE)
                && !localStorage.getItem('brain_session_token');
        }

        // Storage mode: 'local' | 'drive' | 'both'
        // Default: 'local' (no login) or 'both' (logged in)
        function getStorageMode() {
            return localStorage.getItem(STORAGE_KEY_MODE) || 'local';
        }
        function setStorageMode(mode) {
            localStorage.setItem(STORAGE_KEY_MODE, mode);
            updateMoreDropdowns();
        }

        // Save humanTree to localStorage
        function saveToLocal() {
            try {
                const data = JSON.stringify({
                    humanTree: serializeTreeForSync(),
                    hasInitialized,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem(STORAGE_KEY_TREE, data);
                localStorage.setItem(STORAGE_KEY_INIT, hasInitialized ? '1' : '0');
            } catch (e) {
                showToast('âš ï¸ æœ¬æ©Ÿå„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹æ¸…ç†ç€è¦½å™¨è³‡æ–™', 'error');
            }
        }

        // Load humanTree from localStorage
        function loadFromLocal() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_TREE);
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (data && data.humanTree) return data.humanTree;
            } catch (e) { /* ignore parse errors */ }
            return null;
        }

        // Restore humanTree from a serialized tree object
        function restoreTreeFromSerialized(saved) {
            if (!saved || !saved.children || saved.children.length === 0) return false;
            const stageNames = ['dock', 'cue', 'craving', 'response', 'reward'];
            humanTree = {
                name: saved.name || 'human',
                children: saved.children.map(demand => ({
                    id: demand.id,
                    name: demand.name,
                    actions: (demand.actions || []).map(action => {
                        const tokens = [];
                        if (action.tokenSlots) {
                            action.tokenSlots.forEach((slot, idx) => {
                                (slot || []).forEach(t => {
                                    tokens.push({
                                        id: t.id, name: t.name, score: t.score,
                                        timeType: t.timeType, stage: stageNames[idx] || 'dock',
                                    });
                                });
                            });
                        } else if (action.tokens) {
                            action.tokens.forEach(t => tokens.push({ ...t }));
                        }
                        return {
                            id: action.id, name: action.name, cp: action.cp,
                            st: action.st, lt: action.lt, isNew: action.isNew, tokens,
                        };
                    }),
                })),
            };
            hasInitialized = true;
            return true;
        }

        // =========================================================================
        // Google Auth + Drive Sync (Token-based for cross-domain)
        // =========================================================================
        const API_BASE = 'https://addiction-murex.vercel.app';
        let currentUser = null;

        // Capture token from URL after OAuth callback
        (function captureTokenFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                localStorage.setItem('brain_session_token', token);
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        })();

        function authHeaders() {
            const token = localStorage.getItem('brain_session_token');
            const headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            return headers;
        }

        function loginGoogle() {
            window.location.href = API_BASE + '/api/auth/google';
        }

        async function logoutGoogle() {
            await fetch(API_BASE + '/api/auth/logout', {
                method: 'POST', headers: authHeaders(),
            });
            localStorage.removeItem('brain_session_token');
            currentUser = null;
            setStorageMode('local');
            updateAuthUI();
            showToast('å·²ç™»å‡º', 'success');
        }

        async function checkAuth() {
            updateLoadingStatus('â³ æ­£åœ¨æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
            const token = localStorage.getItem('brain_session_token');

            // ===== First-time user: hide overlay and let welcome page handle =====
            if (isFirstTimeUser()) {
                hideLoadingOverlay();
                updateAuthUI();
                updateMoreDropdowns();
                return;
            }

            // ===== No token: use local only =====
            if (!token) {
                currentUser = null;
                if (!localStorage.getItem(STORAGE_KEY_MODE)) setStorageMode('local');
                updateLoadingStatus('ğŸ“‚ æ­£åœ¨è¼‰å…¥æœ¬æ©Ÿè³‡æ–™...');
                const localTree = loadFromLocal();
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('ğŸ“‚ å·²å¾æœ¬æ©Ÿè¼‰å…¥è³‡æ–™', 'success');
                }
                updateAuthUI();
                updateMoreDropdowns();
                hideLoadingOverlay();
                return;
            }

            // ===== Has token: try to authenticate =====
            updateLoadingStatus('ğŸ” æ­£åœ¨é©—è­‰ç™»å…¥èº«åˆ†...');
            try {
                const res = await fetch(API_BASE + '/api/auth/me', { headers: authHeaders() });
                const data = await res.json();
                if (data.loggedIn) {
                    currentUser = data.user;
                    // åŒæ­¥ TOS ç‹€æ…‹
                    const localAccepted = getTosAccepted();
                    if (currentUser.tosAccepted) {
                        // DB èªªå¥½ -> æœ¬åœ°ä¹Ÿè¨­ç‚ºå¥½
                        if (!localAccepted) {
                            localStorage.setItem('brain_tos_accepted', 'true');
                        }
                    } else if (localAccepted) {
                        // æœ¬åœ°èªªå¥½ä½† DB èªªä¸ (å¯èƒ½æ˜¯å‰›ç™»å…¥çš„æ–°ä½¿ç”¨è€…åœ¨ Welcome é å‹¾é¸äº†) -> åŒæ­¥å› DB
                        setTosAccepted(true);
                    }

                    const savedMode = localStorage.getItem(STORAGE_KEY_MODE);
                    if (!savedMode || savedMode === 'local') {
                        setStorageMode('both');
                    }
                } else {
                    currentUser = null;
                }
            } catch (err) {
                currentUser = null;
            }

            updateAuthUI();
            updateMoreDropdowns();
            handleTosUI(); // ç¢ºä¿ UI ç‹€æ…‹æ­£ç¢ºåæ˜ æœ€çµ‚åŒæ­¥çµæœ

            // ===== Load data based on mode =====
            const mode = getStorageMode();
            updateLoadingStatus('ğŸ“‚ æ­£åœ¨è¼‰å…¥æœ¬æ©Ÿè³‡æ–™...');
            const localTree = loadFromLocal();
            let driveTree = null;

            // Try to load Drive data if logged in and has file
            if (currentUser && currentUser.hasDriveFile && mode !== 'local') {
                updateLoadingStatus('â˜ï¸ æ­£åœ¨è¼‰å…¥é›²ç«¯è³‡æ–™...');
                try {
                    const res = await fetch(API_BASE + '/api/load-from-drive', { headers: authHeaders() });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.data && data.data.treeData) {
                            driveTree = data.data.treeData;
                        }
                    }
                } catch (err) { /* ignore */ }
            }

            updateLoadingStatus('ğŸ”„ æ­£åœ¨æ¯”å°è³‡æ–™...');

            if (mode === 'local') {
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('ğŸ“‚ å·²å¾æœ¬æ©Ÿè¼‰å…¥è³‡æ–™', 'success');
                }
            } else if (mode === 'drive') {
                if (driveTree) {
                    restoreTreeFromSerialized(driveTree);
                    saveToLocal();
                    initApp();
                    showToast('â˜ï¸ å·²å¾ Google Drive è¼‰å…¥è³‡æ–™', 'success');
                } else if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('ğŸ“‚ é›²ç«¯è³‡æ–™ä¸å¯ç”¨ï¼Œå·²å¾æœ¬æ©Ÿè¼‰å…¥', 'success');
                }
            } else {
                // mode === 'both' â†’ compare local and Drive
                if (localTree && driveTree) {
                    const localStr = JSON.stringify(localTree);
                    const driveStr = JSON.stringify(driveTree);
                    if (localStr !== driveStr) {
                        hideLoadingOverlay();
                        showConflictDialog(localTree, driveTree, 'ğŸ“‚ æœ¬æ©Ÿç‰ˆæœ¬', 'â˜ï¸ Google Drive ç‰ˆæœ¬', 'auto');
                        return;
                    }
                }
                // Same or only one exists
                if (driveTree) {
                    restoreTreeFromSerialized(driveTree);
                    saveToLocal();
                    initApp();
                    showToast('â˜ï¸ å·²å¾ Google Drive è¼‰å…¥è³‡æ–™', 'success');
                } else if (localTree) {
                    restoreTreeFromSerialized(localTree);
                    initApp();
                    showToast('ğŸ“‚ å·²å¾æœ¬æ©Ÿè¼‰å…¥è³‡æ–™', 'success');
                }
            }

            // If logged in but no Drive file
            if (!hasInitialized && currentUser && !currentUser.hasDriveFile) {
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('ğŸ“‚ å·²å¾æœ¬æ©Ÿè¼‰å…¥è³‡æ–™', 'success');
                }
            }

            hideLoadingOverlay();
        }

        function updateAuthUI() {
            // Welcome page
            const wLoggedOut = document.getElementById('welcome-logged-out');
            const wLoggedIn = document.getElementById('welcome-logged-in');
            const wUserName = document.getElementById('welcome-user-name');
            const wFileStatus = document.getElementById('welcome-file-status');
            const wPicker = document.getElementById('btn-welcome-picker');

            // Tree page
            const tLoggedOut = document.getElementById('tree-logged-out');
            const tLoggedIn = document.getElementById('tree-logged-in');
            const tUserName = document.getElementById('tree-user-name');
            const tAvatar = document.getElementById('tree-user-avatar');
            const tPicker = document.getElementById('btn-tree-picker');

            if (currentUser) {
                wLoggedOut.style.display = 'none';
                wLoggedIn.style.display = 'block';
                wUserName.textContent = currentUser.name;
                if (currentUser.hasDriveFile) {
                    wFileStatus.textContent = 'ğŸ“ å·²è¨­å®šåŒæ­¥æª”æ¡ˆ';
                    wPicker.style.display = 'inline-block';
                    wPicker.textContent = 'ğŸ“‚ æ›´æ›åŒæ­¥æª”æ¡ˆ';
                } else {
                    wFileStatus.textContent = '';
                    wPicker.style.display = 'inline-block';
                    wPicker.textContent = 'ğŸ“‚ é¸æ“‡åŒæ­¥æª”æ¡ˆ';
                }
                tLoggedOut.style.display = 'none';
                tLoggedIn.style.display = 'flex';
                tUserName.textContent = currentUser.name;
                tAvatar.src = currentUser.picture || '';
                tAvatar.style.display = currentUser.picture ? 'block' : 'none';
                tPicker.style.display = currentUser.hasDriveFile ? 'none' : 'inline-block';
            } else {
                wLoggedOut.style.display = 'block';
                wLoggedIn.style.display = 'none';
                tLoggedOut.style.display = 'block';
                tLoggedIn.style.display = 'none';
            }
        }

        // =========================================================================
        // Conflict Resolution
        // =========================================================================
        function treePreviewHTML(tree) {
            if (!tree || !tree.children || tree.children.length === 0) {
                return '<div style="color:#999;">ï¼ˆç„¡è³‡æ–™ï¼‰</div>';
            }
            let html = '';
            tree.children.forEach(d => {
                html += `<div class="demand-item">ğŸ”¹ ${d.name}</div>`;
                (d.actions || []).forEach(a => {
                    const cp = typeof a.cp === 'number' ? a.cp.toFixed(2) : '?';
                    html += `<div class="action-item">â”œ ${a.name} (CP: ${cp})</div>`;
                });
            });
            return html;
        }

        // conflictSource: 'auto' (page load), 'importLocal', 'importDrive'
        let pendingConflictLeft = null;
        let pendingConflictRight = null;
        let pendingConflictSource = null;

        function generateFileName() {
            const now = new Date();
            const ts = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            return `addiction-log-export-${ts}.json`;
        }

        function showConflictDialog(leftTree, rightTree, leftTitle, rightTitle, source) {
            pendingConflictLeft = leftTree;
            pendingConflictRight = rightTree;
            pendingConflictSource = source;
            document.getElementById('conflict-left-title').textContent = leftTitle;
            document.getElementById('conflict-right-title').textContent = rightTitle;
            document.getElementById('conflict-btn-left').textContent = `ğŸ“‚ ä½¿ç”¨${leftTitle.replace(/[^\u4e00-\u9fff\w\s]/g, '').trim()}`;
            document.getElementById('conflict-btn-right').textContent = `â˜ï¸ ä½¿ç”¨${rightTitle.replace(/[^\u4e00-\u9fff\w\s]/g, '').trim()}`;
            document.getElementById('conflict-local-preview').innerHTML = treePreviewHTML(leftTree);
            document.getElementById('conflict-drive-preview').innerHTML = treePreviewHTML(rightTree);
            document.getElementById('conflict-overlay').classList.add('show');
        }

        async function resolveConflict(choice) {
            document.getElementById('conflict-overlay').classList.remove('show');

            const chosenTree = choice === 'left' ? pendingConflictLeft : pendingConflictRight;

            if (!chosenTree) {
                showToast('âš ï¸ æ‰€é¸ç‰ˆæœ¬è³‡æ–™ç‚ºç©º', 'error');
                return;
            }

            // Restore the chosen version
            restoreTreeFromSerialized(chosenTree);
            saveToLocal();
            initApp();

            // Create new Drive file (because import diff â†’ new file)
            const mode = getStorageMode();
            if ((mode === 'drive' || mode === 'both') && currentUser) {
                try {
                    const fileName = generateFileName();
                    const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ fileName }),
                    });
                    const createData = await createRes.json();
                    if (createData.success) {
                        currentUser.hasDriveFile = true;
                        updateAuthUI();
                        await syncToDriveInternal('conflict_resolve');
                        localStorage.setItem(STORAGE_KEY_SAVE_DATE, new Date().toISOString().slice(0, 10));
                        showToast('âœ… å·²å»ºç«‹æ–°ç‰ˆæœ¬ä¸¦åŒæ­¥è‡³ Google Drive', 'success');
                    } else {
                        if (createRes.status === 402 || createRes.status === 403) {
                            showToast('âš ï¸ Google Drive ç©ºé–“ä¸è¶³ï¼Œç„¡æ³•å»ºç«‹æª”æ¡ˆ', 'error');
                        } else {
                            showToast('âš ï¸ å»ºç«‹é›²ç«¯æª”æ¡ˆå¤±æ•—ï¼š' + (createData.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                        }
                    }
                } catch (err) {
                    showToast('âš ï¸ é›²ç«¯æ“ä½œå¤±æ•—ï¼š' + err.message, 'error');
                }
            }

            showToast('ğŸ’¡ æˆ‘å€‘ä¸æœƒåˆªé™¤æ‚¨çš„ä»»ä½•æª”æ¡ˆï¼Œæ‰€æœ‰èˆŠæª”æ¡ˆéƒ½ä¿ç•™åœ¨åŸè™•ï¼Œæ‚¨å¯è‡ªè¡Œç®¡ç†ã€‚', 'warning');
            pendingConflictLeft = null;
            pendingConflictRight = null;
            pendingConflictSource = null;
        }

        // =========================================================================
        // Load / Sync to Drive
        // =========================================================================
        async function loadTreeFromDrive() {
            try {
                const res = await fetch(API_BASE + '/api/load-from-drive', { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();
                if (data.success && data.data && data.data.treeData) {
                    if (restoreTreeFromSerialized(data.data.treeData)) {
                        saveToLocal();
                        initApp();
                        showToast('â˜ï¸ å·²å¾ Google Drive è¼‰å…¥è³‡æ–™', 'success');
                    }
                }
            } catch (err) {
                console.error('Load from Drive error:', err);
            }
        }

        // Google Drive Folder Picker â€” select or create a folder, then create file inside it
        async function openDrivePicker() {
            if (!currentUser) {
                showToast('âš ï¸ è«‹å…ˆç™»å…¥ Google', 'error');
                return;
            }

            // Show loading modal
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = 'ğŸ“ æ›´æ› Google Drive è·¯å¾‘';
            document.getElementById('modal-message').innerHTML = '<div class="picker-loading">â³ æ­£åœ¨è¼‰å…¥è³‡æ–™å¤¾åˆ—è¡¨...</div>';
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn-cancel" onclick="document.getElementById('modal-overlay').classList.remove('show')">å–æ¶ˆ</button>`;
            overlay.classList.add('show');

            try {
                const res = await fetch(API_BASE + '/api/browse-drive?action=folders', { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');

                const folders = data.folders || [];
                let selectedFolderId = null;
                let selectedFolderName = data.currentFolder || '';

                // Build folder list HTML
                let listHTML = '<div class="picker-list">';
                // Root (no folder) option
                listHTML += `<div class="picker-item${!selectedFolderName ? ' active' : ''}" data-id="" data-name="">
                    <span>ğŸ“</span> <span>æ ¹ç›®éŒ„ (My Drive)</span>
                </div>`;
                folders.forEach(f => {
                    const isActive = f.name === selectedFolderName;
                    const date = new Date(f.modifiedTime).toLocaleDateString();
                    listHTML += `<div class="picker-item${isActive ? ' active' : ''}" data-id="${f.id}" data-name="${f.name}">
                        <span>ğŸ“‚</span> <span>${f.name}</span> <span class="picker-meta">${date}</span>
                    </div>`;
                });
                if (folders.length === 0) {
                    listHTML += '<div class="picker-empty">ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™å¤¾</div>';
                }
                listHTML += '</div>';

                // Create new folder input
                listHTML += `<div class="picker-create-row">
                    <input type="text" id="new-folder-name" placeholder="è¼¸å…¥æ–°è³‡æ–™å¤¾åç¨±..." class="modal-box input">
                    <button class="modal-btn-primary" id="btn-create-folder" style="padding:10px 16px;">â• å»ºç«‹</button>
                </div>`;

                document.getElementById('modal-message').innerHTML = 'é¸æ“‡ç¾æœ‰è³‡æ–™å¤¾ï¼Œæˆ–å»ºç«‹æ–°çš„ï¼š' + listHTML;
                document.getElementById('modal-actions').innerHTML =
                    `<button class="modal-btn-cancel" id="picker-cancel">å–æ¶ˆ</button>` +
                    `<button class="modal-btn-primary" id="picker-confirm">âœ… ä½¿ç”¨æ­¤è³‡æ–™å¤¾</button>`;

                // Event: click folder item
                document.querySelectorAll('.picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedFolderId = item.getAttribute('data-id');
                        selectedFolderName = item.getAttribute('data-name');
                    });
                });

                // Event: create new folder
                document.getElementById('btn-create-folder').onclick = async () => {
                    const newName = document.getElementById('new-folder-name').value.trim();
                    if (!newName) { showToast('âš ï¸ è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±', 'error'); return; }
                    selectedFolderName = newName;
                    selectedFolderId = null; // backend will create it
                    // Visual feedback
                    document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                    showToast(`ğŸ“‚ å°‡å»ºç«‹æ–°è³‡æ–™å¤¾ã€Œ${newName}ã€`, 'success');
                    // Auto-confirm
                    await doPickerConfirm(selectedFolderName);
                };

                // Event: cancel
                document.getElementById('picker-cancel').onclick = () => overlay.classList.remove('show');

                // Event: confirm
                document.getElementById('picker-confirm').onclick = () => doPickerConfirm(selectedFolderName);

                async function doPickerConfirm(folderName) {
                    overlay.classList.remove('show');
                    const fileName = generateFileName();
                    showToast('â³ æ­£åœ¨å»ºç«‹æª”æ¡ˆ...', 'warning');
                    try {
                        const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ fileName, folderName: folderName || undefined }),
                        });
                        const createData = await createRes.json();
                        if (createData.success) {
                            currentUser.hasDriveFile = true;
                            updateAuthUI();
                            showToast(`â˜ï¸ å·²åœ¨${folderName ? `ã€Œ${folderName}ã€` : 'æ ¹ç›®éŒ„'}å»ºç«‹åŒæ­¥æª”æ¡ˆ`, 'success');
                        } else {
                            showToast('âš ï¸ å»ºç«‹å¤±æ•—ï¼š' + (createData.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                        }
                    } catch (err) {
                        showToast('âš ï¸ æ“ä½œå¤±æ•—ï¼š' + err.message, 'error');
                    }
                }
            } catch (err) {
                overlay.classList.remove('show');
                showToast('âš ï¸ è¼‰å…¥è³‡æ–™å¤¾å¤±æ•—ï¼š' + err.message, 'error');
            }
        }

        // Serialize humanTree for sync
        function serializeTreeForSync() {
            const stageMap = { dock: 0, cue: 1, craving: 2, response: 3, reward: 4 };
            return {
                name: humanTree.name,
                children: humanTree.children.map(demand => ({
                    id: demand.id,
                    name: demand.name,
                    actions: demand.actions.map(action => {
                        const tokenSlots = [[], [], [], [], []];
                        (action.tokens || []).forEach(t => {
                            const idx = stageMap[t.stage] !== undefined ? stageMap[t.stage] : 0;
                            tokenSlots[idx].push({
                                id: t.id, name: t.name, score: t.score, timeType: t.timeType,
                            });
                        });
                        return {
                            id: action.id, name: action.name, cp: action.cp,
                            st: action.st, lt: action.lt, isNew: action.isNew, tokenSlots,
                        };
                    }),
                })),
            };
        }

        // Internal sync (used by conflict resolution + normal sync)
        async function syncToDriveInternal(triggerAction) {
            if (!currentUser || !currentUser.hasDriveFile) return false;
            try {
                const payload = {
                    triggerAction,
                    treeData: serializeTreeForSync(),
                    syncTimestamp: new Date().toISOString(),
                };
                const res = await fetch(API_BASE + '/api/sync-drive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(payload),
                });
                if (res.ok) return true;

                const data = await res.json();
                if (res.status === 402 || res.status === 403) {
                    showToast('âš ï¸ Google Drive ç©ºé–“ä¸è¶³ï¼Œç„¡æ³•åŒæ­¥ï¼Œè«‹æ¸…ç†é›²ç«¯ç©ºé–“', 'error');
                }
                throw new Error(data.error || 'åŒæ­¥å¤±æ•—');
            } catch (err) {
                throw err;
            }
        }

        // Public sync function: respects storage mode + next-day detection
        async function syncToDrive(triggerAction, isFromImportDiff = false) {
            const mode = getStorageMode();
            const today = new Date().toISOString().slice(0, 10);
            const lastSaveDate = localStorage.getItem(STORAGE_KEY_SAVE_DATE);
            const needNewFile = (lastSaveDate && today !== lastSaveDate) || isFromImportDiff;

            // Always save to local if mode is 'local' or 'both'
            if (mode === 'local' || mode === 'both') {
                saveToLocal();
            }

            // Sync to Drive if mode is 'drive' or 'both'
            if ((mode === 'drive' || mode === 'both') && currentUser && currentUser.hasDriveFile) {
                const syncDot = document.getElementById('sync-dot');
                if (syncDot) {
                    syncDot.className = 'sync-indicator syncing';
                    syncDot.title = 'åŒæ­¥ä¸­...';
                }
                try {
                    if (needNewFile) {
                        // Next day or import diff â†’ create new file first
                        const fileName = generateFileName();
                        const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ fileName }),
                        });
                        const createData = await createRes.json();
                        if (createData.success) {
                            currentUser.hasDriveFile = true;
                            updateAuthUI();
                        } else {
                            throw new Error(createData.error || 'å»ºç«‹æ–°æª”æ¡ˆå¤±æ•—');
                        }
                    }
                    // Now write data to the (new or existing) controlled file
                    await syncToDriveInternal(triggerAction);
                    if (syncDot) {
                        syncDot.className = 'sync-indicator synced';
                        syncDot.title = 'å·²åŒæ­¥';
                    }
                    showToast(needNewFile ? 'â˜ï¸ å·²å»ºç«‹æ–°æª”æ¡ˆä¸¦åŒæ­¥è‡³ Google Drive' : 'â˜ï¸ å·²åŒæ­¥è‡³ Google Drive', 'success');
                } catch (err) {
                    if (syncDot) {
                        syncDot.className = 'sync-indicator error';
                        syncDot.title = 'åŒæ­¥å¤±æ•—';
                    }
                    showToast('âš ï¸ Drive åŒæ­¥å¤±æ•—ï¼š' + err.message, 'error');
                }
            }

            // If local-only mode, also save to local
            if (mode === 'local') {
                saveToLocal();
            }

            // Track today's date
            localStorage.setItem(STORAGE_KEY_SAVE_DATE, today);
        }

        // =========================================================================
        // Local File Export / Import
        // =========================================================================
        function exportToLocalFile() {
            const data = JSON.stringify({
                exportedAt: new Date().toISOString(),
                treeData: serializeTreeForSync(),
            }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generateFileName();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ğŸ’¾ å·²åŒ¯å‡ºè‡³æœ¬æ©Ÿæª”æ¡ˆ', 'success');
        }

        function importFromLocalFile() {
            document.getElementById('local-file-input').click();
        }

        function handleLocalFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.json')) {
                showToast('âš ï¸ åªæ”¯æ´ .json æª”æ¡ˆ', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    const importedTree = parsed.treeData || parsed.humanTree || parsed;
                    if (!importedTree || !importedTree.children || importedTree.children.length === 0) {
                        showToast('âš ï¸ æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•åŒ¯å…¥', 'error');
                        return;
                    }
                    // Compare with current web data
                    const currentTree = serializeTreeForSync();
                    const currentStr = JSON.stringify(currentTree);
                    const importedStr = JSON.stringify(importedTree);
                    if (hasInitialized && currentStr !== importedStr) {
                        // Different â†’ show conflict dialog
                        showConflictDialog(currentTree, importedTree, 'ğŸ–¥ï¸ ç›®å‰ç¶²é è³‡æ–™', 'ğŸ“‚ åŒ¯å…¥çš„æª”æ¡ˆ', 'importLocal');
                    } else {
                        // Same or no existing data â†’ apply directly
                        restoreTreeFromSerialized(importedTree);
                        saveToLocal();
                        initApp();
                        showToast('ğŸ“‚ å·²å¾æœ¬æ©Ÿæª”æ¡ˆåŒ¯å…¥è³‡æ–™', 'success');
                        syncToDrive('importLocalFile', true);
                    }
                } catch (err) {
                    showToast('âš ï¸ æª”æ¡ˆè§£æå¤±æ•—ï¼š' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for re-import
        }

        // Manual import from Google Drive with file picker (does NOT change auto-save mode)
        async function importFromDrive() {
            if (!currentUser) {
                showToast('âš ï¸ è«‹å…ˆç™»å…¥ Google', 'error');
                return;
            }

            // Show loading modal
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = 'â˜ï¸ å¾ Google Drive åŒ¯å…¥';
            document.getElementById('modal-message').innerHTML = '<div class="picker-loading">â³ æ­£åœ¨è¼‰å…¥æª”æ¡ˆåˆ—è¡¨...</div>';
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn-cancel" onclick="document.getElementById('modal-overlay').classList.remove('show')">å–æ¶ˆ</button>`;
            overlay.classList.add('show');

            try {
                const res = await fetch(API_BASE + '/api/browse-drive?action=files', { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');

                const files = data.files || [];
                let selectedFileId = null;

                let listHTML = '<div class="picker-list">';
                if (files.length === 0) {
                    listHTML += '<div class="picker-empty">æ‰¾ä¸åˆ°ä»»ä½• .json æª”æ¡ˆ</div>';
                } else {
                    files.forEach(f => {
                        const date = new Date(f.modifiedTime).toLocaleString();
                        const sizeKB = f.size ? (parseInt(f.size) / 1024).toFixed(1) + ' KB' : '';
                        listHTML += `<div class="picker-item" data-id="${f.id}">
                            <span>ğŸ“„</span> <span>${f.name}</span> <span class="picker-meta">${sizeKB} ãƒ» ${date}</span>
                        </div>`;
                    });
                }
                listHTML += '</div>';

                document.getElementById('modal-message').innerHTML = 'é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆï¼š' + listHTML;
                document.getElementById('modal-actions').innerHTML =
                    `<button class="modal-btn-cancel" id="file-picker-cancel">å–æ¶ˆ</button>` +
                    `<button class="modal-btn-primary" id="file-picker-confirm" disabled>âœ… åŒ¯å…¥æ­¤æª”æ¡ˆ</button>`;

                // Event: click file item
                document.querySelectorAll('.picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedFileId = item.getAttribute('data-id');
                        document.getElementById('file-picker-confirm').disabled = false;
                    });
                });

                document.getElementById('file-picker-cancel').onclick = () => overlay.classList.remove('show');

                document.getElementById('file-picker-confirm').onclick = async () => {
                    if (!selectedFileId) return;
                    overlay.classList.remove('show');
                    showToast('â³ æ­£åœ¨è¼‰å…¥æª”æ¡ˆ...', 'warning');
                    try {
                        const loadRes = await fetch(API_BASE + '/api/browse-drive', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ action: 'load', fileId: selectedFileId }),
                        });
                        const loadData = await loadRes.json();
                        if (!loadData.success || !loadData.data) {
                            showToast('âš ï¸ æª”æ¡ˆè®€å–å¤±æ•—', 'error');
                            return;
                        }
                        const driveTree = loadData.data.treeData || loadData.data;
                        const currentTree = serializeTreeForSync();
                        const currentStr = JSON.stringify(currentTree);
                        const driveStr = JSON.stringify(driveTree);
                        if (hasInitialized && currentStr !== driveStr) {
                            showConflictDialog(currentTree, driveTree, 'ğŸ–¥ï¸ ç›®å‰ç¶²é è³‡æ–™', 'â˜ï¸ Google Drive æª”æ¡ˆ', 'importDrive');
                        } else {
                            restoreTreeFromSerialized(driveTree);
                            saveToLocal();
                            initApp();
                            showToast('â˜ï¸ å·²å¾ Google Drive åŒ¯å…¥è³‡æ–™', 'success');
                        }
                    } catch (err) {
                        showToast('âš ï¸ è¼‰å…¥å¤±æ•—ï¼š' + err.message, 'error');
                    }
                };
            } catch (err) {
                overlay.classList.remove('show');
                showToast('âš ï¸ è¼‰å…¥æª”æ¡ˆåˆ—è¡¨å¤±æ•—ï¼š' + err.message, 'error');
            }
        }

        // =========================================================================
        // More Options (â˜°) Menu
        // =========================================================================
        function toggleMoreMenu(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            // Close all other dropdowns first
            document.querySelectorAll('.more-dropdown').forEach(d => {
                if (d.id !== dropdownId) d.classList.remove('show');
            });
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                buildMoreDropdown(dropdownId);
                dropdown.classList.add('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.more-options-wrapper')) {
                document.querySelectorAll('.more-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function buildMoreDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const mode = getStorageMode();
            const isLoggedIn = !!currentUser;
            const tosAccepted = getTosAccepted();

            let html = '';

            // å¦‚æœæœªåŒæ„ TOSï¼Œåªé¡¯ç¤ºåŒæ„æŒ‰éˆ•èˆ‡åˆªé™¤æŒ‰éˆ•
            if (!tosAccepted) {
                html += '<div class="more-dropdown-header" style="color:var(--bad);">æˆæ¬Šè¨­å®š</div>';
                html += `<label class="more-dropdown-item" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" onchange="setTosAccepted(this.checked)" ${tosAccepted ? 'checked' : ''} style="width: 16px; height: 16px;">
                    <span style="flex:1;">âœ… æˆ‘å·²é–±è®€ä¸¦åŒæ„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ¬Š</span>
                </label>`;

                html += `<button class="more-dropdown-item" onclick="window.open('privacy.html', '_blank'); closeAllDropdowns();">
                    <span class="item-icon">ğŸ“„</span> éš±ç§æ¬Šæ”¿ç­– (Privacy Policy)
                </button>`;
                html += `<button class="more-dropdown-item" onclick="window.open('tos.html', '_blank'); closeAllDropdowns();">
                    <span class="item-icon">ğŸ“œ</span> æœå‹™æ¢æ¬¾ (Terms of Service)
                </button>`;

                html += '<div class="more-dropdown-divider"></div>';
                html += '<div class="more-dropdown-header" style="color:var(--bad);">å±éšªæ“ä½œ</div>';
                html += `<button class="more-dropdown-item" onclick="deleteAllDataFlow(); closeAllDropdowns();" style="color:var(--bad);">
                    <span class="item-icon">ğŸ—‘ï¸</span> åˆªé™¤æ‰€æœ‰è³‡æ–™ (Remove all my data)
                </button>`;
                dropdown.innerHTML = html;
                return;
            }

            html += '<div class="more-dropdown-header">å„²å­˜æ¨¡å¼</div>';

            // Local only
            html += `<button class="more-dropdown-item ${mode === 'local' ? 'active' : ''}" onclick="switchMode('local')">
                <span class="item-icon">ğŸ“‚</span> åƒ…ä½¿ç”¨æœ¬æ©Ÿ (Local Only)
            </button>`;

            // Drive only (requires login)
            if (isLoggedIn) {
                html += `<button class="more-dropdown-item ${mode === 'drive' ? 'active' : ''}" onclick="switchMode('drive')">
                    <span class="item-icon">â˜ï¸</span> åƒ…ä½¿ç”¨ Google Drive
                </button>`;
                html += `<button class="more-dropdown-item ${mode === 'both' ? 'active' : ''}" onclick="switchMode('both')">
                    <span class="item-icon">ğŸ”„</span> æœ¬æ©Ÿèˆ‡é›²ç«¯åŒæ­¥ (Sync Both)
                </button>`;
            }

            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">æª”æ¡ˆæ“ä½œ</div>';

            html += `<button class="more-dropdown-item" onclick="exportToLocalFile(); closeAllDropdowns();">
                <span class="item-icon">ğŸ’¾</span> åŒ¯å‡ºåˆ°æœ¬æ©Ÿæª”æ¡ˆ
            </button>`;
            html += `<button class="more-dropdown-item" onclick="importFromLocalFile(); closeAllDropdowns();">
                <span class="item-icon">ğŸ“‚</span> å¾æœ¬æ©Ÿæª”æ¡ˆåŒ¯å…¥
            </button>`;

            // Import from Google Drive (manual, doesn't change mode)
            if (isLoggedIn) {
                html += `<button class="more-dropdown-item" onclick="importFromDrive(); closeAllDropdowns();">
                    <span class="item-icon">â˜ï¸</span> å¾ Google Drive åŒ¯å…¥
                </button>`;
            }

            // Divider + change save path
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">å„²å­˜è·¯å¾‘</div>';

            // Local path â€” show status based on mode
            const localActive = (mode === 'local' || mode === 'both');
            html += `<div class="more-dropdown-item" style="cursor:default; font-size:0.88rem;">
                <span class="item-icon">ğŸ’»</span> æœ¬æ©Ÿå„²å­˜ <span style="color:#999; font-size:0.78rem;">(ç„¡æ³•æ›´æ”¹è·¯å¾‘)</span>
            </div>`;

            if (isLoggedIn) {
                html += `<button class="more-dropdown-item" onclick="openDrivePicker(); closeAllDropdowns();">
                    <span class="item-icon">ğŸ“</span> æ›´æ› Google Drive è·¯å¾‘
                </button>`;
            }

            // Legal links
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">æ³•è¦èˆ‡æ¢æ¬¾</div>';
            html += `<label class="more-dropdown-item" style="cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" onchange="setTosAccepted(this.checked)" checked style="width: 16px; height: 16px;">
                <span style="flex:1; color: var(--primary);">âœ… å·²åŒæ„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ¬Š</span>
            </label>`;
            html += `<button class="more-dropdown-item" onclick="window.open('privacy.html', '_blank'); closeAllDropdowns();">
                <span class="item-icon">ğŸ“„</span> éš±ç§æ¬Šæ”¿ç­– (Privacy Policy)
            </button>`;
            html += `<button class="more-dropdown-item" onclick="window.open('tos.html', '_blank'); closeAllDropdowns();">
                <span class="item-icon">ğŸ“œ</span> æœå‹™æ¢æ¬¾ (Terms of Service)
            </button>`;

            // Danger zone
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header" style="color:var(--bad);">å±éšªæ“ä½œ</div>';
            html += `<button class="more-dropdown-item" onclick="deleteAllDataFlow(); closeAllDropdowns();" style="color:var(--bad);">
                <span class="item-icon">ğŸ—‘ï¸</span> åˆªé™¤æ‰€æœ‰è³‡æ–™ (Remove all my data)
            </button>`;

            dropdown.innerHTML = html;
        }

        function updateMoreDropdowns() {
            ['welcome-more-dropdown', 'tree-more-dropdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.classList.contains('show')) {
                    buildMoreDropdown(id);
                }
            });
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.more-dropdown').forEach(d => d.classList.remove('show'));
        }

        function switchMode(newMode) {
            if (newMode === 'drive' && !currentUser) {
                showToast('âš ï¸ è«‹å…ˆç™»å…¥ Google å¸³æˆ¶', 'error');
                return;
            }
            setStorageMode(newMode);
            const labels = { local: 'ğŸ“‚ åƒ…æœ¬æ©Ÿ', drive: 'â˜ï¸ åƒ…é›²ç«¯', both: 'ğŸ”„ æœ¬æ©Ÿ + é›²ç«¯åŒæ­¥' };
            showToast(`å·²åˆ‡æ›ç‚ºï¼š${labels[newMode]}`, 'success');
            closeAllDropdowns();

            // If switching to both or drive and we have tree data, sync immediately
            if ((newMode === 'both' || newMode === 'drive') && hasInitialized && currentUser && currentUser.hasDriveFile) {
                syncToDrive('switchMode');
            }
            // If switching to local or both, save to local
            if (newMode === 'local' || newMode === 'both') {
                saveToLocal();
            }
        }

        async function deleteAllDataFlow() {
            const html = `
                <div style="text-align:left; padding-top: 10px;">
                    <p style="font-size: 1rem; margin-bottom: 10px; color: var(--bad);">è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‚¨åœ¨æ­¤ç¶²ç«™ä¸Šçš„æ‰€æœ‰å¸³è™Ÿè³‡æ–™èˆ‡è¨­å®šï¼Œä¸”ç„¡æ³•é‚„åŸã€‚</p>
                    <p style="font-size: 0.95rem; margin-bottom: 10px;">è‹¥ç¢ºå®šè¦åˆªé™¤ï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ï¼š<br><strong style="user-select:all; color:#333; background:#f5f5f5; padding:2px 4px; border-radius:4px;">I want to remove all my data on this website</strong></p>
                    <input type="text" id="modal-delete-confirm-input" placeholder="è«‹è¼¸å…¥ç¢ºèªæ–‡å­—..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                </div>
            `;
            const ok = await showModal({
                title: 'ğŸ—‘ï¸ åˆªé™¤æ‰€æœ‰è³‡æ–™',
                message: html,
                confirmText: 'ç¢ºå®šåˆªé™¤',
                cancelText: 'å–æ¶ˆ',
                danger: true
            });

            if (ok) {
                const inputEl = document.getElementById('modal-delete-confirm-input');
                if (!inputEl) return;
                const inputVal = inputEl.value.trim();

                if (inputVal !== 'I want to remove all my data on this website') {
                    showToast('âš ï¸ è¼¸å…¥çš„ç¢ºèªæ–‡å­—ä¸æ­£ç¢ºï¼Œåˆªé™¤å·²å–æ¶ˆ', 'error');
                    return;
                }

                // Call backend if logged in
                if (currentUser) {
                    try {
                        await fetch(API_BASE + '/api/auth/me', {
                            method: 'DELETE',
                            headers: authHeaders()
                        });
                    } catch (err) {
                        console.error('Delete account error', err);
                    }
                }

                // Clear everything locally
                localStorage.clear();

                showToast('âœ… æˆåŠŸåˆªé™¤æ‰€æœ‰è³‡æ–™ (Successfully removed all your data)', 'success');

                // Reset state
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        }

        // =========================================================================
        // Page Init
        // =========================================================================
        handleTosUI();
        checkAuth();
        initApp();
    </script>
</body>

</html>