<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原子習慣：大腦行為樹系統</title>
    <style>
        /* ================= TOS Block Overlay ================= */
        .tos-block-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            z-index: 90;
            /* 必須低於 Auth-bar (100) 與 Modal (9000+)，阻擋其餘內容 */
            pointer-events: auto;
            /* 攔截點擊 */
        }

        .tos-block-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            display: none;
        }

        .tos-block-overlay.show .tos-block-content {
            display: block;
        }

        .tos-block-overlay.show {
            display: block;
        }

        /* ================= 基礎顏色與全域設定 ================= */
        :root {
            --bg-color: #F4F7F6;
            --text-main: #2C3E50;
            --cue: #95A5A6;
            --craving: #F39C12;
            --response: #8E44AD;
            --reward: #E74C3C;
            --good: #2ECC71;
            --bad: #E74C3C;
            --st-color: #3498DB;
            --lt-color: #34495E;
            --line-color: #BDC3C7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            /* 畫布模式下移除 padding */
            overflow-x: hidden;
        }

        /* 限制一般表單畫面的最大寬度 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            text-align: center;
        }

        /* ================= HTML 提示系統 (Toast) ================= */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 2px solid;
            pointer-events: auto;
        }

        .toast .toast-close {
            margin-left: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .toast .toast-close:hover {
            opacity: 1;
        }

        .toast.error {
            border-color: var(--bad);
            color: var(--bad);
        }

        .toast.success {
            border-color: var(--good);
            color: var(--good);
        }

        .toast.warning {
            border-color: var(--craving);
            color: var(--craving);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ================= 按鈕與輸入框 ================= */
        button {
            padding: 12px 24px;
            font-size: 1rem;
            color: white;
            background: var(--text-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.8;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        button.primary {
            background: var(--st-color);
        }

        button.success {
            background: var(--good);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.2s;
        }

        input:focus {
            border-color: var(--st-color);
            outline: none;
        }

        /* ================= 視圖切換 ================= */
        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ================= View 0: 歡迎畫面 ================= */
        .welcome-box {
            background: white;
            max-width: 600px;
            margin: 80px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 6px solid var(--st-color);
        }

        /* ================= View 1: 無邊界畫布樹狀圖 (Infinite Canvas) ================= */
        .tree-canvas-container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            /* 隱藏原生拉條 */
            background: radial-gradient(circle, #EAECEE 2px, transparent 2px);
            /* 網格背景 */
            background-size: 30px 30px;
            background-color: var(--bg-color);
            position: fixed;
            top: 0;
            left: 0;
            cursor: grab;
            z-index: 1;
            touch-action: none;
        }

        .tree-canvas-container:active {
            cursor: grabbing;
        }

        .tree-zoom-layer {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            /* 確保是以左上角為基準點計算縮放，並由 JS 控制平移 */
            will-change: transform;
            padding: 100px;
            /* 給予內部一點初始緩衝空間 */
        }

        /* 浮動的標題 UI (蓋在畫布上方) */
        .canvas-ui-layer {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .canvas-ui-layer>* {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        /* 樹狀圖核心佈局 */
        ul.tree {
            list-style: none;
            padding-left: 0;
            display: flex;
            margin: 0;
            align-items: center;
            justify-content: flex-start;
        }

        ul.tree ul {
            list-style: none;
            padding-left: 120px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        ul.tree li {
            display: flex;
            align-items: center;
            position: relative;
            padding: 20px 0;
        }

        .node-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 180px;
            text-align: center;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .node-box.root-node {
            border-color: var(--text-main);
            background: var(--text-main);
            color: white;
            cursor: default;
        }

        .node-box.demand-node {
            border-left: 8px solid var(--st-color);
        }

        .node-box.action-node {
            border-color: #eee;
            background: #F8F9FA;
        }

        .node-box.action-node:hover {
            border-color: var(--st-color);
            transform: scale(1.05);
            background: #EDF2F8;
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
        }

        .node-box.action-node.lt-negative {
            border: 2px dashed var(--bad);
        }

        .node-box.action-node.lt-positive {
            border: 2px dashed var(--good);
        }

        .node-box.add-node {
            border: 2px dashed var(--good);
            color: var(--good);
            background: #E8F8F5;
            font-weight: bold;
        }

        .node-box.add-node:hover {
            background: var(--good);
            color: white;
        }

        .cp-crown {
            font-size: 1.5rem;
            position: absolute;
            top: -15px;
            left: -10px;
            transform: rotate(-20deg);
        }

        .action-cp-text {
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 8px;
            color: #7f8c8d;
        }

        /* Hover "x" delete button on top-right of nodes */
        .node-delete-x {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bad);
            color: white;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5;
            font-weight: bold;
        }

        .node-box:hover>.node-delete-x {
            opacity: 1;
        }

        .node-delete-x:hover {
            transform: scale(1.2);
        }

        /* 連接線 (has-children 橫線已移除，僅保留 li 上的結構線) */

        .rel-text {
            position: absolute;
            right: -105px;
            top: -20px;
            font-size: 0.8rem;
            color: var(--text-main);
            font-weight: bold;
            width: 90px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3;
            padding: 4px 0;
            border-radius: 4px;
        }

        .rel-text.action-rel {
            color: var(--craving);
        }

        .best-action-label {
            position: absolute;
            right: calc(100% + 5px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: var(--craving);
            font-weight: bold;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3;
            padding: 4px 6px;
            border-radius: 4px;
        }

        /* 大腦短期預設線：從 demand 到短期CP最高的 action */
        ul.tree ul li.st-default-line-red::before {
            background: var(--bad) !important;
            height: 2px;
        }

        ul.tree ul li.st-default-line-green::before {
            background: var(--good) !important;
            height: 2px;
        }

        /* 垂直色線：用 overlay div 覆蓋在原本的灰色線上面 */
        .st-vert-overlay {
            position: absolute;
            left: -120px;
            top: 0;
            bottom: 0;
            width: 2px;
            z-index: 2;
            pointer-events: none;
        }

        .st-vert-overlay.red {
            background: var(--bad);
        }

        .st-vert-overlay.green {
            background: var(--good);
        }

        /* 起點：停在水平線的垂直中心 (通常往下延展) */
        li:first-child>.st-vert-overlay,
        .st-vert-overlay.start {
            top: 50%;
        }

        /* 終點：停在水平線的垂直中心 (通常往上延展) */
        .st-vert-overlay.end {
            bottom: calc(50% - 2px);
            /* overlap exactly with the 2px horizontal line */
        }

        /* 如果同一個點既是起點又是終點（水平對連）就乾脆隱藏，因為不需要垂直線 */
        .st-vert-overlay.start.end {
            display: none;
        }

        .st-default-label {
            position: absolute;
            right: calc(100% + 5px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            z-index: 3;
            padding: 4px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
        }

        .best-action-label.up {
            top: calc(50% - 15px);
        }

        .st-default-label.down {
            top: calc(50% + 15px);
        }

        .st-default-label.bad {
            color: var(--bad);
        }

        .st-default-label.good {
            color: var(--good);
        }

        ul.tree ul li::before {
            content: '';
            position: absolute;
            left: -120px;
            top: 50%;
            width: 120px;
            height: 2px;
            background: var(--line-color);
            z-index: 1;
        }

        ul.tree ul li::after {
            content: '';
            position: absolute;
            left: -120px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--line-color);
            z-index: 1;
        }

        ul.tree ul li:first-child::after {
            top: 50%;
        }

        ul.tree ul li:last-child::after {
            bottom: 50%;
        }

        ul.tree ul li:first-child:last-child::after {
            display: none;
        }

        /* ================= View 2: 四階段編輯器 ================= */
        .editor-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 15px;
        }

        .stage-box {
            flex: 1;
            min-width: 240px;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 280px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-top: 6px solid;
            transition: all 0.2s ease;
        }

        .stage-box.dragover {
            background: #F4F6F6;
            transform: scale(1.02);
        }

        #stage-cue {
            border-color: var(--cue);
        }

        #stage-craving {
            border-color: var(--craving);
        }

        #stage-response {
            border-color: var(--response);
        }

        #stage-reward {
            border-color: var(--reward);
        }

        /* Drop zone 內部置中設定 */
        .drop-zone {
            flex: 1;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 120px;
            margin-top: 15px;
        }

        #token-dock {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border-color: var(--st-color);
        }

        .dock-hint {
            width: 100%;
            text-align: center;
            color: #999;
            font-size: 0.95rem;
            user-select: none;
        }

        .token-creator {
            background: #EDF2F8;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .cp-token {
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            cursor: grab;
            font-size: 0.95rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            user-select: none;
            z-index: 10;
        }

        .cp-token:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .st-token {
            background: var(--st-color);
        }

        .lt-token {
            background: var(--lt-color);
        }

        .token-del {
            margin-left: 15px;
            cursor: pointer;
            color: #fff;
            opacity: 0.7;
        }

        .token-del:hover {
            opacity: 1;
        }

        .score-board {
            display: block;
            text-align: center;
            background: white;
            padding: 20px 20px 35px 20px;
            /* enough space for absolute item */
            border-radius: 12px;
            margin: 25px 0;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* 系統強制防護的 HTML 文字框 */
        .alert-box {
            background: #FDEDEC;
            border: 2px solid var(--bad);
            border-left-width: 8px;
            padding: 20px;
            margin: 25px 0;
            color: #C0392B;
            display: none;
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .alert-box.success-box {
            background: #EAFAF1;
            border-color: var(--good);
            color: #1E8449;
        }

        /* ================= Google Auth UI ================= */
        .auth-bar {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-bar .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 16px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .auth-bar .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 22px;
            background: white;
            color: #444;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .btn-google:hover {
            background: #f8f8f8;
            border-color: #4285F4;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.2);
        }

        .btn-drive {
            padding: 8px 18px;
            background: #0F9D58;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-drive:hover {
            background: #0B8043;
            transform: scale(1.03);
        }

        .btn-logout {
            padding: 6px 14px;
            background: transparent;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            color: var(--bad);
            border-color: var(--bad);
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            margin-left: 5px;
            vertical-align: middle;
        }

        .sync-indicator.synced {
            background: var(--good);
        }

        .sync-indicator.syncing {
            background: var(--craving);
            animation: pulse 1s infinite;
        }

        .sync-indicator.error {
            background: var(--bad);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .welcome-auth {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 12px;
        }

        .welcome-auth p {
            margin: 8px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* ================= More Options (☰) Menu ================= */
        .more-options-wrapper {
            position: relative;
            display: inline-block;
        }

        .btn-more {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.4rem;
            color: #555;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .btn-more:hover {
            border-color: var(--st-color);
            color: var(--st-color);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .more-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 260px;
            z-index: 200;
            overflow: hidden;
            animation: dropIn 0.2s ease;
        }

        @keyframes dropIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .more-dropdown.show {
            display: block;
        }

        .more-dropdown-header {
            padding: 14px 18px;
            font-weight: bold;
            font-size: 0.85rem;
            color: #999;
            border-bottom: 1px solid #f0f0f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .more-dropdown-item {
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.92rem;
            color: #333;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .more-dropdown-item:hover {
            background: #f4f7fc;
        }

        .more-dropdown-item.active {
            background: #eef5ff;
            color: var(--st-color);
            font-weight: bold;
        }

        .more-dropdown-item .item-icon {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }

        .more-dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 4px 0;
        }

        /* ================= Conflict Modal ================= */
        .conflict-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .conflict-overlay.show {
            display: flex;
        }

        .conflict-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: dropIn 0.3s ease;
        }

        .conflict-modal h2 {
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .conflict-modal .conflict-subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .conflict-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .conflict-side {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }

        .conflict-side.local-side {
            border-color: var(--craving);
        }

        .conflict-side.drive-side {
            border-color: var(--st-color);
        }

        .conflict-side h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .conflict-side .tree-preview {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
        }

        .conflict-side .tree-preview .demand-item {
            font-weight: bold;
            color: var(--text-main);
            margin-top: 8px;
        }

        .conflict-side .tree-preview .action-item {
            padding-left: 16px;
            color: #666;
        }

        .conflict-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .conflict-actions button {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-use-local {
            background: var(--craving);
            color: white;
            border: none;
        }

        .btn-use-local:hover {
            background: #e67e22;
            transform: scale(1.03);
        }

        .btn-use-drive {
            background: var(--st-color);
            color: white;
            border: none;
        }

        .btn-use-drive:hover {
            background: #2980b9;
            transform: scale(1.03);
        }

        .conflict-note {
            margin-top: 16px;
            font-size: 0.82rem;
            color: #999;
            text-align: center;
            line-height: 1.5;
        }

        /* ================= Welcome top-right More ================= */
        .welcome-top-bar {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 100;
        }

        /* ================= Loading Overlay ================= */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #e0e0e0;
            border-top: 5px solid var(--st-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-status {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-main);
            text-align: center;
        }

        .loading-sub {
            font-size: 0.85rem;
            color: #999;
        }

        /* ================= Generic Modal (replaces confirm/prompt) ================= */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 9500;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 440px;
            padding: 28px;
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.25);
            animation: dropIn 0.25s ease;
            text-align: center;
        }

        .modal-box h3 {
            margin: 0 0 12px 0;
            font-size: 1.15rem;
            color: var(--text-main);
        }

        .modal-box p {
            margin: 0 0 18px 0;
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
        }

        .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .modal-box input:focus {
            border-color: var(--st-color);
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-actions button {
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: var(--st-color);
            color: white;
        }

        .modal-btn-primary:hover {
            background: #2980b9;
        }

        .modal-btn-danger {
            background: var(--bad);
            color: white;
        }

        .modal-btn-danger:hover {
            background: #c0392b;
        }

        .modal-btn-cancel {
            background: #eee;
            color: #555;
        }

        .modal-btn-cancel:hover {
            background: #ddd;
        }

        /* ================= Picker List ================= */
        .picker-list {
            max-height: 250px;
            overflow-y: auto;
            margin: 12px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            text-align: left;
        }

        .picker-item {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.15s;
            font-size: 0.9rem;
        }

        .picker-item:hover {
            background: #f0f7ff;
        }

        .picker-item.active {
            background: #e3f2fd;
            font-weight: bold;
        }

        .picker-item:last-child {
            border-bottom: none;
        }

        .picker-item .picker-meta {
            color: #999;
            font-size: 0.75rem;
            margin-left: auto;
        }

        .picker-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .picker-loading {
            padding: 30px;
            text-align: center;
            color: #999;
        }

        .picker-create-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .picker-create-row input {
            flex: 1;
            margin-bottom: 0;
        }

        /* ================= Mobile Responsiveness (Small Screens) ================= */
        @media (max-width: 600px) {
            .welcome-box {
                margin: 40px auto;
                padding: 20px;
                width: 95%;
            }

            .welcome-box h1 {
                font-size: 1.5rem;
            }

            .welcome-box p {
                font-size: 0.95rem;
            }

            button {
                padding: 10px 18px;
                font-size: 0.95rem;
            }

            .canvas-ui-layer {
                top: 10px;
                left: 10px;
                padding-right: 120px;
                /* Space for auth-bar */
                pointer-events: none;
            }

            .canvas-ui-layer>* {
                padding: 10px 15px;
                pointer-events: auto;
            }

            .canvas-ui-layer h2 {
                font-size: 1.1rem;
                padding-left: 15px !important;
            }

            #info-panel p {
                font-size: 0.8rem !important;
                line-height: 1.5 !important;
            }

            .auth-bar {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .auth-bar .user-info {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .btn-more {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }

            .more-dropdown {
                min-width: 220px;
                right: 0;
                max-width: calc(100vw - 20px);
            }

            .pipeline-container {
                gap: 12px;
            }

            .stage-box {
                min-width: 200px;
                padding: 15px;
                min-height: 220px;
            }

            .editor-header {
                padding: 15px;
            }

            .token-creator {
                padding: 15px;
                gap: 10px;
            }

            .cp-token {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .score-board {
                padding: 15px 15px 25px 15px;
                font-size: 1.1rem;
            }

            .score-board>div {
                gap: 20px !important;
            }

            .modal-box {
                padding: 20px;
            }

            .conflict-compare {
                grid-template-columns: 1fr;
            }

            .conflict-modal {
                padding: 20px;
                width: 95%;
            }

            .conflict-side {
                max-height: 250px;
            }

            .tos-block-content {
                padding: 25px;
                width: 95%;
            }

            .tos-block-content h2 {
                font-size: 1.3rem;
            }

            .toast {
                width: 90%;
                font-size: 0.95rem;
                padding: 10px 20px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions button {
                width: 100%;
            }

            .node-box {
                min-width: 140px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .node-box.root-node {
                min-width: 120px;
            }
        }
    </style>
</head>

<body>

    <!-- ================= Loading Overlay ================= -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-status" id="loading-status">⏳ 正在啟動系統...</div>
        <div class="loading-sub">請稍候，我們正在為您準備資料</div>
    </div>

    <!-- HTML Toast 提示容器 -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ================= Generic Modal ================= -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <input type="text" id="modal-input" style="display:none;" placeholder="">
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <!-- 隱藏的本機檔案 input -->
    <input type="file" id="local-file-input" accept=".json" style="display: none;"
        onchange="handleLocalFileImport(event)">

    <!-- ================= Conflict Modal (Generic / Dynamic Labels) ================= -->
    <div class="conflict-overlay" id="conflict-overlay">
        <div class="conflict-modal">
            <h2>⚠️ 資料版本不一致</h2>
            <p class="conflict-subtitle" id="conflict-subtitle">
                偵測到資料版本不同，請選擇要使用哪一個版本。<br>
                系統會以您選擇的版本建立新檔案。
            </p>
            <div class="conflict-compare">
                <div class="conflict-side local-side">
                    <h3 id="conflict-left-title">📂 版本 A</h3>
                    <div class="tree-preview" id="conflict-local-preview"></div>
                </div>
                <div class="conflict-side drive-side">
                    <h3 id="conflict-right-title">☁️ 版本 B</h3>
                    <div class="tree-preview" id="conflict-drive-preview"></div>
                </div>
            </div>
            <div class="conflict-actions">
                <button class="btn-use-local" id="conflict-btn-left" onclick="resolveConflict('left')">📂 使用版本
                    A</button>
                <button class="btn-use-drive" id="conflict-btn-right" onclick="resolveConflict('right')">☁️ 使用版本
                    B</button>
            </div>
            <p class="conflict-note">
                💡 我們不會刪除您的任何檔案，所有舊檔案都保留在原處，您可自行管理。
            </p>
        </div>
    </div>

    <!-- ================= TOS Blocking Overlay ================= -->
    <div id="tos-block-overlay" class="tos-block-overlay">
        <div class="tos-block-content">
            <h2 style="color: var(--bad);">⚠️ 請先同意服務條款</h2>
            <p>您必須同意服務條款與隱私權政策才能繼續使用本系統。</p>
            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 15px; align-items: center;">
                <a href="privacy.html" target="_blank"
                    style="color: var(--st-color); text-decoration: none; font-weight: bold; font-size: 1.1rem;">📄
                    隱私權政策 (Privacy Policy)</a>
                <a href="tos.html" target="_blank"
                    style="color: var(--st-color); text-decoration: none; font-weight: bold; font-size: 1.1rem;">📜
                    服務條款 (Terms of Service)</a>
            </div>
            <p style="font-size: 0.95rem; color: #777; margin-top: 30px; line-height: 1.6;">
                💡 <b>下一步：</b><br>
                請點擊右上角的「☰」選單，<br>
                勾選並同意條款，即可解除鎖定。
            </p>
        </div>
    </div>

    <!-- ================= View 0: 初始畫面 ================= -->
    <div id="view-welcome" class="view">
        <!-- Welcome 頁面右上角 More Options -->
        <div class="welcome-top-bar">
            <div class="more-options-wrapper">
                <button class="btn-more" onclick="toggleMoreMenu('welcome-more-dropdown')" title="更多選項">☰</button>
                <div class="more-dropdown" id="welcome-more-dropdown"></div>
            </div>
        </div>
        <div class="container">
            <div class="welcome-box">
                <h1 style="color: var(--st-color);">🧠 大腦重塑系統</h1>

                <!-- Google 登入區 -->
                <div class="welcome-auth" id="welcome-auth-section" style="position: relative; z-index: 95;">
                    <div id="welcome-logged-out">
                        <div style="margin-bottom: 15px; text-align: center; font-size: 0.95rem;">
                            <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="tos-checkbox" style="width: 18px; height: 18px;"
                                    onchange="handleTosCheckboxChange(this.checked)">
                                <span>我已閱讀並同意 <a href="privacy.html" target="_blank"
                                        style="color: var(--st-color);">隱私權政策</a> 與 <a href="tos.html" target="_blank"
                                        style="color: var(--st-color);">服務條款</a></span>
                            </label>
                        </div>
                        <p>☁️ 登入 Google 帳戶以同步資料到 Google Drive</p>
                        <button class="btn-google" onclick="loginGoogle()">
                            <svg width="18" height="18" viewBox="0 0 48 48">
                                <path fill="#4285F4"
                                    d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
                                <path fill="#34A853"
                                    d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
                                <path fill="#FBBC05"
                                    d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
                                <path fill="#EA4335"
                                    d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
                            </svg>
                            使用 Google 登入
                        </button>
                    </div>
                    <div id="welcome-logged-in" style="display: none;">
                        <p>✅ 已登入為 <strong id="welcome-user-name"></strong></p>
                        <button class="btn-drive" id="btn-welcome-picker" onclick="openDrivePicker()"
                            style="display: none;">📂 選擇同步檔案</button>
                        <span id="welcome-file-status"></span>
                    </div>
                </div>

                <p style="font-size: 1.1rem; line-height: 1.6;">
                    系統已預載了一些真實的人類底層需求（如：紓解壓力、社交連結）。<br>
                    在開啟無邊界畫布之前，請先輸入 <strong>你想分析的第一個習慣</strong>！
                </p>
                <div style="text-align: left; margin-top: 30px;">
                    <label style="font-weight: bold;">1. 你真正的「底層需求 (Base Demand)」是什麼？</label>
                    <input type="text" id="init-demand" placeholder="例如：無聊想找刺激、肚子餓、獲得認同...">

                    <label style="margin-top: 20px; display: block; font-weight: bold;">2. 為了滿足這個需求，你通常的「習慣行動
                        (Action)」是？</label>
                    <input type="text" id="init-action" placeholder="例如：滑TikTok、喝手搖飲、咬指甲...">
                </div>
                <button class="primary" onclick="initFirstAction()"
                    style="margin-top: 35px; width: 100%; font-size: 1.2rem; padding: 15px;">
                    🚀 初始化資料並開始設定
                </button>
                <div style="margin-top: 30px; text-align: center; font-size: 0.85rem;">
                    <a href="privacy.html" target="_blank"
                        style="color: #666; text-decoration: none; margin: 0 10px;">隱私權政策 (Privacy Policy)</a> |
                    <a href="tos.html" target="_blank" style="color: #666; text-decoration: none; margin: 0 10px;">服務條款
                        (Terms of Service)</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= View 1: 無邊界畫布樹狀圖 ================= -->
    <div id="view-tree" class="view">
        <!-- 右上角 Auth Bar -->
        <div class="auth-bar" id="tree-auth-bar">
            <!-- More Options 放最左邊(第一個) -->
            <div class="more-options-wrapper">
                <button class="btn-more" onclick="toggleMoreMenu('tree-more-dropdown')" title="更多選項">☰</button>
                <div class="more-dropdown" id="tree-more-dropdown"></div>
            </div>
            <div id="tree-logged-out">
                <button class="btn-google" onclick="loginGoogle()" style="font-size: 0.85rem; padding: 8px 16px;">
                    🔐 登入
                </button>
            </div>
            <div id="tree-logged-in" style="display: none;">
                <div class="user-info">
                    <img class="user-avatar" id="tree-user-avatar" src="" alt="">
                    <span id="tree-user-name"></span>
                    <span class="sync-indicator" id="sync-dot" title="同步狀態"></span>
                </div>
                <button class="btn-drive" id="btn-tree-picker" onclick="openDrivePicker()" style="display: none;">📂
                    選擇檔案</button>
                <button class="btn-logout" onclick="logoutGoogle()">登出</button>
            </div>
        </div>

        <div class="canvas-ui-layer">
            <div style="position: relative;">
                <span id="info-toggle" onclick="toggleInfoPanel()"
                    style="cursor:pointer; position:absolute; left:-5px; top:2px; font-size:1rem; color:#999; user-select:none;">▼</span>
                <h2 style="margin: 0; color: var(--text-main); padding-left: 20px;">🧠 大腦行為決策樹</h2>
                <div id="info-panel" style="padding-left: 20px;">
                    <p
                        style="margin: 5px 0 0 0; color: var(--craving); font-size: 0.95rem; font-weight: bold; line-height: 1.8;">
                        按住滑鼠拖曳平移畫布，使用滾輪縮放。<br>
                        👑 = 長期CP最高的行動（理想選擇）。<br>
                        <span style="color:var(--bad);">■</span><span style="color:var(--good);">■</span> 色線 =
                        大腦預設執行的短期CP最高行動<br>
                        <span style="font-size:0.85rem;">（紅=長期有害，綠=長期有益）</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 無邊界畫布容器 -->
        <div class="tree-canvas-container" id="tree-canvas">
            <div class="tree-zoom-layer" id="tree-zoom-layer">
                <div id="tree-render-area">
                    <!-- Javascript 動態渲染 Real Tree -->
                </div>
            </div>
        </div>
    </div>

    <!-- ================= View 2: 四階段編輯器 ================= -->
    <div id="view-editor" class="view">
        <div class="container">
            <div class="editor-header">
                <button id="btn-back-tree" onclick="goToTree()" style="background: var(--cue); margin-bottom: 20px;">⬅️
                    返回畫布</button>
                <h2 id="editor-title">初始化 / 編輯習慣</h2>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label style="font-weight: bold;">行動名稱 (Action):</label>
                        <input type="text" id="action-name" placeholder="例如：抽菸、跑步、喝水...">
                    </div>
                </div>
                <p style="color: #7f8c8d; font-size: 1rem; margin-top: 15px; line-height: 1.6;">
                    💡 習慣養成取決於 4 個階段：<strong>提示 ➔ 渴望 ➔ 回應 ➔ 獎賞</strong>。<br>
                    💡 請將 CP 值物件拖曳到對應階段 (這不影響總分，但能幫助釐清問題)。<br>
                    💡 <strong style="color: var(--bad);">【系統防護機制】第二次檢視時，系統將強制要求：好習慣短期 CP > 0，壞習慣短期 CP < 0！</strong>
                </p>
            </div>

            <div class="token-creator">
                <input type="text" id="cp-name" placeholder="CP 變數名稱 (例：看到甜點、多巴胺分泌)" style="flex: 2; min-width: 250px;">
                <input type="number" id="cp-score" placeholder="分數 (+/-)" style="flex: 1; min-width: 120px;">
                <select id="cp-time" style="flex: 1; min-width: 180px;">
                    <option value="st">短期 CP (Short-term)</option>
                    <option value="lt">長期 CP (Long-term)</option>
                </select>
                <button class="primary" onclick="createCPToken()">➕ 建立 CP 物件</button>
            </div>

            <div id="token-dock" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event, 'dock')"
                ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                <span class="dock-hint" id="dock-hint-text">(剛建立、未分類的 CP 物件會放在這裡，請用滑鼠拖曳到下方四階段中)</span>
            </div>

            <div class="pipeline-container">
                <div class="stage-box" id="stage-cue">
                    <div style="color: var(--cue); font-weight: bold; text-align: center; font-size: 1.2rem;">1. 提示
                        (Cue)</div>
                    <div class="drop-zone" id="zone-cue" ondragover="allowDrop(event)" ondrop="drop(event, 'cue')"
                        ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
                <div class="stage-box" id="stage-craving">
                    <div style="color: var(--craving); font-weight: bold; text-align: center; font-size: 1.2rem;">2. 渴望
                        (Craving)</div>
                    <div class="drop-zone" id="zone-craving" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'craving')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    </div>
                </div>
                <div class="stage-box" id="stage-response">
                    <div style="color: var(--response); font-weight: bold; text-align: center; font-size: 1.2rem;">3. 回應
                        (Response)</div>
                    <div class="drop-zone" id="zone-response" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'response')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    </div>
                </div>
                <div class="stage-box" id="stage-reward">
                    <div style="color: var(--reward); font-weight: bold; text-align: center; font-size: 1.2rem;">4. 獎賞
                        (Reward)</div>
                    <div class="drop-zone" id="zone-reward" ondragover="allowDrop(event)" ondrop="drop(event, 'reward')"
                        ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
                </div>
            </div>

            <div class="score-board">
                <div style="display:flex; align-items:center; justify-content:center; gap:40px; flex-wrap:wrap;">
                    <!-- 短期 -->
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:2.5rem;">⚡</div>
                        <div style="color: var(--st-color); font-weight:bold; font-size:1.1rem;">短期總 CP</div>
                        <div style="font-size:1.8rem; font-weight:bold; color: var(--st-color);"><span
                                id="score-st">0</span></div>
                    </div>
                    <!-- 天平 -->
                    <div style="font-size:3rem;">⚖️</div>
                    <!-- 長期 -->
                    <div style="display:flex; flex-direction:column; align-items:center; position:relative;">
                        <div style="font-size:2.5rem;">🌱</div>
                        <div style="color: var(--lt-color); font-weight:bold; font-size:1.1rem;">長期總 CP</div>
                        <div style="font-size:1.8rem; font-weight:bold; color: var(--lt-color);"><span
                                id="score-lt">0</span></div>
                        <div id="lt-multiplier-wrapper"
                            style="position:absolute; top:calc(100% + 5px); left:50%; transform:translateX(-50%);">
                            <span id="lt-multiplier"
                                style="background:#f0f0f0; padding:4px 10px; border-radius:8px; font-size:0.9rem; font-weight:bold; color:#666; cursor:pointer; border:1px solid #ddd; white-space:nowrap;"
                                onclick="openSleepSliderModal()">× 0.1</span>
                        </div>
                    </div>
                    <!-- 最終評估 -->
                    <div style="font-size:1.2rem; font-weight:bold;">
                        大腦最終評估：<span id="score-final" style="font-size:1.5rem;">0</span>
                    </div>
                </div>
            </div>

            <div id="alert-box" class="alert-box"></div>
            <button class="success" onclick="saveAction()"
                style="width: 100%; font-size: 1.3rem; padding: 20px; margin-top: 10px;">💾 儲存並寫入大腦決策網路</button>
        </div>
    </div>

    <script>
        // =========================================================================
        // TOS & Privacy Policy Logic
        // =========================================================================
        function getTosAccepted() {
            return localStorage.getItem('brain_tos_accepted') === 'true';
        }

        async function setTosAccepted(accepted) {
            localStorage.setItem('brain_tos_accepted', accepted ? 'true' : 'false');
            handleTosUI();

            // 如果已登入，同步到後端
            if (currentUser) {
                try {
                    const res = await fetch(API_BASE + '/api/auth/me', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ tosAccepted: accepted })
                    });
                    if (!res.ok) throw new Error('同步 TOS 狀態失敗');
                    showToast('✅ 已將同意狀態同步至雲端', 'success');
                } catch (err) {
                    console.error('TOS sync error:', err);
                    showToast('⚠️ 無法同步同意狀態到雲端', 'error');
                }
            }
        }

        function handleTosCheckboxChange(checked) {
            setTosAccepted(checked);
        }

        function handleTosUI() {
            const accepted = getTosAccepted();
            const overlay = document.getElementById('tos-block-overlay');
            const checkbox = document.getElementById('tos-checkbox');
            const welcomeView = document.getElementById('view-welcome');
            const isWelcomeVisible = welcomeView && welcomeView.classList.contains('active');

            if (checkbox) checkbox.checked = accepted;

            // 如果已同意，隱藏遮罩
            if (accepted) {
                overlay.classList.remove('show');
                return;
            }

            // 如果未同意：
            // 1. 如果在畫布頁面 (Tree View)，必須顯示遮罩
            // 2. 如果在 Welcome 頁面且已登入，必須顯示遮罩 (強迫確認)
            // 3. 如果在 Welcome 頁面且未登入，不顯示遮罩 (因為 Welcome 頁面自有 Checkbox，且為了不擋住登入按鈕)
            if (!isWelcomeVisible || currentUser) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }

            const welcomeDropdown = document.getElementById('welcome-more-dropdown');
            const treeDropdown = document.getElementById('tree-more-dropdown');
            if (welcomeDropdown && welcomeDropdown.classList.contains('show')) buildMoreDropdown('welcome-more-dropdown');
            if (treeDropdown && treeDropdown.classList.contains('show')) buildMoreDropdown('tree-more-dropdown');
        }

        // =========================================================================
        // HTML 提示系統 (取代 alert)
        // =========================================================================
        function showToast(message, type = 'warning') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let icon = type === 'error' ? '🚨 ' : type === 'success' ? '✅ ' : '💡 ';
            toast.className = `toast ${type}`;
            toast.innerHTML = icon + message + `<span class="toast-close" onclick="this.parentElement.remove()">✕</span>`;
            container.appendChild(toast);
        }

        // Reusable modal: replaces confirm() and prompt()
        // Usage:
        //   const ok = await showModal({ title, message, confirmText, cancelText })           → returns true/false
        //   const val = await showModal({ title, message, inputPlaceholder, confirmText })    → returns string/null
        //   await showModal({ title, message, buttons: [{text, className, value}] })          → returns value
        function showModal(opts) {
            return new Promise(resolve => {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                const inputEl = document.getElementById('modal-input');
                const actionsEl = document.getElementById('modal-actions');

                titleEl.textContent = opts.title || '';
                msgEl.innerHTML = opts.message || '';

                // Input mode
                if (opts.inputPlaceholder !== undefined) {
                    inputEl.style.display = 'block';
                    inputEl.value = opts.inputDefault || '';
                    inputEl.placeholder = opts.inputPlaceholder;
                    setTimeout(() => inputEl.focus(), 100);
                } else {
                    inputEl.style.display = 'none';
                }

                function close(val) {
                    overlay.classList.remove('show');
                    resolve(val);
                }

                // Build buttons
                let btnsHTML = '';
                if (opts.buttons) {
                    opts.buttons.forEach((b, i) => {
                        btnsHTML += `<button class="${b.className || 'modal-btn-primary'}" id="modal-btn-${i}">${b.text}</button>`;
                    });
                } else {
                    const confirmText = opts.confirmText || '確定';
                    const cancelText = opts.cancelText || '取消';
                    const confirmClass = opts.danger ? 'modal-btn-danger' : 'modal-btn-primary';
                    btnsHTML = `<button class="modal-btn-cancel" id="modal-btn-cancel">${cancelText}</button>`;
                    btnsHTML += `<button class="${confirmClass}" id="modal-btn-confirm">${confirmText}</button>`;
                }
                actionsEl.innerHTML = btnsHTML;

                // Bind events
                if (opts.buttons) {
                    opts.buttons.forEach((b, i) => {
                        document.getElementById(`modal-btn-${i}`).onclick = () => close(b.value);
                    });
                } else {
                    document.getElementById('modal-btn-cancel').onclick = () => {
                        close(opts.inputPlaceholder !== undefined ? null : false);
                    };
                    document.getElementById('modal-btn-confirm').onclick = () => {
                        close(opts.inputPlaceholder !== undefined ? inputEl.value : true);
                    };
                }

                // Enter key for input mode
                if (opts.inputPlaceholder !== undefined) {
                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') close(inputEl.value);
                    };
                }

                overlay.classList.add('show');
            });
        }

        // =========================================================================
        // 無邊界畫布：滑鼠縮放與平移邏輯
        // =========================================================================
        const canvas = document.getElementById('tree-canvas');
        const zoomLayer = document.getElementById('tree-zoom-layer');
        let scale = 1;
        let panX = 0, panY = 0;
        let isDragging = false;
        let startX, startY;

        // 滑鼠滾輪：對準游標縮放
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSensitivity = 0.0015;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = scale * (1 + delta);
            newScale = Math.max(0.3, Math.min(newScale, 2.5)); // 限制縮放比例

            // 取得畫布邊界，計算滑鼠相對位置
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // 數學計算：確保縮放的中心點是滑鼠游標的位置
            panX = mouseX - (mouseX - panX) * (newScale / scale);
            panY = mouseY - (mouseY - panY) * (newScale / scale);
            scale = newScale;

            updateCanvasTransform();
        });

        // 滑鼠拖曳：平移
        canvas.addEventListener('mousedown', (e) => {
            // 如果點擊的是節點本身，則不觸發平移 (讓 click 事件生效)
            if (e.target.closest('.node-box')) return;
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            updateCanvasTransform();
        });

        window.addEventListener('mouseup', () => { isDragging = false; });

        // --- 手機觸控支援 ---
        let lastTouchDist = 0;
        let isPinching = false;

        canvas.addEventListener('touchstart', (e) => {
            if (e.target.closest('.node-box')) return;
            if (e.touches.length === 1) {
                // 單點：平移
                isDragging = true;
                isPinching = false;
                startX = e.touches[0].clientX - panX;
                startY = e.touches[0].clientY - panY;
            } else if (e.touches.length === 2) {
                // 兩點：縮放
                isDragging = false;
                isPinching = true;
                lastTouchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                panX = e.touches[0].clientX - startX;
                panY = e.touches[0].clientY - startY;
                updateCanvasTransform();
            } else if (isPinching && e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const zoomSensitivity = 0.005;
                const delta = (dist - lastTouchDist) * zoomSensitivity;
                let newScale = scale * (1 + delta);
                newScale = Math.max(0.3, Math.min(newScale, 2.5));

                // 縮放中心設為兩指中點
                const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const rect = canvas.getBoundingClientRect();
                const relX = midX - rect.left;
                const relY = midY - rect.top;

                panX = relX - (relX - panX) * (newScale / scale);
                panY = relY - (relY - panY) * (newScale / scale);
                scale = newScale;
                lastTouchDist = dist;
                updateCanvasTransform();
            }
        });

        canvas.addEventListener('touchend', () => {
            isDragging = false;
            isPinching = false;
        });
        canvas.addEventListener('touchcancel', () => {
            isDragging = false;
            isPinching = false;
        });

        function updateCanvasTransform() {
            zoomLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        }

        // 將視角重置置中
        function resetCanvasView() {
            scale = 1; panX = 50; panY = 100; // 預留一點上左邊距
            updateCanvasTransform();
        }

        // =========================================================================
        // 系統狀態與資料初始化
        // =========================================================================
        let humanTree = { name: "human", children: [] };
        let currentDemandId = null, currentActionId = null, currentTokens = [], draggedTokenId = null;
        let hasInitialized = false;

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        // 建立真實且有意義的預設資料，取代原本的 1-10
        function buildDefaultPythonTree() {
            const defaultData = [
                {
                    demand: "紓解工作壓力",
                    actions: [
                        { name: "抽菸", st: 15, lt: -80 },
                        { name: "吃高熱量宵夜", st: 10, lt: -40 },
                        { name: "深呼吸與冥想", st: 2, lt: 30 }
                    ]
                },
                {
                    demand: "獲得社交連結與認同",
                    actions: [
                        { name: "狂刷短影音與IG", st: 8, lt: -15 },
                        { name: "參加實體社群聚會", st: 5, lt: 40 }
                    ]
                }
            ];

            defaultData.forEach((d, i) => {
                let demandNode = { id: 'demand_def_' + i, name: d.demand, actions: [] };
                d.actions.forEach((a, j) => {
                    let finalCp = a.st + (a.lt * 0.1);
                    demandNode.actions.push({
                        id: `action_def_${i}_${j}`, name: a.name, cp: finalCp, st: a.st, lt: a.lt, isNew: false, tokens: []
                    });
                });
                humanTree.children.push(demandNode);
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            // 切換 Body 的 Overflow 防止畫面錯位
            if (viewId === 'view-tree') { document.body.style.overflow = 'hidden'; }
            else { document.body.style.overflow = 'auto'; }
        }

        function initApp() {
            if (!hasInitialized) switchView('view-welcome');
            else {
                renderTree();
                switchView('view-tree');
                resetCanvasView();
                checkDailySleepPrompt(); // 問今天有沒有熬夜
            }
            handleTosUI();
        }

        function initFirstAction() {
            if (!getTosAccepted()) return showToast("⚠️ 請先勾選同意隱私權政策與服務條款！", "error");

            let demandInput = document.getElementById('init-demand').value.trim();
            let actionInput = document.getElementById('init-action').value.trim();

            if (!demandInput || !actionInput) return showToast("請完整填寫需求與行動！", "error");

            buildDefaultPythonTree();

            let newDemandId = generateId(), newActionId = generateId();
            humanTree.children.unshift({
                id: newDemandId, name: demandInput, actions: [{ id: newActionId, name: actionInput, cp: 0, st: 0, lt: 0, isNew: true, tokens: [] }]
            });

            hasInitialized = true;
            document.getElementById('btn-back-tree').style.display = 'none';
            openEditor(newDemandId, newActionId);
        }

        async function addBaseDemand() {
            const name = await showModal({
                title: '➕ 新增底層需求',
                message: '請輸入新的底層需求名稱',
                inputPlaceholder: '例如：逃避現實、尋求刺激',
                confirmText: '新增',
            });
            if (name && name.trim()) {
                humanTree.children.push({ id: generateId(), name: name.trim(), actions: [] });
                renderTree();
                syncToDrive('addBaseDemand');
            }
        }

        // =========================================================================
        // View 1: 實體樹狀圖渲染邏輯 (無邊界畫布)
        // =========================================================================
        async function deleteNode(demandId, actionId, event) {
            event.stopPropagation();
            let demand = humanTree.children.find(d => d.id === demandId);
            if (actionId) {
                let action = demand.actions.find(a => a.id === actionId);
                const ok = await showModal({
                    title: '🗑️ 刪除行動',
                    message: `確定要刪除行動「<strong>${action.name}</strong>」嗎？`,
                    confirmText: '刪除',
                    danger: true,
                });
                if (ok) {
                    demand.actions = demand.actions.filter(a => a.id !== actionId);
                    renderTree();
                    showToast('行動已刪除', 'success');
                    syncToDrive('deleteNode');
                }
            } else {
                let childCount = demand.actions.length;
                let msg = `確定要刪除需求「<strong>${demand.name}</strong>」`;
                if (childCount > 0) msg += `及其下 <strong>${childCount}</strong> 個行動方案`;
                msg += '嗎？';
                const ok = await showModal({
                    title: '🗑️ 刪除需求',
                    message: msg,
                    confirmText: '全部刪除',
                    danger: true,
                });
                if (ok) {
                    humanTree.children = humanTree.children.filter(d => d.id !== demandId);
                    renderTree();
                    showToast('底層需求已刪除', 'success');
                    syncToDrive('deleteNode');
                }
            }
        }

        function renderTree() {
            let renderArea = document.getElementById('tree-render-area');
            if (humanTree.children.length === 0) return renderArea.innerHTML = "<h2 style='color:#999;'>畫布上目前空無一物...</h2>";

            let html = `<ul class="tree"><li>
            <div class="node-box root-node has-children"><strong>Human (大腦)</strong><br><small>預設尋求高性價比</small></div><ul>`;

            // Use the global multiplier for on-the-fly calculation
            const currentLtMultiplier = ltMultiplier;

            humanTree.children.forEach(demand => {
                // Calculate dynamic CP and sort
                demand.actions.forEach(a => {
                    a._dynamicCp = a.st + (a.lt * currentLtMultiplier);
                });
                demand.actions.sort((a, b) => b._dynamicCp - a._dynamicCp); // 降冪排序（顯示用）

                let hasActions = demand.actions.length > 0;

                // 找出長期CP最高的 action (理想選擇 👑)
                let bestLtIdx = -1;
                if (hasActions) {
                    let maxLt = -Infinity;
                    demand.actions.forEach((a, i) => { if (a.lt > maxLt) { maxLt = a.lt; bestLtIdx = i; } });
                }

                // 找出短期CP最高(預期大腦執行的) action，但因為已經以 dynamicCp 排序，
                // 短期CP最高的也可能隨 multiplier 改變。這裡維持找 st 最高者為大腦預設。
                let bestStIdx = -1;
                if (hasActions) {
                    let maxSt = -Infinity;
                    demand.actions.forEach((a, i) => { if (a.st > maxSt) { maxSt = a.st; bestStIdx = i; } });
                }

                html += `<li><div class="node-box demand-node ${hasActions ? "has-children" : ""}">
                        <span class="node-delete-x" onclick="deleteNode('${demand.id}', null, event)">✕</span>
                        <strong>Demand: <br>${demand.name}</strong>
                     </div><ul>`;

                const totalItems = demand.actions.length + 1; // actions + add button
                const midIdx = (totalItems - 1) / 2; // Exact vertical center of the <ul> where parent line connects

                demand.actions.forEach((act, j) => {
                    let cpColor = act._dynamicCp >= 0 ? 'var(--good)' : 'var(--bad)';
                    let ltClass = act.lt < 0 ? 'lt-negative' : (act.lt > 0 ? 'lt-positive' : '');
                    const isCrown = (j === bestLtIdx);
                    const isStDefault = (j === bestStIdx);
                    const stColor = bestStIdx >= 0 ? (demand.actions[bestStIdx].lt <= 0 ? 'red' : 'green') : '';
                    const stLineClass = isStDefault ? `st-default-line-${stColor}` : '';

                    const y1 = Math.min(midIdx, bestStIdx);
                    const y2 = Math.max(midIdx, bestStIdx);

                    const overlapStart = Math.max(j - 0.5, y1);
                    const overlapEnd = Math.min(j + 0.5, y2);
                    const inStPath = (overlapStart < overlapEnd && bestStIdx >= 0);

                    let overlayClass = '';
                    if (inStPath) {
                        overlayClass = stColor;
                        if (overlapStart > j - 0.5) overlayClass += ' start'; // Crop top half (start from middle down)
                        if (overlapEnd < j + 0.5) overlayClass += ' end';     // Crop bottom half (start from middle up)
                    }

                    const isBoth = isCrown && isStDefault;
                    const bestClass = isBoth ? 'best-action-label up' : 'best-action-label';
                    const stLabelBad = isStDefault && demand.actions[bestStIdx].lt <= 0;
                    const stClass = isBoth ? `st-default-label down ${stLabelBad ? 'bad' : 'good'}` : `st-default-label ${stLabelBad ? 'bad' : 'good'}`;

                    html += `<li class="${stLineClass}">`;
                    if (inStPath) html += `<div class="st-vert-overlay ${overlayClass}"></div>`;
                    html += `<div class="node-box action-node ${ltClass}" onclick="openEditor('${demand.id}', '${act.id}')">
                                <span class="node-delete-x" onclick="deleteNode('${demand.id}', '${act.id}', event)">✕</span>
                                ${isCrown ? `<div class="cp-crown">👑</div><div class="${bestClass}">長期最佳解 ➡</div>` : ''}
                                ${isStDefault ? `<div class="${stClass}">大腦預設 ➡</div>` : ''}
                                <strong>${act.name}</strong><div class="action-cp-text" style="color: ${cpColor};">當下體感 CP: ${act._dynamicCp.toFixed(2)}</div>
                            </div></li>`;
                });

                // Also check if the 'Add Action' button itself is part of the colored path
                const addBtnIdx = demand.actions.length;
                const y1 = Math.min(midIdx, bestStIdx);
                const y2 = Math.max(midIdx, bestStIdx);
                const overlapStartAdd = Math.max(addBtnIdx - 0.5, y1);
                const overlapEndAdd = Math.min(addBtnIdx + 0.5, y2);
                const inStPathAddBtn = (overlapStartAdd < overlapEndAdd && bestStIdx >= 0);

                let addBtnOverlay = '';
                if (inStPathAddBtn) {
                    const stColor = demand.actions[bestStIdx].lt <= 0 ? 'red' : 'green';
                    let overlayClass = stColor;
                    if (overlapStartAdd > addBtnIdx - 0.5) overlayClass += ' start';
                    if (overlapEndAdd < addBtnIdx + 0.5) overlayClass += ' end';
                    addBtnOverlay = `<div class="st-vert-overlay ${overlayClass}"></div>`;
                }

                html += `<li>${addBtnOverlay}<div class="node-box add-node" onclick="openEditor('${demand.id}', null)">➕ 新增行動方案</div></li></ul></li>`;
            });
            html += `<li><div class="node-box add-node" onclick="addBaseDemand()">➕ 新增底層需求</div></li></ul></li></ul>`;
            renderArea.innerHTML = html;
        }

        // =========================================================================
        // View 2: 四階段編輯器 (init_action_of_base_demand)
        // =========================================================================
        function openEditor(dId, aId) {
            currentDemandId = dId; currentActionId = aId; currentTokens = [];
            document.getElementById('alert-box').style.display = 'none';
            if (hasInitialized) document.getElementById('btn-back-tree').style.display = 'inline-block';

            ['zone-cue', 'zone-craving', 'zone-response', 'zone-reward', 'token-dock'].forEach(id => {
                Array.from(document.getElementById(id).children).forEach(c => { if (c.classList.contains('cp-token')) c.remove(); });
            });
            checkDockHint();

            if (aId !== null) {
                let action = humanTree.children.find(d => d.id === dId).actions.find(a => a.id === aId);
                document.getElementById('editor-title').innerText = `編輯習慣：${action.name}`;
                document.getElementById('action-name').value = action.name;
                currentTokens = JSON.parse(JSON.stringify(action.tokens));
                currentTokens.forEach(t => renderToken(t));
            } else {
                document.getElementById('editor-title').innerText = `為此需求建立新習慣`;
                document.getElementById('action-name').value = '';
            }
            updateScores();
            switchView('view-editor');
        }

        function goToTree() { initApp(); }

        function createCPToken() {
            let nameInput = document.getElementById('cp-name').value.trim();
            let scoreInput = parseFloat(document.getElementById('cp-score').value);
            if (!nameInput || isNaN(scoreInput)) return showToast("請填寫完整的名稱與分數！", "error");

            let newToken = { id: 'token_' + generateId(), name: nameInput, score: scoreInput, timeType: document.getElementById('cp-time').value, stage: 'dock' };
            currentTokens.push(newToken);
            renderToken(newToken);

            document.getElementById('cp-name').value = ''; document.getElementById('cp-score').value = '';
            updateScores();
        }

        function renderToken(token) {
            let el = document.createElement('div');
            el.className = `cp-token ${token.timeType === 'st' ? 'st-token' : 'lt-token'}`;
            el.id = token.id; el.draggable = true;
            el.innerHTML = `<span>${token.name} (${token.score > 0 ? '+' + token.score : token.score})</span><span class="token-del" onclick="deleteToken('${token.id}')">✖</span>`;

            el.addEventListener('dragstart', () => { draggedTokenId = token.id; setTimeout(() => el.style.opacity = '0.5', 0); });
            el.addEventListener('dragend', () => el.style.opacity = '1');

            // 手機觸控拖動
            el.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) return;
                draggedTokenId = token.id;
                el.style.opacity = '0.5';
                el._touchStartX = e.touches[0].clientX;
                el._touchStartY = e.touches[0].clientY;
            }, { passive: true });

            el.addEventListener('touchmove', (e) => {
                if (!draggedTokenId) return;
                // 我們不需要移動元素，只需要在結束時判斷位置
            }, { passive: true });

            el.addEventListener('touchend', (e) => {
                if (draggedTokenId === token.id) {
                    el.style.opacity = '1';
                    const touch = e.changedTouches[0];
                    const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropZone = targetEl ? targetEl.closest('.drop-zone') : null;
                    if (dropZone) {
                        const zoneId = dropZone.id.replace('zone-', '');
                        drop({ preventDefault: () => { } }, zoneId === 'token-dock' ? 'dock' : zoneId);
                    }
                    draggedTokenId = null;
                }
            });

            document.getElementById(token.stage === 'dock' ? 'token-dock' : `zone-${token.stage}`).appendChild(el);
            checkDockHint();
        }

        function deleteToken(tokenId) {
            currentTokens = currentTokens.filter(t => t.id !== tokenId);
            document.getElementById(tokenId).remove();
            updateScores();
            checkDockHint();
        }

        function checkDockHint() {
            let dock = document.getElementById('token-dock');
            let hint = document.getElementById('dock-hint-text');
            // 如果 dock 裡面除了 hint 還有其他 token，就隱藏 hint
            if (dock.querySelectorAll('.cp-token').length > 0) hint.style.display = 'none';
            else hint.style.display = 'block';
        }

        function allowDrop(ev) { ev.preventDefault(); }
        function dragEnter(ev) { ev.currentTarget.classList.add('dragover'); }
        function dragLeave(ev) { ev.currentTarget.classList.remove('dragover'); }

        function drop(ev, targetStage) {
            ev.preventDefault(); ev.currentTarget.classList.remove('dragover');
            if (draggedTokenId !== null) {
                ev.currentTarget.appendChild(document.getElementById(draggedTokenId));
                let tokenData = currentTokens.find(t => t.id === draggedTokenId);
                if (tokenData) tokenData.stage = targetStage;
                draggedTokenId = null;
                checkDockHint();
            }
        }

        let ltMultiplier = parseFloat(localStorage.getItem('brain_lt_multiplier')) || 0.1;

        // Initialize display value on load
        document.addEventListener('DOMContentLoaded', () => {
            const m = parseFloat(localStorage.getItem('brain_lt_multiplier')) || 0.1;
            document.getElementById('lt-multiplier').textContent = `× ${m}`;
            handleTosUI();
        });

        function toggleInfoPanel() {
            const panel = document.getElementById('info-panel');
            const toggle = document.getElementById('info-toggle');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = '▼';
            } else {
                panel.style.display = 'none';
                toggle.textContent = '▶';
            }
        }

        async function openSleepSliderModal() {
            // Reusable modal with exact HTML for slider
            const html = `
                <div style="text-align:center; padding-top: 10px;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">最近 7 天，你睡最少的那天睡了幾個小時？</p>
                    <input type="range" id="modal-sleep-range" min="0" max="14" step="0.5" value="7" oninput="document.getElementById('modal-sleep-val').innerText = this.value + ' 小時'" style="width: 80%; cursor: pointer;">
                    <p id="modal-sleep-val" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 15px 0;">7 小時</p>
                </div>
            `;
            const hoursStr = await showModal({
                title: '🌙 每日睡眠狀態確認',
                message: html,
                confirmText: '確定',
                cancelText: '取消'
            });

            if (hoursStr) {
                // Determine hours from the DOM (since modal resolves when clicking enter/confirm)
                // Unfortunately showModal only resolves `true` or `inputEl.value`. We can read the DOM before it closes, 
                // but the cleanest way is just to grab it by ID if it's still there. Actually `showModal` hides the overlay when done but elements remain until overwritten.
            }
            // To make this robust, we should create a custom implementation or extract value.
        }

        async function checkDailySleepPrompt() {
            const today = new Date().toISOString().slice(0, 10);
            const lastSleepDate = localStorage.getItem('brain_sleep_date');

            if (lastSleepDate !== today) {
                await doSleepSliderFlow();
                localStorage.setItem('brain_sleep_date', today);
            }
        }

        async function doSleepSliderFlow() {
            const html = `
                <div style="text-align:center; padding-top: 10px;">
                    <p style="font-size: 1.1rem; margin-bottom: 20px;">最近 7 天，你睡最少的那天睡了幾個小時？</p>
                    <input type="range" id="modal-sleep-range" min="0" max="14" step="0.5" value="7" oninput="document.getElementById('modal-sleep-val').innerText = this.value + ' 小時'" style="width: 80%; cursor: pointer;">
                    <p id="modal-sleep-val" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 15px 0;">7 小時</p>
                </div>
            `;
            const ok = await showModal({
                title: '🌙 每日睡眠狀態確認',
                message: html,
                buttons: [
                    { text: '😴 確實有熬夜 (Yes)', className: 'modal-btn-danger', value: 'yes' },
                    { text: '😊 沒有熬夜 (No)', className: 'modal-btn-primary', value: 'no' }
                ]
            });

            if (ok) {
                const hours = parseFloat(document.getElementById('modal-sleep-range').value);
                setSleepFromHours(hours, ok);
            }
        }

        // We override openSleepSliderModal to reuse doSleepSliderFlow
        function openSleepSliderModal() {
            doSleepSliderFlow();
        }

        function setSleepFromHours(hours, choice) {
            const isStayedUp = (choice === 'yes') || (hours < 6);
            ltMultiplier = isStayedUp ? 0.01 : 0.2;
            localStorage.setItem('brain_lt_multiplier', ltMultiplier.toString());

            const multEl = document.getElementById('lt-multiplier');
            if (multEl) multEl.textContent = `× ${ltMultiplier}`;

            updateScores();
            if (document.getElementById('view-tree').classList.contains('active')) {
                renderTree(); // refresh canvas if we are viewing it
            }

            let msg = '';
            let toastType = 'success';
            if (isStayedUp) {
                toastType = 'error';
                if (choice === 'yes') {
                    msg = '😴 熬夜模式：你表示有熬夜。大腦判斷力下降，長期CP影響力降至最低 (× 0.01)';
                } else {
                    msg = `😴 熬夜模式：睡眠時數不足 (${hours} 小時 < 6 小時)。大腦判斷力下降，長期CP影響力降至最低 (× 0.01)`;
                }
            } else {
                msg = '😊 精神飽滿：大腦紀律維持，長期CP影響力提升 (× 0.2)';
            }
            showToast(msg, toastType);
        }

        function updateScores() {
            let stSum = currentTokens.filter(t => t.timeType === 'st').reduce((sum, t) => sum + t.score, 0);
            let ltSum = currentTokens.filter(t => t.timeType === 'lt').reduce((sum, t) => sum + t.score, 0);
            let finalCp = stSum + (ltSum * ltMultiplier);

            document.getElementById('score-st').innerText = stSum;
            document.getElementById('score-lt').innerText = ltSum;
            document.getElementById('score-final').innerText = finalCp.toFixed(2);
            return { st: stSum, lt: ltSum, final: finalCp };
        }

        // =========================================================================
        // 儲存與強制防護邏輯 (第二次編輯時強行校正)
        // =========================================================================
        function saveAction() {
            let actionNameInput = document.getElementById('action-name').value.trim();
            if (!actionNameInput) return showToast("請填寫行動名稱！", "error");

            let scores = updateScores();
            let demand = humanTree.children.find(d => d.id === currentDemandId);
            let isGoodHabit = (scores.lt >= 0);

            let existingAction = currentActionId !== null ? demand.actions.find(a => a.id === currentActionId) : null;
            let isNewAction = existingAction !== null ? existingAction.isNew : true;
            let alertBox = document.getElementById('alert-box');

            // 第二次看見 -> 強制防護機制 (HTML 框框呈現)
            if (!isNewAction) {
                if (isGoodHabit && scores.st <= 0) {
                    alertBox.className = 'alert-box';
                    alertBox.innerHTML = `🚨【系統防護攔截】這是一個「好習慣 (長期 >= 0)」！<br>
                你的短期 CP 目前是 ${scores.st}。<br>
                大腦是短視的，如果短期痛苦沒有獎勵，大腦就會放棄！<br>
                👉 <b>請強制加入「短期的正面 CP (獎賞)」，讓短期 CP > 0！</b>`;
                    alertBox.style.display = 'block';
                    return;
                } else if (!isGoodHabit && scores.st >= 0) {
                    alertBox.className = 'alert-box';
                    alertBox.innerHTML = `🚨【系統防護攔截】這是一個「壞習慣 (長期 < 0)」！<br>
                你的短期 CP 目前是 ${scores.st}。<br>
                只要短期 CP 還是正的，你的大腦就會覺得性價比很高而繼續做！<br>
                👉 <b>請強制加入「短期的負面 CP (摩擦力/懲罰)」，讓短期 CP < 0！</b>`;
                    alertBox.style.display = 'block';
                    return;
                }
            } else {
                // 第一次 -> Toast 提醒但不阻擋
                if (isGoodHabit && scores.st <= 0) {
                    showToast("【系統提示】你正在建立好習慣，但短期 CP 尚未大於 0。大腦很容易放棄喔！(下次編輯將強制修正)", "warning");
                } else if (!isGoodHabit && scores.st >= 0) {
                    showToast("【系統提示】你正在紀錄壞習慣，但短期 CP 還是正的。大腦還是會繼續這個迴路！(下次編輯將強制修正)", "warning");
                }
            }

            alertBox.style.display = 'none';

            if (existingAction !== null) {
                existingAction.name = actionNameInput; existingAction.st = scores.st; existingAction.lt = scores.lt;
                existingAction.cp = scores.final; existingAction.tokens = currentTokens; existingAction.isNew = false;
            } else {
                demand.actions.push({ id: generateId(), name: actionNameInput, st: scores.st, lt: scores.lt, cp: scores.final, tokens: currentTokens, isNew: false });
            }

            showToast("已成功寫入大腦決策網路！", "success");
            syncToDrive('saveAction');
            initApp();
        }

        // =========================================================================
        // Storage Mode & Local Persistence
        // =========================================================================
        const STORAGE_KEY_TREE = 'brain_tree_data';
        const STORAGE_KEY_MODE = 'brain_storage_mode';
        const STORAGE_KEY_INIT = 'brain_has_initialized';
        const STORAGE_KEY_SAVE_DATE = 'brain_last_save_date';

        // Loading overlay helpers
        function updateLoadingStatus(text) {
            const el = document.getElementById('loading-status');
            if (el) el.textContent = text;
        }
        function hideLoadingOverlay() {
            const el = document.getElementById('loading-overlay');
            if (el) { el.classList.add('hidden'); setTimeout(() => el.remove(), 500); }
        }
        function isFirstTimeUser() {
            return !localStorage.getItem(STORAGE_KEY_MODE)
                && !localStorage.getItem(STORAGE_KEY_TREE)
                && !localStorage.getItem('brain_session_token');
        }

        // Storage mode: 'local' | 'drive' | 'both'
        // Default: 'local' (no login) or 'both' (logged in)
        function getStorageMode() {
            return localStorage.getItem(STORAGE_KEY_MODE) || 'local';
        }
        function setStorageMode(mode) {
            localStorage.setItem(STORAGE_KEY_MODE, mode);
            updateMoreDropdowns();
        }

        // Save humanTree to localStorage
        function saveToLocal() {
            try {
                const data = JSON.stringify({
                    humanTree: serializeTreeForSync(),
                    hasInitialized,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem(STORAGE_KEY_TREE, data);
                localStorage.setItem(STORAGE_KEY_INIT, hasInitialized ? '1' : '0');
            } catch (e) {
                showToast('⚠️ 本機儲存空間不足，請清理瀏覽器資料', 'error');
            }
        }

        // Load humanTree from localStorage
        function loadFromLocal() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_TREE);
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (data && data.humanTree) return data.humanTree;
            } catch (e) { /* ignore parse errors */ }
            return null;
        }

        // Restore humanTree from a serialized tree object
        function restoreTreeFromSerialized(saved) {
            if (!saved || !saved.children || saved.children.length === 0) return false;
            const stageNames = ['dock', 'cue', 'craving', 'response', 'reward'];
            humanTree = {
                name: saved.name || 'human',
                children: saved.children.map(demand => ({
                    id: demand.id,
                    name: demand.name,
                    actions: (demand.actions || []).map(action => {
                        const tokens = [];
                        if (action.tokenSlots) {
                            action.tokenSlots.forEach((slot, idx) => {
                                (slot || []).forEach(t => {
                                    tokens.push({
                                        id: t.id, name: t.name, score: t.score,
                                        timeType: t.timeType, stage: stageNames[idx] || 'dock',
                                    });
                                });
                            });
                        } else if (action.tokens) {
                            action.tokens.forEach(t => tokens.push({ ...t }));
                        }
                        return {
                            id: action.id, name: action.name, cp: action.cp,
                            st: action.st, lt: action.lt, isNew: action.isNew, tokens,
                        };
                    }),
                })),
            };
            hasInitialized = true;
            return true;
        }

        // =========================================================================
        // Google Auth + Drive Sync (Token-based for cross-domain)
        // =========================================================================
        const API_BASE = 'https://addiction-murex.vercel.app';
        let currentUser = null;

        // Capture token from URL after OAuth callback
        (function captureTokenFromURL() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                localStorage.setItem('brain_session_token', token);
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        })();

        function authHeaders() {
            const token = localStorage.getItem('brain_session_token');
            const headers = {};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            return headers;
        }

        function loginGoogle() {
            window.location.href = API_BASE + '/api/auth/google';
        }

        async function logoutGoogle() {
            await fetch(API_BASE + '/api/auth/logout', {
                method: 'POST', headers: authHeaders(),
            });
            localStorage.removeItem('brain_session_token');
            currentUser = null;
            setStorageMode('local');
            updateAuthUI();
            showToast('已登出', 'success');
        }

        async function checkAuth() {
            updateLoadingStatus('⏳ 正在檢查登入狀態...');
            const token = localStorage.getItem('brain_session_token');

            // ===== First-time user: hide overlay and let welcome page handle =====
            if (isFirstTimeUser()) {
                hideLoadingOverlay();
                updateAuthUI();
                updateMoreDropdowns();
                return;
            }

            // ===== No token: use local only =====
            if (!token) {
                currentUser = null;
                if (!localStorage.getItem(STORAGE_KEY_MODE)) setStorageMode('local');
                updateLoadingStatus('📂 正在載入本機資料...');
                const localTree = loadFromLocal();
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('📂 已從本機載入資料', 'success');
                }
                updateAuthUI();
                updateMoreDropdowns();
                hideLoadingOverlay();
                return;
            }

            // ===== Has token: try to authenticate =====
            updateLoadingStatus('🔐 正在驗證登入身分...');
            try {
                const res = await fetch(API_BASE + '/api/auth/me', { headers: authHeaders() });
                const data = await res.json();
                if (data.loggedIn) {
                    currentUser = data.user;
                    // 同步 TOS 狀態
                    const localAccepted = getTosAccepted();
                    if (currentUser.tosAccepted) {
                        // DB 說好 -> 本地也設為好
                        if (!localAccepted) {
                            localStorage.setItem('brain_tos_accepted', 'true');
                        }
                    } else if (localAccepted) {
                        // 本地說好但 DB 說不 (可能是剛登入的新使用者在 Welcome 頁勾選了) -> 同步回 DB
                        setTosAccepted(true);
                    }

                    const savedMode = localStorage.getItem(STORAGE_KEY_MODE);
                    if (!savedMode || savedMode === 'local') {
                        setStorageMode('both');
                    }
                } else {
                    currentUser = null;
                }
            } catch (err) {
                currentUser = null;
            }

            updateAuthUI();
            updateMoreDropdowns();
            handleTosUI(); // 確保 UI 狀態正確反映最終同步結果

            // ===== Load data based on mode =====
            const mode = getStorageMode();
            updateLoadingStatus('📂 正在載入本機資料...');
            const localTree = loadFromLocal();
            let driveTree = null;

            // Try to load Drive data if logged in and has file
            if (currentUser && currentUser.hasDriveFile && mode !== 'local') {
                updateLoadingStatus('☁️ 正在載入雲端資料...');
                try {
                    const res = await fetch(API_BASE + '/api/load-from-drive', { headers: authHeaders() });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.data && data.data.treeData) {
                            driveTree = data.data.treeData;
                        }
                    }
                } catch (err) { /* ignore */ }
            }

            updateLoadingStatus('🔄 正在比對資料...');

            if (mode === 'local') {
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('📂 已從本機載入資料', 'success');
                }
            } else if (mode === 'drive') {
                if (driveTree) {
                    restoreTreeFromSerialized(driveTree);
                    saveToLocal();
                    initApp();
                    showToast('☁️ 已從 Google Drive 載入資料', 'success');
                } else if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('📂 雲端資料不可用，已從本機載入', 'success');
                }
            } else {
                // mode === 'both' → compare local and Drive
                if (localTree && driveTree) {
                    const localStr = JSON.stringify(localTree);
                    const driveStr = JSON.stringify(driveTree);
                    if (localStr !== driveStr) {
                        hideLoadingOverlay();
                        showConflictDialog(localTree, driveTree, '📂 本機版本', '☁️ Google Drive 版本', 'auto');
                        return;
                    }
                }
                // Same or only one exists
                if (driveTree) {
                    restoreTreeFromSerialized(driveTree);
                    saveToLocal();
                    initApp();
                    showToast('☁️ 已從 Google Drive 載入資料', 'success');
                } else if (localTree) {
                    restoreTreeFromSerialized(localTree);
                    initApp();
                    showToast('📂 已從本機載入資料', 'success');
                }
            }

            // If logged in but no Drive file
            if (!hasInitialized && currentUser && !currentUser.hasDriveFile) {
                if (localTree && restoreTreeFromSerialized(localTree)) {
                    initApp();
                    showToast('📂 已從本機載入資料', 'success');
                }
            }

            hideLoadingOverlay();
        }

        function updateAuthUI() {
            // Welcome page
            const wLoggedOut = document.getElementById('welcome-logged-out');
            const wLoggedIn = document.getElementById('welcome-logged-in');
            const wUserName = document.getElementById('welcome-user-name');
            const wFileStatus = document.getElementById('welcome-file-status');
            const wPicker = document.getElementById('btn-welcome-picker');

            // Tree page
            const tLoggedOut = document.getElementById('tree-logged-out');
            const tLoggedIn = document.getElementById('tree-logged-in');
            const tUserName = document.getElementById('tree-user-name');
            const tAvatar = document.getElementById('tree-user-avatar');
            const tPicker = document.getElementById('btn-tree-picker');

            if (currentUser) {
                wLoggedOut.style.display = 'none';
                wLoggedIn.style.display = 'block';
                wUserName.textContent = currentUser.name;
                if (currentUser.hasDriveFile) {
                    wFileStatus.textContent = '📁 已設定同步檔案';
                    wPicker.style.display = 'inline-block';
                    wPicker.textContent = '📂 更換同步檔案';
                } else {
                    wFileStatus.textContent = '';
                    wPicker.style.display = 'inline-block';
                    wPicker.textContent = '📂 選擇同步檔案';
                }
                tLoggedOut.style.display = 'none';
                tLoggedIn.style.display = 'flex';
                tUserName.textContent = currentUser.name;
                tAvatar.src = currentUser.picture || '';
                tAvatar.style.display = currentUser.picture ? 'block' : 'none';
                tPicker.style.display = currentUser.hasDriveFile ? 'none' : 'inline-block';
            } else {
                wLoggedOut.style.display = 'block';
                wLoggedIn.style.display = 'none';
                tLoggedOut.style.display = 'block';
                tLoggedIn.style.display = 'none';
            }
        }

        // =========================================================================
        // Conflict Resolution
        // =========================================================================
        function treePreviewHTML(tree) {
            if (!tree || !tree.children || tree.children.length === 0) {
                return '<div style="color:#999;">（無資料）</div>';
            }
            let html = '';
            tree.children.forEach(d => {
                html += `<div class="demand-item">🔹 ${d.name}</div>`;
                (d.actions || []).forEach(a => {
                    const cp = typeof a.cp === 'number' ? a.cp.toFixed(2) : '?';
                    html += `<div class="action-item">├ ${a.name} (CP: ${cp})</div>`;
                });
            });
            return html;
        }

        // conflictSource: 'auto' (page load), 'importLocal', 'importDrive'
        let pendingConflictLeft = null;
        let pendingConflictRight = null;
        let pendingConflictSource = null;

        function generateFileName() {
            const now = new Date();
            const ts = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            return `addiction-log-export-${ts}.json`;
        }

        function showConflictDialog(leftTree, rightTree, leftTitle, rightTitle, source) {
            pendingConflictLeft = leftTree;
            pendingConflictRight = rightTree;
            pendingConflictSource = source;
            document.getElementById('conflict-left-title').textContent = leftTitle;
            document.getElementById('conflict-right-title').textContent = rightTitle;
            document.getElementById('conflict-btn-left').textContent = `📂 使用${leftTitle.replace(/[^\u4e00-\u9fff\w\s]/g, '').trim()}`;
            document.getElementById('conflict-btn-right').textContent = `☁️ 使用${rightTitle.replace(/[^\u4e00-\u9fff\w\s]/g, '').trim()}`;
            document.getElementById('conflict-local-preview').innerHTML = treePreviewHTML(leftTree);
            document.getElementById('conflict-drive-preview').innerHTML = treePreviewHTML(rightTree);
            document.getElementById('conflict-overlay').classList.add('show');
        }

        async function resolveConflict(choice) {
            document.getElementById('conflict-overlay').classList.remove('show');

            const chosenTree = choice === 'left' ? pendingConflictLeft : pendingConflictRight;

            if (!chosenTree) {
                showToast('⚠️ 所選版本資料為空', 'error');
                return;
            }

            // Restore the chosen version
            restoreTreeFromSerialized(chosenTree);
            saveToLocal();
            initApp();

            // Create new Drive file (because import diff → new file)
            const mode = getStorageMode();
            if ((mode === 'drive' || mode === 'both') && currentUser) {
                try {
                    const fileName = generateFileName();
                    const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ fileName }),
                    });
                    const createData = await createRes.json();
                    if (createData.success) {
                        currentUser.hasDriveFile = true;
                        updateAuthUI();
                        await syncToDriveInternal('conflict_resolve');
                        localStorage.setItem(STORAGE_KEY_SAVE_DATE, new Date().toISOString().slice(0, 10));
                        showToast('✅ 已建立新版本並同步至 Google Drive', 'success');
                    } else {
                        if (createRes.status === 402 || createRes.status === 403) {
                            showToast('⚠️ Google Drive 空間不足，無法建立檔案', 'error');
                        } else {
                            showToast('⚠️ 建立雲端檔案失敗：' + (createData.error || '未知錯誤'), 'error');
                        }
                    }
                } catch (err) {
                    showToast('⚠️ 雲端操作失敗：' + err.message, 'error');
                }
            }

            showToast('💡 我們不會刪除您的任何檔案，所有舊檔案都保留在原處，您可自行管理。', 'warning');
            pendingConflictLeft = null;
            pendingConflictRight = null;
            pendingConflictSource = null;
        }

        // =========================================================================
        // Load / Sync to Drive
        // =========================================================================
        async function loadTreeFromDrive() {
            try {
                const res = await fetch(API_BASE + '/api/load-from-drive', { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();
                if (data.success && data.data && data.data.treeData) {
                    if (restoreTreeFromSerialized(data.data.treeData)) {
                        saveToLocal();
                        initApp();
                        showToast('☁️ 已從 Google Drive 載入資料', 'success');
                    }
                }
            } catch (err) {
                console.error('Load from Drive error:', err);
            }
        }

        // Google Drive Folder Picker — select or create a folder, then create file inside it
        async function openDrivePicker() {
            if (!currentUser) {
                showToast('⚠️ 請先登入 Google', 'error');
                return;
            }

            // Show loading modal
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = '📁 更換 Google Drive 路徑';
            document.getElementById('modal-message').innerHTML = '<div class="picker-loading">⏳ 正在載入資料夾列表...</div>';
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn-cancel" onclick="document.getElementById('modal-overlay').classList.remove('show')">取消</button>`;
            overlay.classList.add('show');

            try {
                const res = await fetch(API_BASE + '/api/browse-drive?action=folders', { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || '載入失敗');

                const folders = data.folders || [];
                let selectedFolderId = null;
                let selectedFolderName = data.currentFolder || '';

                // Build folder list HTML
                let listHTML = '<div class="picker-list">';
                // Root (no folder) option
                listHTML += `<div class="picker-item${!selectedFolderName ? ' active' : ''}" data-id="" data-name="">
                    <span>📁</span> <span>根目錄 (My Drive)</span>
                </div>`;
                folders.forEach(f => {
                    const isActive = f.name === selectedFolderName;
                    const date = new Date(f.modifiedTime).toLocaleDateString();
                    listHTML += `<div class="picker-item${isActive ? ' active' : ''}" data-id="${f.id}" data-name="${f.name}">
                        <span>📂</span> <span>${f.name}</span> <span class="picker-meta">${date}</span>
                    </div>`;
                });
                if (folders.length === 0) {
                    listHTML += '<div class="picker-empty">目前沒有任何資料夾</div>';
                }
                listHTML += '</div>';

                // Create new folder input
                listHTML += `<div class="picker-create-row">
                    <input type="text" id="new-folder-name" placeholder="輸入新資料夾名稱..." class="modal-box input">
                    <button class="modal-btn-primary" id="btn-create-folder" style="padding:10px 16px;">➕ 建立</button>
                </div>`;

                document.getElementById('modal-message').innerHTML = '選擇現有資料夾，或建立新的：' + listHTML;
                document.getElementById('modal-actions').innerHTML =
                    `<button class="modal-btn-cancel" id="picker-cancel">取消</button>` +
                    `<button class="modal-btn-primary" id="picker-confirm">✅ 使用此資料夾</button>`;

                // Event: click folder item
                document.querySelectorAll('.picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedFolderId = item.getAttribute('data-id');
                        selectedFolderName = item.getAttribute('data-name');
                    });
                });

                // Event: create new folder
                document.getElementById('btn-create-folder').onclick = async () => {
                    const newName = document.getElementById('new-folder-name').value.trim();
                    if (!newName) { showToast('⚠️ 請輸入資料夾名稱', 'error'); return; }
                    selectedFolderName = newName;
                    selectedFolderId = null; // backend will create it
                    // Visual feedback
                    document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                    showToast(`📂 將建立新資料夾「${newName}」`, 'success');
                    // Auto-confirm
                    await doPickerConfirm(selectedFolderName);
                };

                // Event: cancel
                document.getElementById('picker-cancel').onclick = () => overlay.classList.remove('show');

                // Event: confirm
                document.getElementById('picker-confirm').onclick = () => doPickerConfirm(selectedFolderName);

                async function doPickerConfirm(folderName) {
                    overlay.classList.remove('show');
                    const fileName = generateFileName();
                    showToast('⏳ 正在建立檔案...', 'warning');
                    try {
                        const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ fileName, folderName: folderName || undefined }),
                        });
                        const createData = await createRes.json();
                        if (createData.success) {
                            currentUser.hasDriveFile = true;
                            updateAuthUI();
                            showToast(`☁️ 已在${folderName ? `「${folderName}」` : '根目錄'}建立同步檔案`, 'success');
                        } else {
                            showToast('⚠️ 建立失敗：' + (createData.error || '未知錯誤'), 'error');
                        }
                    } catch (err) {
                        showToast('⚠️ 操作失敗：' + err.message, 'error');
                    }
                }
            } catch (err) {
                overlay.classList.remove('show');
                showToast('⚠️ 載入資料夾失敗：' + err.message, 'error');
            }
        }

        // Serialize humanTree for sync
        function serializeTreeForSync() {
            const stageMap = { dock: 0, cue: 1, craving: 2, response: 3, reward: 4 };
            return {
                name: humanTree.name,
                children: humanTree.children.map(demand => ({
                    id: demand.id,
                    name: demand.name,
                    actions: demand.actions.map(action => {
                        const tokenSlots = [[], [], [], [], []];
                        (action.tokens || []).forEach(t => {
                            const idx = stageMap[t.stage] !== undefined ? stageMap[t.stage] : 0;
                            tokenSlots[idx].push({
                                id: t.id, name: t.name, score: t.score, timeType: t.timeType,
                            });
                        });
                        return {
                            id: action.id, name: action.name, cp: action.cp,
                            st: action.st, lt: action.lt, isNew: action.isNew, tokenSlots,
                        };
                    }),
                })),
            };
        }

        // Internal sync (used by conflict resolution + normal sync)
        async function syncToDriveInternal(triggerAction) {
            if (!currentUser || !currentUser.hasDriveFile) return false;
            try {
                const payload = {
                    triggerAction,
                    treeData: serializeTreeForSync(),
                    syncTimestamp: new Date().toISOString(),
                };
                const res = await fetch(API_BASE + '/api/sync-drive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(payload),
                });
                if (res.ok) return true;

                const data = await res.json();
                if (res.status === 402 || res.status === 403) {
                    showToast('⚠️ Google Drive 空間不足，無法同步，請清理雲端空間', 'error');
                }
                throw new Error(data.error || '同步失敗');
            } catch (err) {
                throw err;
            }
        }

        // Public sync function: respects storage mode + next-day detection
        async function syncToDrive(triggerAction, isFromImportDiff = false) {
            const mode = getStorageMode();
            const today = new Date().toISOString().slice(0, 10);
            const lastSaveDate = localStorage.getItem(STORAGE_KEY_SAVE_DATE);
            const needNewFile = (lastSaveDate && today !== lastSaveDate) || isFromImportDiff;

            // Always save to local if mode is 'local' or 'both'
            if (mode === 'local' || mode === 'both') {
                saveToLocal();
            }

            // Sync to Drive if mode is 'drive' or 'both'
            if ((mode === 'drive' || mode === 'both') && currentUser && currentUser.hasDriveFile) {
                const syncDot = document.getElementById('sync-dot');
                if (syncDot) {
                    syncDot.className = 'sync-indicator syncing';
                    syncDot.title = '同步中...';
                }
                try {
                    if (needNewFile) {
                        // Next day or import diff → create new file first
                        const fileName = generateFileName();
                        const createRes = await fetch(API_BASE + '/api/create-drive-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ fileName }),
                        });
                        const createData = await createRes.json();
                        if (createData.success) {
                            currentUser.hasDriveFile = true;
                            updateAuthUI();
                        } else {
                            throw new Error(createData.error || '建立新檔案失敗');
                        }
                    }
                    // Now write data to the (new or existing) controlled file
                    await syncToDriveInternal(triggerAction);
                    if (syncDot) {
                        syncDot.className = 'sync-indicator synced';
                        syncDot.title = '已同步';
                    }
                    showToast(needNewFile ? '☁️ 已建立新檔案並同步至 Google Drive' : '☁️ 已同步至 Google Drive', 'success');
                } catch (err) {
                    if (syncDot) {
                        syncDot.className = 'sync-indicator error';
                        syncDot.title = '同步失敗';
                    }
                    showToast('⚠️ Drive 同步失敗：' + err.message, 'error');
                }
            }

            // If local-only mode, also save to local
            if (mode === 'local') {
                saveToLocal();
            }

            // Track today's date
            localStorage.setItem(STORAGE_KEY_SAVE_DATE, today);
        }

        // =========================================================================
        // Local File Export / Import
        // =========================================================================
        function exportToLocalFile() {
            const data = JSON.stringify({
                exportedAt: new Date().toISOString(),
                treeData: serializeTreeForSync(),
            }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = generateFileName();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('💾 已匯出至本機檔案', 'success');
        }

        function importFromLocalFile() {
            document.getElementById('local-file-input').click();
        }

        function handleLocalFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.json')) {
                showToast('⚠️ 只支援 .json 檔案', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    const importedTree = parsed.treeData || parsed.humanTree || parsed;
                    if (!importedTree || !importedTree.children || importedTree.children.length === 0) {
                        showToast('⚠️ 檔案格式不正確，無法匯入', 'error');
                        return;
                    }
                    // Compare with current web data
                    const currentTree = serializeTreeForSync();
                    const currentStr = JSON.stringify(currentTree);
                    const importedStr = JSON.stringify(importedTree);
                    if (hasInitialized && currentStr !== importedStr) {
                        // Different → show conflict dialog
                        showConflictDialog(currentTree, importedTree, '🖥️ 目前網頁資料', '📂 匯入的檔案', 'importLocal');
                    } else {
                        // Same or no existing data → apply directly
                        restoreTreeFromSerialized(importedTree);
                        saveToLocal();
                        initApp();
                        showToast('📂 已從本機檔案匯入資料', 'success');
                        syncToDrive('importLocalFile', true);
                    }
                } catch (err) {
                    showToast('⚠️ 檔案解析失敗：' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for re-import
        }

        // Manual import from Google Drive with file picker (does NOT change auto-save mode)
        async function importFromDrive() {
            if (!currentUser) {
                showToast('⚠️ 請先登入 Google', 'error');
                return;
            }

            // Show loading modal
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = '☁️ 從 Google Drive 匯入';
            document.getElementById('modal-message').innerHTML = '<div class="picker-loading">⏳ 正在載入檔案列表...</div>';
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn-cancel" onclick="document.getElementById('modal-overlay').classList.remove('show')">取消</button>`;
            overlay.classList.add('show');

            try {
                const res = await fetch(API_BASE + '/api/browse-drive?action=files', { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || '載入失敗');

                const files = data.files || [];
                let selectedFileId = null;

                let listHTML = '<div class="picker-list">';
                if (files.length === 0) {
                    listHTML += '<div class="picker-empty">找不到任何 .json 檔案</div>';
                } else {
                    files.forEach(f => {
                        const date = new Date(f.modifiedTime).toLocaleString();
                        const sizeKB = f.size ? (parseInt(f.size) / 1024).toFixed(1) + ' KB' : '';
                        listHTML += `<div class="picker-item" data-id="${f.id}">
                            <span>📄</span> <span>${f.name}</span> <span class="picker-meta">${sizeKB} ・ ${date}</span>
                        </div>`;
                    });
                }
                listHTML += '</div>';

                document.getElementById('modal-message').innerHTML = '選擇要匯入的檔案：' + listHTML;
                document.getElementById('modal-actions').innerHTML =
                    `<button class="modal-btn-cancel" id="file-picker-cancel">取消</button>` +
                    `<button class="modal-btn-primary" id="file-picker-confirm" disabled>✅ 匯入此檔案</button>`;

                // Event: click file item
                document.querySelectorAll('.picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectedFileId = item.getAttribute('data-id');
                        document.getElementById('file-picker-confirm').disabled = false;
                    });
                });

                document.getElementById('file-picker-cancel').onclick = () => overlay.classList.remove('show');

                document.getElementById('file-picker-confirm').onclick = async () => {
                    if (!selectedFileId) return;
                    overlay.classList.remove('show');
                    showToast('⏳ 正在載入檔案...', 'warning');
                    try {
                        const loadRes = await fetch(API_BASE + '/api/browse-drive', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({ action: 'load', fileId: selectedFileId }),
                        });
                        const loadData = await loadRes.json();
                        if (!loadData.success || !loadData.data) {
                            showToast('⚠️ 檔案讀取失敗', 'error');
                            return;
                        }
                        const driveTree = loadData.data.treeData || loadData.data;
                        const currentTree = serializeTreeForSync();
                        const currentStr = JSON.stringify(currentTree);
                        const driveStr = JSON.stringify(driveTree);
                        if (hasInitialized && currentStr !== driveStr) {
                            showConflictDialog(currentTree, driveTree, '🖥️ 目前網頁資料', '☁️ Google Drive 檔案', 'importDrive');
                        } else {
                            restoreTreeFromSerialized(driveTree);
                            saveToLocal();
                            initApp();
                            showToast('☁️ 已從 Google Drive 匯入資料', 'success');
                        }
                    } catch (err) {
                        showToast('⚠️ 載入失敗：' + err.message, 'error');
                    }
                };
            } catch (err) {
                overlay.classList.remove('show');
                showToast('⚠️ 載入檔案列表失敗：' + err.message, 'error');
            }
        }

        // =========================================================================
        // More Options (☰) Menu
        // =========================================================================
        function toggleMoreMenu(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            // Close all other dropdowns first
            document.querySelectorAll('.more-dropdown').forEach(d => {
                if (d.id !== dropdownId) d.classList.remove('show');
            });
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                buildMoreDropdown(dropdownId);
                dropdown.classList.add('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.more-options-wrapper')) {
                document.querySelectorAll('.more-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function buildMoreDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const mode = getStorageMode();
            const isLoggedIn = !!currentUser;
            const tosAccepted = getTosAccepted();

            let html = '';

            // 如果未同意 TOS，只顯示同意按鈕與刪除按鈕
            if (!tosAccepted) {
                html += '<div class="more-dropdown-header" style="color:var(--bad);">授權設定</div>';
                html += `<label class="more-dropdown-item" style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" onchange="setTosAccepted(this.checked)" ${tosAccepted ? 'checked' : ''} style="width: 16px; height: 16px;">
                    <span style="flex:1;">✅ 我已閱讀並同意服務條款與隱私權</span>
                </label>`;

                html += `<button class="more-dropdown-item" onclick="window.open('privacy.html', '_blank'); closeAllDropdowns();">
                    <span class="item-icon">📄</span> 隱私權政策 (Privacy Policy)
                </button>`;
                html += `<button class="more-dropdown-item" onclick="window.open('tos.html', '_blank'); closeAllDropdowns();">
                    <span class="item-icon">📜</span> 服務條款 (Terms of Service)
                </button>`;

                html += '<div class="more-dropdown-divider"></div>';
                html += '<div class="more-dropdown-header" style="color:var(--bad);">危險操作</div>';
                html += `<button class="more-dropdown-item" onclick="deleteAllDataFlow(); closeAllDropdowns();" style="color:var(--bad);">
                    <span class="item-icon">🗑️</span> 刪除所有資料 (Remove all my data)
                </button>`;
                dropdown.innerHTML = html;
                return;
            }

            html += '<div class="more-dropdown-header">儲存模式</div>';

            // Local only
            html += `<button class="more-dropdown-item ${mode === 'local' ? 'active' : ''}" onclick="switchMode('local')">
                <span class="item-icon">📂</span> 僅使用本機 (Local Only)
            </button>`;

            // Drive only (requires login)
            if (isLoggedIn) {
                html += `<button class="more-dropdown-item ${mode === 'drive' ? 'active' : ''}" onclick="switchMode('drive')">
                    <span class="item-icon">☁️</span> 僅使用 Google Drive
                </button>`;
                html += `<button class="more-dropdown-item ${mode === 'both' ? 'active' : ''}" onclick="switchMode('both')">
                    <span class="item-icon">🔄</span> 本機與雲端同步 (Sync Both)
                </button>`;
            }

            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">檔案操作</div>';

            html += `<button class="more-dropdown-item" onclick="exportToLocalFile(); closeAllDropdowns();">
                <span class="item-icon">💾</span> 匯出到本機檔案
            </button>`;
            html += `<button class="more-dropdown-item" onclick="importFromLocalFile(); closeAllDropdowns();">
                <span class="item-icon">📂</span> 從本機檔案匯入
            </button>`;

            // Import from Google Drive (manual, doesn't change mode)
            if (isLoggedIn) {
                html += `<button class="more-dropdown-item" onclick="importFromDrive(); closeAllDropdowns();">
                    <span class="item-icon">☁️</span> 從 Google Drive 匯入
                </button>`;
            }

            // Divider + change save path
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">儲存路徑</div>';

            // Local path — show status based on mode
            const localActive = (mode === 'local' || mode === 'both');
            html += `<div class="more-dropdown-item" style="cursor:default; font-size:0.88rem;">
                <span class="item-icon">💻</span> 本機儲存 <span style="color:#999; font-size:0.78rem;">(無法更改路徑)</span>
            </div>`;

            if (isLoggedIn) {
                html += `<button class="more-dropdown-item" onclick="openDrivePicker(); closeAllDropdowns();">
                    <span class="item-icon">📁</span> 更換 Google Drive 路徑
                </button>`;
            }

            // Legal links
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header">法規與條款</div>';
            html += `<label class="more-dropdown-item" style="cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold;">
                <input type="checkbox" onchange="setTosAccepted(this.checked)" checked style="width: 16px; height: 16px;">
                <span style="flex:1; color: var(--primary);">✅ 已同意服務條款與隱私權</span>
            </label>`;
            html += `<button class="more-dropdown-item" onclick="window.open('privacy.html', '_blank'); closeAllDropdowns();">
                <span class="item-icon">📄</span> 隱私權政策 (Privacy Policy)
            </button>`;
            html += `<button class="more-dropdown-item" onclick="window.open('tos.html', '_blank'); closeAllDropdowns();">
                <span class="item-icon">📜</span> 服務條款 (Terms of Service)
            </button>`;

            // Danger zone
            html += '<div class="more-dropdown-divider"></div>';
            html += '<div class="more-dropdown-header" style="color:var(--bad);">危險操作</div>';
            html += `<button class="more-dropdown-item" onclick="deleteAllDataFlow(); closeAllDropdowns();" style="color:var(--bad);">
                <span class="item-icon">🗑️</span> 刪除所有資料 (Remove all my data)
            </button>`;

            dropdown.innerHTML = html;
        }

        function updateMoreDropdowns() {
            ['welcome-more-dropdown', 'tree-more-dropdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.classList.contains('show')) {
                    buildMoreDropdown(id);
                }
            });
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.more-dropdown').forEach(d => d.classList.remove('show'));
        }

        function switchMode(newMode) {
            if (newMode === 'drive' && !currentUser) {
                showToast('⚠️ 請先登入 Google 帳戶', 'error');
                return;
            }
            setStorageMode(newMode);
            const labels = { local: '📂 僅本機', drive: '☁️ 僅雲端', both: '🔄 本機 + 雲端同步' };
            showToast(`已切換為：${labels[newMode]}`, 'success');
            closeAllDropdowns();

            // If switching to both or drive and we have tree data, sync immediately
            if ((newMode === 'both' || newMode === 'drive') && hasInitialized && currentUser && currentUser.hasDriveFile) {
                syncToDrive('switchMode');
            }
            // If switching to local or both, save to local
            if (newMode === 'local' || newMode === 'both') {
                saveToLocal();
            }
        }

        async function deleteAllDataFlow() {
            const html = `
                <div style="text-align:left; padding-top: 10px;">
                    <p style="font-size: 1rem; margin-bottom: 10px; color: var(--bad);">警告：這將會清除您在此網站上的所有帳號資料與設定，且無法還原。</p>
                    <p style="font-size: 0.95rem; margin-bottom: 10px;">若確定要刪除，請在下方輸入：<br><strong style="user-select:all; color:#333; background:#f5f5f5; padding:2px 4px; border-radius:4px;">I want to remove all my data on this website</strong></p>
                    <input type="text" id="modal-delete-confirm-input" placeholder="請輸入確認文字..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                </div>
            `;
            const ok = await showModal({
                title: '🗑️ 刪除所有資料',
                message: html,
                confirmText: '確定刪除',
                cancelText: '取消',
                danger: true
            });

            if (ok) {
                const inputEl = document.getElementById('modal-delete-confirm-input');
                if (!inputEl) return;
                const inputVal = inputEl.value.trim();

                if (inputVal !== 'I want to remove all my data on this website') {
                    showToast('⚠️ 輸入的確認文字不正確，刪除已取消', 'error');
                    return;
                }

                // Call backend if logged in
                if (currentUser) {
                    try {
                        await fetch(API_BASE + '/api/auth/me', {
                            method: 'DELETE',
                            headers: authHeaders()
                        });
                    } catch (err) {
                        console.error('Delete account error', err);
                    }
                }

                // Clear everything locally
                localStorage.clear();

                showToast('✅ 成功刪除所有資料 (Successfully removed all your data)', 'success');

                // Reset state
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        }

        // =========================================================================
        // Page Init
        // =========================================================================
        handleTosUI();
        checkAuth();
        initApp();
    </script>
</body>

</html>