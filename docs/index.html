<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£ï¼šå¤§è…¦è¡Œç‚ºæ¨¹èˆ‡æ€§åƒ¹æ¯”ç³»çµ±</title>
    <style>
        :root {
            --bg-color: #F4F7F6;
            --text-main: #2C3E50;
            --cue: #95A5A6;     
            --craving: #F39C12; 
            --response: #8E44AD;
            --reward: #E74C3C;  
            --good: #2ECC71;
            --bad: #E74C3C;
            --st-color: #3498DB;
            --lt-color: #34495E;
            --card-bg: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 20px;
        }

        .container {
            max-width: 1200px; margin: 0 auto; background: transparent;
        }

        h1, h2, h3 { text-align: center; }
        
        button {
            padding: 8px 16px; font-size: 1rem; color: white; background: var(--text-main);
            border: none; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        button.primary { background: var(--st-color); }
        button.success { background: var(--good); }
        button.danger { background: var(--bad); }
        button.outline { background: transparent; border: 2px dashed var(--text-main); color: var(--text-main); }

        input, select {
            width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box;
            border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;
        }

        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ================= Tree UI ================= */
        .tree-container {
            display: flex; flex-direction: column; gap: 20px; margin-top: 30px;
        }
        .demand-node {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid var(--st-color);
        }
        .demand-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.3rem; font-weight: bold; cursor: pointer; padding-bottom: 10px; border-bottom: 2px solid #eee;
        }
        .demand-header:hover { color: var(--bad); } /* æç¤ºé»æ“Šå¯åˆªé™¤ */
        .demand-header::after { content: 'ğŸ—‘ï¸ (é»æ“Šåˆªé™¤éœ€æ±‚)'; font-size: 0.8rem; opacity: 0; transition: 0.2s; }
        .demand-header:hover::after { opacity: 1; }

        .actions-list {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;
        }
        .action-node {
            background: #F8F9FA; border: 1px solid #ddd; border-radius: 8px; padding: 12px 20px;
            cursor: pointer; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; min-width: 120px;
        }
        .action-node:hover { background: #EDF2F8; border-color: var(--st-color); transform: scale(1.02); }
        .action-cp { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; font-weight: bold; }
        .action-cp.good { color: var(--good); }
        .action-cp.bad { color: var(--bad); }

        .add-btn {
            background: #E8F8F5; color: var(--good); border: 2px dashed var(--good);
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        .add-btn:hover { background: var(--good); color: white; }

        /* ================= 4-Stage Editor ================= */
        .editor-header {
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .pipeline-container {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;
        }
        .stage-box {
            flex: 1; min-width: 220px; border-radius: 10px; padding: 15px; display: flex; flex-direction: column; min-height: 250px;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid; transition: 0.2s;
        }
        .stage-box.dragover { background: #F4F6F6; transform: scale(1.02); }
        #stage-cue { border-color: var(--cue); }
        #stage-craving { border-color: var(--craving); }
        #stage-response { border-color: var(--response); }
        #stage-reward { border-color: var(--reward); }

        .drop-zone { flex: 1; border: 2px dashed #ccc; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 100px; }

        .token-creator {
            background: #EDF2F8; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .cp-token {
            padding: 8px 12px; border-radius: 20px; color: white; cursor: grab; font-size: 0.9rem; font-weight: bold;
            display: flex; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); user-select: none; position: relative;
        }
        .cp-token:active { cursor: grabbing; }
        .st-token { background: var(--st-color); }
        .lt-token { background: var(--lt-color); }
        .token-del { margin-left: 10px; cursor: pointer; color: #fff; opacity: 0.7; }
        .token-del:hover { opacity: 1; }

        .score-board {
            display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 10px;
            margin: 20px 0; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .alert-box {
            background: #FDEDEC; border-left: 5px solid var(--bad); padding: 15px; margin: 20px 0;
            color: #C0392B; display: none; font-weight: bold; border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- View 1: æ¨¹ç‹€åœ– (Human Tree Dashboard) -->
    <div id="view-tree" class="view active">
        <h1>ğŸ§  å¤§è…¦åº•å±¤éœ€æ±‚èˆ‡ç¿’æ…£æ¨¹ (Human Tree)</h1>
        <p class="text-center">å¤§è…¦æœƒæ ¹æ“šæ€§åƒ¹æ¯” (CP Value) è‡ªå‹•å°‡è¡Œå‹•æ’åºã€‚<br>é»æ“Š <strong>è¡Œå‹•ç¯€é»</strong> é€²è¡Œç·¨è¼¯ï¼›é»æ“Š <strong>åº•å±¤éœ€æ±‚åç¨±</strong> å¯åˆªé™¤è©²éœ€æ±‚ã€‚</p>
        
        <div id="tree-render-area" class="tree-container">
            <!-- JS å°‡åœ¨é€™è£¡æ¸²æŸ“æ¨¹ç‹€åœ– -->
        </div>

        <button class="outline" onclick="addBaseDemand()" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;">
            â• æ–°å¢åº•å±¤éœ€æ±‚ (Base Demand)
        </button>
    </div>

    <!-- View 2: ç·¨è¼¯å™¨ (init_action_of_base_demand) -->
    <div id="view-editor" class="view">
        <div class="editor-header">
            <button onclick="goToTree()" style="background: var(--cue); margin-bottom: 15px;">â¬…ï¸ è¿”å›å¤§è…¦æ¨¹</button>
            <h2 id="editor-title">åˆå§‹åŒ–/ç·¨è¼¯ç¿’æ…£</h2>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label>è¡Œå‹•åç¨± (Action):</label>
                    <input type="text" id="action-name" placeholder="ä¾‹å¦‚ï¼šæŠ½è¸ã€è·‘æ­¥ã€å–æ°´...">
                </div>
            </div>
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 10px;">
                ğŸ’¡ ç¿’æ…£çš„é¤Šæˆå–æ±ºæ–¼ 4 å€‹éšæ®µã€‚è«‹å°‡ CP å€¼ç‰©ä»¶æ‹–æ›³åˆ°å°æ‡‰çš„éšæ®µä¸­ (é€™ä¸æœƒå½±éŸ¿ç¸½åˆ†ï¼Œä½†èƒ½å¹«ä½ é‡æ¸…)ã€‚<br>
                ğŸ’¡ <strong style="color: var(--text-main);">å¥½ç¿’æ…£çš„é•·æœŸ CP > 0ï¼Œå£ç¿’æ…£çš„é•·æœŸ CP < 0ã€‚ç³»çµ±å°‡å¼·åˆ¶æª¢æ ¸ï¼</strong>
            </p>
        </div>

        <!-- Token å‰µé€ å™¨ -->
        <div class="token-creator">
            <input type="text" id="cp-name" placeholder="CP è®Šæ•¸åç¨± (ä¾‹ï¼šçœ‹åˆ°ç”œé»ã€å¤šå·´èƒºã€è®Šèƒ–)" style="flex: 2; min-width: 200px;">
            <input type="number" id="cp-score" placeholder="åˆ†æ•¸ (+/-)" style="flex: 1; min-width: 100px;">
            <select id="cp-time" style="flex: 1; min-width: 150px;">
                <option value="st">çŸ­æœŸ CP (Short-term)</option>
                <option value="lt">é•·æœŸ CP (Long-term)</option>
            </select>
            <button class="primary" onclick="createCPToken()">â• å»ºç«‹ CP ç‰©ä»¶</button>
        </div>

        <div id="token-dock" class="drop-zone" style="min-height: 60px; border-color: var(--st-color); flex-direction: row; flex-wrap: wrap;" ondragover="allowDrop(event)" ondrop="drop(event, 'dock')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
            <span style="color: #999; margin: auto;">(æœªåˆ†é¡çš„ CP ç‰©ä»¶æœƒæ”¾åœ¨é€™è£¡ï¼Œè«‹æ‹–æ›³åˆ°ä¸‹æ–¹)</span>
        </div>

        <!-- 4éšæ®µ Pipeline -->
        <div class="pipeline-container">
            <div class="stage-box" id="stage-cue">
                <div style="color: var(--cue); font-weight: bold; text-align: center;">1. æç¤º (Cue)</div>
                <div class="drop-zone" id="zone-cue" ondragover="allowDrop(event)" ondrop="drop(event, 'cue')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <div class="stage-box" id="stage-craving">
                <div style="color: var(--craving); font-weight: bold; text-align: center;">2. æ¸´æœ› (Craving)</div>
                <div class="drop-zone" id="zone-craving" ondragover="allowDrop(event)" ondrop="drop(event, 'craving')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <div class="stage-box" id="stage-response">
                <div style="color: var(--response); font-weight: bold; text-align: center;">3. å›æ‡‰ (Response)</div>
                <div class="drop-zone" id="zone-response" ondragover="allowDrop(event)" ondrop="drop(event, 'response')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
            <div class="stage-box" id="stage-reward">
                <div style="color: var(--reward); font-weight: bold; text-align: center;">4. çè³ (Reward)</div>
                <div class="drop-zone" id="zone-reward" ondragover="allowDrop(event)" ondrop="drop(event, 'reward')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
            </div>
        </div>

        <div class="score-board">
            <div style="color: var(--st-color);">çŸ­æœŸ CPï¼š<span id="score-st">0</span></div>
            <div style="color: var(--lt-color);">é•·æœŸ CPï¼š<span id="score-lt">0</span></div>
            <div>å¤§è…¦æœ€çµ‚è©•ä¼°ï¼š<span id="score-final">0</span> <small>(çŸ­ + é•·*0.1)</small></div>
        </div>

        <div id="alert-box" class="alert-box"></div>

        <button class="success" onclick="saveAction()" style="width: 100%; font-size: 1.2rem; padding: 15px;">ğŸ’¾ å„²å­˜ä¸¦å¯«å…¥å¤§è…¦</button>
    </div>

</div>

<script>
    // ==========================================
    // ç³»çµ±è³‡æ–™çµæ§‹ (æ¨¡æ“¬ Python Tree èˆ‡ Dict)
    // ==========================================
    let humanTree = [
        {
            id: generateId(),
            name: "ç´“è§£å£“åŠ› (Stress Relief)",
            actions: [
                { id: generateId(), name: "æŠ½è¸", cp: 1.0, st: 20, lt: -100, isNew: false, tokens: [
                    { id: generateId(), name: "å°¼å¤ä¸æ”¾é¬†", score: 20, timeType: 'st', stage: 'reward' },
                    { id: generateId(), name: "è‚ºéƒ¨å—æ", score: -100, timeType: 'lt', stage: 'reward' }
                ]},
                { id: generateId(), name: "æ·±å‘¼å¸", cp: 1.5, st: 5, lt: 10, isNew: false, tokens: [
                    { id: generateId(), name: "å¹³éœæ„Ÿ", score: 5, timeType: 'st', stage: 'reward' },
                    { id: generateId(), name: "å¿ƒè‚ºå¥åº·", score: 10, timeType: 'lt', stage: 'reward' }
                ]}
            ]
        },
        {
            id: generateId(),
            name: "ç²å¾—ç¤¾äº¤èªåŒ (Social Approval)",
            actions: [
                { id: generateId(), name: "ç‹‚åˆ·çŸ­å½±éŸ³", cp: 1.5, st: 15, lt: -50, isNew: false, tokens: [] }
            ]
        }
    ];

    // ç·¨è¼¯å™¨å…¨å±€ç‹€æ…‹
    let currentDemandId = null;
    let currentActionId = null; // å¦‚æœæ˜¯ null ä»£è¡¨æ˜¯æ–°å¢
    let currentTokens = [];
    let draggedTokenId = null;

    function generateId() { return Math.random().toString(36).substr(2, 9); }

    // ==========================================
    // View 1: æ¨¹ç‹€åœ–æ¸²æŸ“é‚è¼¯
    // ==========================================
    function renderTree() {
        const area = document.getElementById('tree-render-area');
        area.innerHTML = '';

        humanTree.forEach(demand => {
            // æ¯æ¬¡æ¸²æŸ“å‰ï¼Œæ ¹æ“š CP å€¼å° Action é€²è¡Œé™å†ªæ’åº (æ¨¡æ“¬ C++ Map)
            demand.actions.sort((a, b) => b.cp - a.cp);

            const dNode = document.createElement('div');
            dNode.className = 'demand-node';
            
            // æ¨™é¡Œ (é»æ“Šåˆªé™¤)
            const header = document.createElement('div');
            header.className = 'demand-header';
            header.innerText = `Base Demand: ${demand.name}`;
            header.onclick = () => deleteDemand(demand.id);
            dNode.appendChild(header);

            // è¡Œå‹•åˆ—è¡¨
            const aList = document.createElement('div');
            aList.className = 'actions-list';

            demand.actions.forEach(act => {
                const aNode = document.createElement('div');
                aNode.className = 'action-node';
                aNode.onclick = () => openEditor(demand.id, act.id);
                
                const typeClass = act.lt >= 0 ? 'good' : 'bad';
                const typeIcon = act.lt >= 0 ? 'âœ…' : 'âŒ';

                aNode.innerHTML = `
                    <strong>${act.name}</strong>
                    <div class="action-cp ${typeClass}">${typeIcon} ç¸½ CP: ${act.cp.toFixed(1)}</div>
                `;
                aList.appendChild(aNode);
            });

            // æ–°å¢è¡Œå‹•çš„ [+] æŒ‰éˆ•
            const addBtn = document.createElement('div');
            addBtn.className = 'action-node add-btn';
            addBtn.innerText = 'â• æ–°å¢è¡Œå‹•';
            addBtn.onclick = () => openEditor(demand.id, null);
            aList.appendChild(addBtn);

            dNode.appendChild(aList);
            area.appendChild(dNode);
        });
    }

    function addBaseDemand() {
        const name = prompt("è«‹è¼¸å…¥æ–°çš„åº•å±¤éœ€æ±‚ (ä¾‹å¦‚ï¼šé€ƒé¿ç¾å¯¦ã€å°‹æ±‚åˆºæ¿€)ï¼š");
        if(name) {
            humanTree.push({ id: generateId(), name: name, actions: [] });
            renderTree();
        }
    }

    function deleteDemand(dId) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹åº•å±¤éœ€æ±‚ä»¥åŠå®ƒæ‰€æœ‰çš„ç¿’æ…£è¡Œå‹•å—ï¼Ÿ")) {
            humanTree = humanTree.filter(d => d.id !== dId);
            renderTree();
        }
    }

    // ==========================================
    // View 2: ç·¨è¼¯å™¨é‚è¼¯ (init_action_of_base_demand)
    // ==========================================
    function openEditor(dId, aId) {
        currentDemandId = dId;
        currentActionId = aId;
        currentTokens = [];
        document.getElementById('alert-box').style.display = 'none';

        // æ¸…ç©º DOM ä¸Šçš„èˆŠ Tokens
        ['zone-cue', 'zone-craving', 'zone-response', 'zone-reward', 'token-dock'].forEach(id => {
            const zone = document.getElementById(id);
            // ä¿ç•™æç¤ºæ–‡å­—ï¼Œç§»é™¤ token
            Array.from(zone.children).forEach(child => {
                if(child.classList.contains('cp-token')) child.remove();
            });
        });

        if (aId) {
            // ç·¨è¼¯ç¾æœ‰è¡Œå‹•
            const demand = humanTree.find(d => d.id === dId);
            const action = demand.actions.find(a => a.id === aId);
            document.getElementById('editor-title').innerText = `ç·¨è¼¯ç¿’æ…£ï¼š${action.name}`;
            document.getElementById('action-name').value = action.name;
            
            // è¼‰å…¥ Tokens ä¸¦æ¸²æŸ“åˆ°å°æ‡‰çš„ Stage
            currentTokens = JSON.parse(JSON.stringify(action.tokens)); // Deep copy
            currentTokens.forEach(t => renderToken(t));
        } else {
            // æ–°å¢è¡Œå‹•
            document.getElementById('editor-title').innerText = `ç‚ºæ­¤éœ€æ±‚å»ºç«‹æ–°ç¿’æ…£`;
            document.getElementById('action-name').value = '';
        }

        updateScores();
        switchView('view-editor');
    }

    function goToTree() { switchView('view-tree'); renderTree(); }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    // Token é‚è¼¯
    function createCPToken() {
        const name = document.getElementById('cp-name').value.trim();
        const score = parseFloat(document.getElementById('cp-score').value);
        const timeType = document.getElementById('cp-time').value;

        if(!name || isNaN(score)) return alert("è«‹å¡«å¯«å®Œæ•´çš„åç¨±èˆ‡åˆ†æ•¸ï¼");

        const token = { id: 't_' + generateId(), name, score, timeType, stage: 'dock' };
        currentTokens.push(token);
        renderToken(token);

        document.getElementById('cp-name').value = ''; document.getElementById('cp-score').value = '';
        updateScores();
    }

    function renderToken(token) {
        const el = document.createElement('div');
        el.className = `cp-token ${token.timeType === 'st' ? 'st-token' : 'lt-token'}`;
        el.id = token.id; el.draggable = true;
        
        el.innerHTML = `
            <span>${token.name} (${token.score > 0 ? '+'+token.score : token.score})</span>
            <span class="token-del" onclick="deleteToken('${token.id}')">âœ–</span>
        `;
        
        el.addEventListener('dragstart', () => { draggedTokenId = token.id; setTimeout(() => el.style.opacity = '0.5', 0); });
        el.addEventListener('dragend', () => { el.style.opacity = '1'; });

        const targetZone = token.stage === 'dock' ? 'token-dock' : `zone-${token.stage}`;
        document.getElementById(targetZone).appendChild(el);
    }

    function deleteToken(tId) {
        currentTokens = currentTokens.filter(t => t.id !== tId);
        document.getElementById(tId).remove();
        updateScores();
    }

    // Drag & Drop
    function allowDrop(ev) { ev.preventDefault(); }
    function dragEnter(ev) { ev.currentTarget.classList.add('dragover'); }
    function dragLeave(ev) { ev.currentTarget.classList.remove('dragover'); }
    
    function drop(ev, stage) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('dragover');
        if (draggedTokenId) {
            ev.currentTarget.appendChild(document.getElementById(draggedTokenId));
            const token = currentTokens.find(t => t.id === draggedTokenId);
            if(token) token.stage = stage;
            draggedTokenId = null;
        }
    }

    function updateScores() {
        let st = currentTokens.filter(t => t.timeType === 'st').reduce((acc, curr) => acc + curr.score, 0);
        let lt = currentTokens.filter(t => t.timeType === 'lt').reduce((acc, curr) => acc + curr.score, 0);
        let final = st + (lt * 0.1); // å¤§è…¦åèª¤æŠ˜æ‰£

        document.getElementById('score-st').innerText = st;
        document.getElementById('score-lt').innerText = lt;
        document.getElementById('score-final').innerText = final.toFixed(1);

        return { st, lt, final };
    }

    // ==========================================
    // å„²å­˜èˆ‡å¼·åˆ¶é˜²è­·é‚è¼¯ (The Enforcement Rule)
    // ==========================================
    function saveAction() {
        const actionName = document.getElementById('action-name').value.trim();
        if(!actionName) return alert("è«‹å¡«å¯«è¡Œå‹•åç¨±ï¼");

        const { st, lt, final } = updateScores();
        const demand = humanTree.find(d => d.id === currentDemandId);
        
        // åˆ¤æ–·å¥½ç¿’æ…£é‚„æ˜¯å£ç¿’æ…£ (åŸºæ–¼é•·æœŸ CP)
        const isGoodHabit = lt >= 0; 
        
        // å°‹æ‰¾ç¾æœ‰çš„ Action ä»¥åˆ¤æ–·æ˜¯å¦ç‚ºã€Œç¬¬äºŒæ¬¡çœ‹è¦‹ (é init)ã€
        let existingAction = demand.actions.find(a => a.id === currentActionId);
        let isNew = existingAction ? existingAction.isNew : true;

        const alertBox = document.getElementById('alert-box');

        // â˜… æ ¸å¿ƒå¼·åˆ¶è¦å‰‡ï¼šå¦‚æœæ˜¯ç¬¬äºŒæ¬¡ç·¨è¼¯ (!isNew)ï¼Œå¼·åˆ¶æª¢æ ¸ ST åˆ†æ•¸ï¼
        if (!isNew) {
            if (isGoodHabit && st <= 0) {
                alertBox.innerHTML = `ğŸš¨ã€å¼·åˆ¶é˜²è­·ã€‘é€™æ˜¯ä¸€å€‹ã€Œå¥½ç¿’æ…£ (é•·æœŸ > 0)ã€ï¼<br>
                ä½†ç›®å‰ä½ çš„çŸ­æœŸ CP æ˜¯ ${st}ã€‚å¤§è…¦æ˜¯çŸ­è¦–çš„ï¼Œå¦‚æœçŸ­æœŸ CP $\le 0$ï¼Œå¤§è…¦æœƒç«‹åˆ»æ”¾æ£„ï¼<br>
                ğŸ‘‰ <b>è«‹åŠ å…¥ã€ŒçŸ­æœŸçå‹µæˆ–é™ä½é›£åº¦ (ST > 0)ã€ï¼Œç›´åˆ°çŸ­æœŸ CP è®Šæˆæ­£æ•¸ï¼</b>`;
                alertBox.style.display = 'block';
                return; // é˜»æ“‹å„²å­˜
            }
            if (!isGoodHabit && st >= 0) {
                alertBox.innerHTML = `ğŸš¨ã€å¼·åˆ¶é˜²è­·ã€‘é€™æ˜¯ä¸€å€‹ã€Œå£ç¿’æ…£ (é•·æœŸ < 0)ã€ï¼<br>
                ä½†ç›®å‰ä½ çš„çŸ­æœŸ CP æ˜¯ ${st}ã€‚åªè¦çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ï¼Œå¤§è…¦å°±æœƒç¹¼çºŒé€™å€‹å£ç¿’æ…£ï¼<br>
                ğŸ‘‰ <b>è«‹åŠ å…¥ã€ŒçŸ­æœŸæ‘©æ“¦åŠ›æˆ–æ‡²ç½° (ST < 0)ã€ï¼Œç›´åˆ°çŸ­æœŸ CP è®Šæˆè² æ•¸ï¼</b>`;
                alertBox.style.display = 'block';
                return; // é˜»æ“‹å„²å­˜
            }
        } else {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ–°å¢ï¼Œæˆ‘å€‘çµ¦äºˆæç¤ºï¼Œä½†å…è¨±å„²å­˜ (å­˜å®Œå¾Œ isNew å°±æœƒè®Šæˆ false)
            if (isGoodHabit && st <= 0) {
                alert("ç³»çµ±æç¤ºï¼šä½ æ­£åœ¨å»ºç«‹ä¸€å€‹å¥½ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP æ²’æœ‰å¤§æ–¼ 0ã€‚å¤§è…¦å¾ˆå®¹æ˜“æ”¾æ£„å–”ï¼(ä¸‹æ¬¡ç·¨è¼¯æ™‚å°‡å¼·åˆ¶ä¿®æ­£)");
            } else if (!isGoodHabit && st >= 0) {
                alert("ç³»çµ±æç¤ºï¼šä½ æ­£åœ¨ç´€éŒ„ä¸€å€‹å£ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ã€‚å¤§è…¦é‚„æ˜¯æœƒç¹¼çºŒåšï¼(ä¸‹æ¬¡ç·¨è¼¯æ™‚å°‡å¼·åˆ¶ä¿®æ­£)");
            }
        }

        alertBox.style.display = 'none';

        // å¯«å…¥/æ›´æ–° Tree è³‡æ–™
        if (existingAction) {
            existingAction.name = actionName;
            existingAction.st = st;
            existingAction.lt = lt;
            existingAction.cp = final;
            existingAction.tokens = currentTokens;
            existingAction.isNew = false; // ç·¨è¼¯éä¸€æ¬¡å¾Œï¼Œæ°¸é ä¸å†æ˜¯ New
        } else {
            demand.actions.push({
                id: generateId(),
                name: actionName,
                st: st, lt: lt, cp: final,
                tokens: currentTokens,
                isNew: false // å»ºç«‹å®Œå°±ç•¶ä½œå·²å­˜åœ¨ï¼Œä¸‹æ¬¡é»é–‹å°±æ˜¯ç¬¬äºŒæ¬¡
            });
        }

        alert("âœ… å·²æˆåŠŸå¯«å…¥å¤§è…¦ç¥ç¶“ç¶²è·¯ï¼");
        goToTree();
    }

    // åˆå§‹åŒ–æ¸²æŸ“
    renderTree();
</script>
</body>
</html>