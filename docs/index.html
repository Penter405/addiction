<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£ï¼šåº•å±¤éœ€æ±‚èˆ‡æ€§åƒ¹æ¯”é‡å¡‘ç³»çµ±</title>
    <style>
        :root {
            --primary: #4A90E2;
            --danger: #E74C3C;
            --success: #2ECC71;
            --dark: #2C3E50;
            --light: #F5F7FA;
            --warning: #F39C12;
            --gray: #BDC3C7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { text-align: center; color: var(--primary); }
        h2.danger { color: var(--danger); }
        h2.success { color: var(--success); }
        .text-center { text-align: center; }

        button {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            font-size: 1.1rem;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background-color: #357ABD; }
        button.danger-btn { background-color: var(--danger); }
        button.success-btn { background-color: var(--success); }

        input[type="text"], input[type="number"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ECF0F1;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); outline: none; }

        .step { display: none; animation: fadeIn 0.5s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç¿’æ…£è¿´è·¯èˆ‡æ‹–æ›³å€å¡Š */
        .loop-container {
            background: #FFF8E1;
            border: 3px dashed var(--warning);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            transition: background 0.3s;
        }
        .loop-container.dragover { background: #FFE082; }

        .loop-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #D35400;
        }
        .loop-node {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 5px solid var(--warning);
        }
        .arrow-down { text-align: center; font-size: 1.5rem; color: var(--warning); margin: -5px 0; }

        /* æ‹–æ›³ç‰©ä»¶ */
        .token-creator {
            display: flex;
            gap: 10px;
            background: #F8F9FA;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .drag-token {
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: grab;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
            z-index: 10;
        }
        .drag-token:active { cursor: grabbing; }
        .token-st { background: var(--primary); }
        .token-lt { background: var(--danger); }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* å¤©å¹³ç³»çµ± CSS */
        .scale-wrapper {
            position: relative; width: 100%; height: 250px; margin: 40px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }
        .scale-stand { width: 12px; height: 160px; background: #7F8C8D; border-radius: 6px 6px 0 0; }
        .scale-base { width: 120px; height: 20px; background: var(--dark); border-radius: 10px 10px 0 0; }
        .scale-beam {
            position: absolute; top: 60px; left: calc(50% - 150px); width: 300px; height: 8px;
            background: var(--dark); border-radius: 4px; transform-origin: center center;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fulcrum {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 20px solid var(--danger); z-index: 2;
        }
        .pan-container {
            position: absolute; top: 0; width: 100px; display: flex; flex-direction: column; align-items: center;
            transform-origin: top center; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .left-pan { left: 0; transform: translateX(-50%); }
        .right-pan { right: 0; transform: translateX(50%); }
        .pan-string { width: 2px; height: 60px; background: #95A5A6; }
        .pan-box {
            width: 100%; background: white; border: 3px solid var(--dark); border-top: none;
            border-radius: 0 0 8px 8px; padding: 10px 0; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .pan-box::before { content: ''; position: absolute; top: -3px; left: -3px; right: -3px; height: 3px; background: var(--dark); }
        .weight-label { font-size: 0.9rem; font-weight: bold; color: var(--gray); }
        .score-label { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: var(--dark); }

        .bias-watermark {
            position: absolute; top: 50%; left: 110%; transform: translateY(-50%);
            font-size: 2.5rem; font-weight: bold; color: var(--danger); opacity: 0.8; transition: 0.5s;
        }
        .bias-watermark.struck { text-decoration: line-through; color: var(--gray); opacity: 0.2; }

        .item-list { padding: 0; list-style: none; margin-top: 20px; }
        .item-list li { background: #eee; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
        .score-pos { color: var(--success); font-weight: bold; }
        .score-neg { color: var(--danger); font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    
    <!-- Step 1: å®šç¾©åº•å±¤éœ€æ±‚èˆ‡å£ç¿’æ…£ -->
    <div id="step-1" class="step active">
        <h1>åŸå­ç¿’æ…£ï¼šåº•å±¤éœ€æ±‚åˆ†æ</h1>
        <p class="text-center">ç¿’æ…£åªæ˜¯å¤§è…¦ç‚ºäº†è§£æ±ºæŸå€‹ã€Œåº•å±¤éœ€æ±‚ã€æ‰€æ‰¾åˆ°çš„å¿«æ·æ–¹æ¡ˆã€‚</p>
        
        <div style="max-width: 500px; margin: 30px auto;">
            <label>1. ä½ çœŸæ­£çš„ã€Œåº•å±¤éœ€æ±‚ / æ…¾æœ›ã€æ˜¯ä»€éº¼ï¼Ÿ</label>
            <input type="text" id="desire-input" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œå£“åŠ›å¤§æƒ³æ”¾é¬†ã€ç„¡èŠæƒ³æ‰¾é»åˆºæ¿€...">
            
            <label style="margin-top: 20px; display: block;">2. ç‚ºäº†æ»¿è¶³é€™å€‹éœ€æ±‚ï¼Œä½ ç›®å‰æ¡å–äº†ä»€éº¼ã€Œå£ç¿’æ…£ã€ï¼Ÿ</label>
            <input type="text" id="habit-input" placeholder="ä¾‹å¦‚ï¼šåƒé«˜ç†±é‡å®µå¤œã€ç†¬å¤œæ»‘çŸ­å½±éŸ³...">
            
            <button onclick="goToStep(2)">é€²å…¥è¿´è·¯è§£æ</button>
        </div>
    </div>

    <!-- Step 2: èªè­˜è¿´è·¯èˆ‡å»ºç«‹åˆ†æ•¸ Token (Drag & Drop) -->
    <div id="step-2" class="step">
        <h2>å¤§è…¦çš„ç¿’æ…£è©•åƒ¹ç³»çµ±</h2>
        <p class="text-center">è«‹ç‚ºã€Œ<span class="hl-habit" style="color:var(--danger);font-weight:bold;"></span>ã€å¯«ä¸‹çŸ­æœŸèˆ‡é•·æœŸåˆ†æ•¸ï¼Œä¸¦<strong style="color:var(--primary);">å°‡ç”¢ç”Ÿçš„æ–¹å¡Šæ‹–æ›³åˆ°ä¸‹æ–¹çš„ã€Œç¿’æ…£è¿´è·¯ã€ä¸­</strong>ï¼Œè®“å¤§è…¦èªçŸ¥åˆ°é€™äº›ä»£åƒ¹ã€‚</p>

        <!-- å‰µé€  Token çš„æ§åˆ¶é¢æ¿ -->
        <div class="token-creator">
            <div style="flex: 1;">
                <input type="text" id="token-name" placeholder="å¥½è™•/å£è™•åç¨± (ä¾‹ï¼šè®Šèƒ–ã€å¥½èˆ’å£“)">
                <input type="number" id="token-score" placeholder="åˆ†æ•¸ (å¾ˆçˆ½å¡«æ­£æ•¸ï¼Œå¾ˆæ…˜å¡«è² æ•¸)">
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="createToken('st')" style="margin:0; padding: 8px 15px;">è£½ä½œã€çŸ­æœŸã€‘æ–¹å¡Š</button>
                <button onclick="createToken('lt')" class="danger-btn" style="margin:0; padding: 8px 15px;">è£½ä½œã€é•·æœŸã€‘æ–¹å¡Š</button>
            </div>
        </div>

        <!-- ç”¢ç”Ÿçš„ Token æœƒæ”¾åœ¨é€™ -->
        <div id="token-dock" style="min-height: 60px; border: 2px dashed #ccc; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <span style="color: #999; line-height: 40px;">ï¼ˆç”¢ç”Ÿçš„æ–¹å¡Šæœƒå‡ºç¾åœ¨é€™è£¡ï¼Œè«‹ç”¨æ»‘é¼ å°‡å®ƒæ‹–æ›³åˆ°ä¸‹æ–¹é»ƒè‰²è™›ç·šçš„è¿´è·¯ä¸­ï¼‰</span>
        </div>

        <!-- ç¿’æ…£è¿´è·¯ Drop Zone -->
        <div class="loop-container" id="loop-dropzone" ondragover="allowDrop(event)" ondrop="drop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
            <h3 style="margin-top:0; color: #D35400;">ğŸ”„ äººé¡é è¨­ç¿’æ…£è¿´è·¯ (æ‹–æ›³è‡³æ­¤è™•å¯«å…¥å¤§è…¦)</h3>
            <div class="loop-flow">
                <div class="loop-node">1. è§¸ç™¼åº•å±¤éœ€æ±‚ï¼š<strong class="hl-desire" style="color:var(--primary);"></strong></div>
                <div class="arrow-down">â¬‡ï¸</div>
                <div class="loop-node">2. åŸ·è¡Œé«˜æ€§åƒ¹æ¯”æ–¹æ¡ˆï¼š<strong class="hl-habit" style="color:var(--danger);"></strong></div>
                <div class="arrow-down">â¬‡ï¸</div>
                <div class="loop-node">3. é æœŸå¿ƒç†åˆ†æ³Œå¤šå·´èƒº (ä»¥ç‚ºæ€§åƒ¹æ¯”æ¥µé«˜)</div>
                <div class="arrow-down">â¬‡ï¸</div>
                <div class="loop-node" id="reward-node">4. å¯¦éš›ç²å¾—çˆ½åº¦èˆ‡é•·æœŸä»£åƒ¹ (è«‹æŠŠæ–¹å¡Šä¸Ÿé€²ä¾†)</div>
            </div>
        </div>

        <button id="btn-see-scale" onclick="goToStep(3)" style="display: none; width: 100%;">æŸ¥çœ‹å¤§è…¦å¤©å¹³</button>
    </div>

    <!-- å…±ç”¨å¤©å¹³å€å¡Š -->
    <div id="scale-section" class="step">
        <h2 id="scale-title"></h2>
        <div class="scale-wrapper">
            <div class="fulcrum"></div>
            <div class="scale-beam" id="beam">
                <div class="pan-container left-pan" id="panLeft">
                    <div class="pan-string"></div>
                    <div class="pan-box">
                        <div class="weight-label">çŸ­æœŸ (èª˜æƒ‘åŠ›)</div>
                        <div class="score-label" id="st-total">0</div>
                    </div>
                </div>
                <div class="pan-container right-pan" id="panRight">
                    <div class="pan-string"></div>
                    <div class="pan-box">
                        <div class="weight-label">é•·æœŸ (é˜»åŠ›)</div>
                        <div class="score-label" id="lt-total">0</div>
                        <div class="bias-watermark" id="bias-mark">Ã— â…’</div>
                    </div>
                </div>
            </div>
            <div class="scale-stand"></div>
            <div class="scale-base"></div>
        </div>
        
        <div style="display:flex; gap:20px; justify-content:center;">
            <ul class="item-list" id="st-list" style="flex:1; max-width: 300px;"></ul>
            <ul class="item-list" id="lt-list" style="flex:1; max-width: 300px;"></ul>
        </div>
    </div>

    <!-- Step 3: çœ‹è¦‹çœŸå¯¦åèª¤ -->
    <div id="step-3" class="step">
        <p class="text-center" style="font-size:1.2rem; color: var(--danger); font-weight: bold;">
            çœ‹è¦‹äº†å—ï¼Ÿå³é‚Š(é•·æœŸ)è¢«æ‰“äº†ä¸€æŠ˜ï¼<br>é€™å°±æ˜¯ç‚ºä»€éº¼ç†æ™ºä¸Šä½ çŸ¥é“ä¸å¥½ï¼Œä½†å¤§è…¦é‚„æ˜¯è¦ºå¾—å®ƒã€Œæ€§åƒ¹æ¯”è¶…é«˜ã€ã€‚
        </p>
        <button onclick="removeBias()" class="danger-btn">æˆ³ç ´å¤§è…¦çš„ç›²é» (æ‹¿æ‰ 1/10 åèª¤)</button>
    </div>

    <!-- Step 4: é§­å…¥ç³»çµ± (å¢åŠ æ‘©æ“¦åŠ›) -->
    <div id="step-4" class="step">
        <h2 class="danger">é§­å…¥ç³»çµ±ï¼šè®“å£ç¿’æ…£ç ´ç”¢</h2>
        <p class="text-center">æˆ‘å€‘å·²ç¶“æ‹¿æ‰æœªä¾†çš„æ¿¾é¡ï¼Œä½†åªè¦ã€ŒçŸ­æœŸç¸½åˆ†é‚„æ˜¯æ­£çš„ã€ï¼Œå¤šå·´èƒºè¿´è·¯å°±æœƒé‹ä½œã€‚<br>è«‹åœ¨ç¾å¯¦ä¸­<strong>å¼·è¡Œå¢åŠ çŸ­æœŸçš„æ‘©æ“¦åŠ› (è² åˆ†)</strong>ï¼Œç›´åˆ°å·¦é‚ŠçŸ­æœŸè®Šæˆè² æ•¸ï¼</p>
        
        <div style="max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--danger);">
            <input type="text" id="friction-name" placeholder="å¢åŠ ç‰©ç†é˜»åŠ› (ä¾‹ï¼šæŠŠAPPåˆªæ‰ã€æŠŠé›¶é£Ÿé–èµ·ä¾†)">
            <input type="number" id="friction-score" placeholder="è«‹å¡«å¯«ä¸çˆ½åº¦ (è² æ•¸ï¼Œä¾‹å¦‚ï¼š-50)">
            <button onclick="addFriction()" class="danger-btn">æ–½åŠ çŸ­æœŸé˜»åŠ›</button>
        </div>
    </div>

    <!-- Step 5: éè¿´ - å°‹æ‰¾æ–°çš„é«˜æ€§åƒ¹æ¯”æ–¹æ¡ˆ -->
    <div id="step-5" class="step">
        <h2 class="success">å£ç¿’æ…£è¿´è·¯å·²æ‰“ç ´ï¼ä½†éœ€æ±‚é‚„åœ¨...</h2>
        <p class="text-center" style="font-size: 1.1rem; line-height: 1.6;">
            å¤ªæ£’äº†ï¼ä½ çš„å¤§è…¦ç¾åœ¨åˆ¤å®šã€Œ<span class="hl-habit" style="color:var(--danger);"></span>ã€æ€§åƒ¹æ¯”æ¥µä½ã€‚<br>
            <strong>ä½†æ˜¯ï¼Œä½ çš„åº•å±¤éœ€æ±‚ã€Œ<span class="hl-desire" style="color:var(--primary); font-weight:bold;"></span>ã€ä¸¦æ²’æœ‰æ¶ˆå¤±ï¼</strong><br>
            å¦‚æœä¸çµ¦å¤§è…¦ä¸€å€‹æ–°çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒå¾ˆå¿«åˆæœƒå›å»æ‰¾å£ç¿’æ…£ã€‚
        </p>

        <div style="max-width: 600px; margin: 30px auto; background: #E8F8F5; padding: 30px; border-radius: 15px; border-left: 5px solid var(--success);">
            <h3>è«‹è¨­è¨ˆä¸€å€‹ã€å…¨æ–°ç¿’æ…£ã€‘</h3>
            <p>é€™å€‹è¡Œç‚ºå¿…é ˆèƒ½è§£æ±ºã€Œ<span class="hl-desire"></span>ã€ï¼Œä¸”é•·æœŸæœ‰ç›Šã€çŸ­æœŸä¹Ÿä¸èƒ½å¤ªç—›è‹¦ã€‚</p>
            <input type="text" id="new-habit-input" placeholder="ä¾‹å¦‚ï¼šæ”¹åƒç„¡ç³–å„ªæ ¼ã€å»æ¨“ä¸‹æ•£æ­¥10åˆ†é˜ã€æ·±å‘¼å¸...">
            
            <div style="display:flex; gap: 10px; margin-top:15px;">
                <input type="number" id="new-st-score" placeholder="çŸ­æœŸåˆ†æ•¸ (ä¾‹: 20)">
                <input type="number" id="new-lt-score" placeholder="é•·æœŸåˆ†æ•¸ (ä¾‹: 80)">
            </div>
            <button onclick="evaluateNewHabit()" class="success-btn">é©—è­‰æ–°ç¿’æ…£çš„æ€§åƒ¹æ¯”</button>
        </div>
    </div>

    <!-- Step 6: æœ€çµ‚æˆåŠŸ -->
    <div id="step-6" class="step">
        <h2 class="success">ğŸ‰ ç¿’æ…£é‡å¡‘æˆåŠŸï¼</h2>
        <p class="text-center" style="font-size:1.2rem;">
            ä½ æˆåŠŸç”¨å…¨æ–°çš„<strong>ã€Œ<span id="final-new-habit" style="color:var(--primary);"></span>ã€</strong><br>
            å–ä»£äº†åŸæœ¬çš„ã€Œ<span class="hl-habit" style="text-decoration:line-through; color:var(--gray);"></span>ã€ï¼<br>
            å®ƒä¸åƒ…èƒ½æ»¿è¶³ã€Œ<span class="hl-desire"></span>ã€çš„éœ€æ±‚ï¼Œä¸”æ•´é«”æ€§åƒ¹æ¯”æ¥µé«˜ï¼
        </p>
        
        <div class="loop-container" style="background: #E8F8F5; border-color: var(--success);">
            <h3 style="margin-top:0; color: var(--success);">âœ¨ ä½ çš„å…¨æ–°è‡ªå‹•å°èˆªè¿´è·¯</h3>
            <div class="loop-flow">
                <div class="loop-node" style="border-color: var(--success);">1. ç”¢ç”Ÿéœ€æ±‚ï¼š<strong class="hl-desire"></strong></div>
                <div class="arrow-down" style="color: var(--success);">â¬‡ï¸</div>
                <div class="loop-node" style="border-color: var(--success); background: var(--success); color: white;">2. è‡ªå‹•åŸ·è¡Œï¼š<strong id="final-new-habit-2"></strong></div>
                <div class="arrow-down" style="color: var(--success);">â¬‡ï¸</div>
                <div class="loop-node" style="border-color: var(--success);">3. ç²å¾—å¥åº·çš„å¤šå·´èƒºèˆ‡é•·é å›å ±</div>
            </div>
        </div>

        <button onclick="location.reload()" style="background: var(--dark);">é‡å•Ÿç³»çµ±ï¼Œè¨­è¨ˆä¸‹ä¸€å€‹ç¿’æ…£</button>
    </div>

</div>

<script>
    // ç³»çµ±ç‹€æ…‹è®Šæ•¸
    let desire = "";
    let badHabit = "";
    let isBiased = true;
    let stList = [];
    let ltList = [];
    
    // æ‹–æ›³ç‹€æ…‹
    let draggedTokenData = null;

    function goToStep(step) {
        if(step === 2) {
            desire = document.getElementById('desire-input').value.trim();
            badHabit = document.getElementById('habit-input').value.trim();
            if(!desire || !badHabit) return alert("è«‹å¡«å¯«éœ€æ±‚èˆ‡å£ç¿’æ…£ï¼");
            
            document.querySelectorAll('.hl-desire').forEach(el => el.innerText = desire);
            document.querySelectorAll('.hl-habit').forEach(el => el.innerText = badHabit);
        }

        if(step === 3) {
            if(stList.length === 0 || ltList.length === 0) return alert("è«‹è‡³å°‘æ‹–æ›³ä¸€å€‹çŸ­æœŸèˆ‡ä¸€å€‹é•·æœŸçš„æ–¹å¡Šåˆ°è¿´è·¯ä¸­ï¼");
            document.getElementById('scale-title').innerText = `åˆ†æå£ç¿’æ…£ï¼šã€Œ${badHabit}ã€`;
            document.getElementById('scale-section').classList.add('active');
            updateScale();
        }

        if(step === 4) {
            document.getElementById('step-3').classList.remove('active');
        }

        document.querySelectorAll('.step').forEach(el => {
            if(el.id.startsWith('step-')) el.classList.remove('active');
        });
        document.getElementById(`step-${step}`).classList.add('active');
    }

    // ==========================================
    // Drag & Drop é‚è¼¯
    // ==========================================
    function createToken(type) {
        const nameInput = document.getElementById('token-name');
        const scoreInput = document.getElementById('token-score');
        const name = nameInput.value.trim();
        const score = parseInt(scoreInput.value);

        if(!name || isNaN(score)) return alert("è«‹å¡«å¯«å®Œæ•´çš„åç¨±èˆ‡åˆ†æ•¸ï¼");

        // ç”¢ç”Ÿæ‹–æ›³æ–¹å¡Š
        const token = document.createElement('div');
        token.className = `drag-token ${type === 'st' ? 'token-st' : 'token-lt'}`;
        token.draggable = true;
        token.innerText = `${name} (${score > 0 ? '+'+score : score})`;
        
        // ç‚ºäº†æ”¯æ´æ‰‹æ©Ÿï¼ŒåŠ å…¥é»æ“Šç›´æ¥å¯«å…¥çš„åŠŸèƒ½
        token.title = "ä½ å¯ä»¥æ‹–æ›³æˆ‘ï¼Œæˆ–è€…ç›´æ¥é»æ“Šæˆ‘åŠ å…¥è¿´è·¯ï¼";
        
        // å„²å­˜è³‡æ–™
        const tokenData = { type, name, score };
        
        // Drag events
        token.addEventListener('dragstart', (e) => {
            draggedTokenData = tokenData;
            setTimeout(() => token.style.opacity = '0.5', 0);
        });
        token.addEventListener('dragend', (e) => {
            token.style.opacity = '1';
        });

        // Click fallback (for mobile)
        token.addEventListener('click', () => {
            draggedTokenData = tokenData;
            processDrop();
            token.remove();
        });

        const dock = document.getElementById('token-dock');
        if(dock.querySelector('span')) dock.innerHTML = ''; // ç§»é™¤æç¤ºå­—
        dock.appendChild(token);

        nameInput.value = '';
        scoreInput.value = '';
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function dragEnter(ev) { document.getElementById('loop-dropzone').classList.add('dragover'); }
    function dragLeave(ev) { document.getElementById('loop-dropzone').classList.remove('dragover'); }
    
    function drop(ev) {
        ev.preventDefault();
        document.getElementById('loop-dropzone').classList.remove('dragover');
        if(draggedTokenData) {
            // æ‰¾å‡ºåŸæœ¬åœ¨ dock çš„å°æ‡‰ dom ä¸¦ç§»é™¤
            const tokens = document.querySelectorAll('.drag-token');
            tokens.forEach(t => {
                if(t.innerText.includes(draggedTokenData.name)) t.remove();
            });
            processDrop();
        }
    }

    function processDrop() {
        // å°‡è³‡æ–™å¯«å…¥ List
        if(draggedTokenData.type === 'st') stList.push(draggedTokenData);
        else ltList.push(draggedTokenData);
        
        // è¦–è¦ºå›é¥‹
        const rewardNode = document.getElementById('reward-node');
        const originalText = rewardNode.innerText;
        rewardNode.innerText = `âœ”ï¸ å·²å¯«å…¥å¤§è…¦ï¼š${draggedTokenData.name}`;
        rewardNode.style.background = "#D4EFDF";
        setTimeout(() => {
            rewardNode.innerText = "4. å¯¦éš›ç²å¾—çˆ½åº¦èˆ‡é•·æœŸä»£åƒ¹ (å¯ç¹¼çºŒæ‹–æ›³æ–¹å¡Š)";
            rewardNode.style.background = "white";
        }, 1500);

        draggedTokenData = null;
        renderLists();

        if(stList.length > 0 && ltList.length > 0) {
            document.getElementById('btn-see-scale').style.display = 'block';
        }
    }

    // ==========================================
    // å¤©å¹³å¼•æ“èˆ‡æ ¸å¿ƒé‚è¼¯
    // ==========================================
    function renderLists() {
        const createHTML = (items) => items.map(item => `
            <li>
                <span>${item.name}</span>
                <span class="${item.score >= 0 ? 'score-pos' : 'score-neg'}">${item.score >= 0 ? '+' : ''}${item.score}</span>
            </li>
        `).join('');

        document.getElementById('st-list').innerHTML = createHTML(stList);
        document.getElementById('lt-list').innerHTML = createHTML(ltList);
    }

    function updateScale() {
        const stSum = stList.reduce((acc, curr) => acc + curr.score, 0);
        const ltSum = ltList.reduce((acc, curr) => acc + curr.score, 0);

        document.getElementById('st-total').innerText = stSum;
        document.getElementById('lt-total').innerText = ltSum;

        let leftForce = stSum; 
        let rightForce = ltSum < 0 ? Math.abs(ltSum) : 0; 

        if (isBiased) rightForce = rightForce * 0.1;

        let diff = rightForce - leftForce; 
        let angle = diff * 0.3; 
        if (angle > 30) angle = 30;
        if (angle < -30) angle = -30;

        const beam = document.getElementById('beam');
        const panLeft = document.getElementById('panLeft');
        const panRight = document.getElementById('panRight');

        beam.style.transform = `rotate(${angle}deg)`;
        panLeft.style.transform = `translateX(-50%) rotate(${-angle}deg)`;
        panRight.style.transform = `translateX(50%) rotate(${-angle}deg)`;
    }

    function removeBias() {
        const biasMark = document.getElementById('bias-mark');
        biasMark.classList.add('struck');
        isBiased = false;
        
        setTimeout(() => {
            biasMark.style.opacity = '0';
            updateScale();
            setTimeout(() => goToStep(4), 1500); // å»¶é²è‡ªå‹•é€²å…¥ Step 4
        }, 800);
    }

    function addFriction() {
        const nameInput = document.getElementById('friction-name');
        const scoreInput = document.getElementById('friction-score');
        const name = nameInput.value.trim();
        const score = parseInt(scoreInput.value);

        if (!name || isNaN(score)) return alert('è«‹è¼¸å…¥é˜»åŠ›åç¨±èˆ‡åˆ†æ•¸ï¼');
        if (score > 0) return alert('é˜»åŠ›å¿…é ˆæ˜¯è² æ•¸ï¼');

        stList.push({ name: `ğŸ”¥ é˜»åŠ›ï¼š${name}`, score });
        renderLists();
        updateScale();
        
        nameInput.value = '';
        scoreInput.value = '';

        // æª¢æŸ¥æ˜¯å¦æˆåŠŸç ´å£è¿´è·¯
        const stSum = stList.reduce((acc, curr) => acc + curr.score, 0);
        if (stSum <= 0) {
            setTimeout(() => {
                document.getElementById('scale-section').classList.remove('active');
                goToStep(5);
            }, 1500);
        }
    }

    // ==========================================
    // éè¿´ï¼šè©•ä¼°æ–°ç¿’æ…£
    // ==========================================
    function evaluateNewHabit() {
        const newHabit = document.getElementById('new-habit-input').value.trim();
        const newSt = parseInt(document.getElementById('new-st-score').value);
        const newLt = parseInt(document.getElementById('new-lt-score').value);

        if(!newHabit || isNaN(newSt) || isNaN(newLt)) return alert("è«‹å®Œæ•´å¡«å¯«æ–°ç¿’æ…£çš„è¨­å®šï¼");

        // åŸå­ç¿’æ…£æ³•å‰‡ï¼šå¥½ç¿’æ…£çš„çŸ­æœŸåˆ†æ•¸ä¸èƒ½æ˜¯è² çš„ï¼Œä¸ç„¶è¿´è·¯ç„¡æ³•å•Ÿå‹•
        if(newSt < 0) {
            return alert("æ³¨æ„ï¼å¤§è…¦æ˜¯çŸ­è¦–çš„ï¼Œå¦‚æœæ–°ç¿’æ…£çš„çŸ­æœŸåˆ†æ•¸æ˜¯è² çš„ (å¤ªç—›è‹¦)ï¼Œè¿´è·¯çµ•å°ç„¡æ³•å•Ÿå‹•ã€‚è«‹æƒ³è¾¦æ³•åœ¨çŸ­æœŸåŠ ä¸Šçå‹µï¼");
        }
        if(newLt <= 0) {
            return alert("æˆ‘å€‘æ˜¯è¦å»ºç«‹å¥½ç¿’æ…£ï¼Œé•·æœŸåˆ†æ•¸å¿…é ˆæ˜¯æ­£çš„å–”ï¼");
        }

        // é€²å…¥æœ€çµ‚æˆåŠŸé é¢
        document.getElementById('final-new-habit').innerText = newHabit;
        document.getElementById('final-new-habit-2').innerText = newHabit;
        goToStep(6);
    }

</script>
</body>
</html>