<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£ï¼šå¤§è…¦è¡Œç‚ºæ¨¹ç³»çµ±</title>
    <style>
        /* ================= åŸºç¤é¡è‰²èˆ‡å…¨åŸŸè¨­å®š ================= */
        :root {
            --bg-color: #F4F7F6;
            --text-main: #2C3E50;
            --cue: #95A5A6;     
            --craving: #F39C12; 
            --response: #8E44AD;
            --reward: #E74C3C;  
            --good: #2ECC71;
            --bad: #E74C3C;
            --st-color: #3498DB;
            --lt-color: #34495E;
            --line-color: #BDC3C7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0; /* ç•«å¸ƒæ¨¡å¼ä¸‹ç§»é™¤ padding */
            overflow-x: hidden;
        }

        /* é™åˆ¶ä¸€èˆ¬è¡¨å–®ç•«é¢çš„æœ€å¤§å¯¬åº¦ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3 { text-align: center; }

        /* ================= HTML æç¤ºç³»çµ± (Toast) ================= */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, fadeOut 0.4s ease 3s forwards;
            border: 2px solid;
            pointer-events: auto;
        }

        .toast.error { border-color: var(--bad); color: var(--bad); }
        .toast.success { border-color: var(--good); color: var(--good); }
        .toast.warning { border-color: var(--craving); color: var(--craving); }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-20px) scale(0.9); }
        }

        /* ================= æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† ================= */
        button {
            padding: 12px 24px; font-size: 1rem; color: white; background: var(--text-main);
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: bold;
        }
        button:hover { opacity: 0.8; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button.primary { background: var(--st-color); }
        button.success { background: var(--good); }

        input, select {
            width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box;
            border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: 0.2s;
        }
        input:focus { border-color: var(--st-color); outline: none; }

        /* ================= è¦–åœ–åˆ‡æ› ================= */
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ================= View 0: æ­¡è¿ç•«é¢ ================= */
        .welcome-box {
            background: white; max-width: 600px; margin: 80px auto; padding: 40px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; border-top: 6px solid var(--st-color);
        }

        /* ================= View 1: ç„¡é‚Šç•Œç•«å¸ƒæ¨¹ç‹€åœ– (Infinite Canvas) ================= */
        .tree-canvas-container {
            width: 100vw; height: 100vh; overflow: hidden; /* éš±è—åŸç”Ÿæ‹‰æ¢ */
            background: radial-gradient(circle, #EAECEE 2px, transparent 2px); /* ç¶²æ ¼èƒŒæ™¯ */
            background-size: 30px 30px; background-color: var(--bg-color);
            position: fixed; top: 0; left: 0; cursor: grab; z-index: 1;
        }
        .tree-canvas-container:active { cursor: grabbing; }
        
        .tree-zoom-layer {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0; /* ç¢ºä¿æ˜¯ä»¥å·¦ä¸Šè§’ç‚ºåŸºæº–é»è¨ˆç®—ç¸®æ”¾ï¼Œä¸¦ç”± JS æ§åˆ¶å¹³ç§» */
            will-change: transform;
            padding: 100px; /* çµ¦äºˆå…§éƒ¨ä¸€é»åˆå§‹ç·©è¡ç©ºé–“ */
        }

        /* æµ®å‹•çš„æ¨™é¡Œ UI (è“‹åœ¨ç•«å¸ƒä¸Šæ–¹) */
        .canvas-ui-layer {
            position: fixed; top: 20px; left: 20px; z-index: 10; pointer-events: none;
        }
        .canvas-ui-layer > * { pointer-events: auto; background: rgba(255,255,255,0.9); padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }

        /* æ¨¹ç‹€åœ–æ ¸å¿ƒä½ˆå±€ */
        ul.tree { list-style: none; padding-left: 0; display: flex; margin: 0; align-items: center; justify-content: flex-start; }
        ul.tree ul { list-style: none; padding-left: 120px; display: flex; flex-direction: column; position: relative; }
        ul.tree li { display: flex; align-items: center; position: relative; padding: 20px 0; }
        
        .node-box {
            background: white; border: 2px solid #ddd; border-radius: 12px; padding: 15px 20px;
            min-width: 180px; text-align: center; position: relative; z-index: 2;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s ease; cursor: pointer;
        }
        .node-box.root-node { border-color: var(--text-main); background: var(--text-main); color: white; cursor: default; }
        .node-box.demand-node { border-left: 8px solid var(--st-color); }
        .node-box.action-node { border-color: #eee; background: #F8F9FA; }
        .node-box.action-node:hover { border-color: var(--st-color); transform: scale(1.05); background: #EDF2F8; box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2); }
        .node-box.add-node { border: 2px dashed var(--good); color: var(--good); background: #E8F8F5; font-weight: bold; }
        .node-box.add-node:hover { background: var(--good); color: white; }

        .cp-crown { font-size: 1.5rem; position: absolute; top: -15px; left: -10px; transform: rotate(-20deg); }
        .action-cp-text { font-size: 0.85rem; font-weight: bold; margin-top: 8px; color: #7f8c8d; }
        .hover-trash { font-size: 0.8rem; color: var(--bad); opacity: 0; transition: 0.2s; margin-top: 8px; display: block; }
        .node-box.demand-node:hover .hover-trash { opacity: 1; }
        .node-box.demand-node:hover { border-color: var(--bad); }

        /* é€£æ¥ç·š */
        .node-box.has-children::after { content: ''; position: absolute; right: -120px; top: 50%; width: 120px; height: 2px; background: var(--line-color); z-index: 1; }
        .rel-text { position: absolute; right: -105px; top: -20px; font-size: 0.8rem; color: var(--text-main); font-weight: bold; width: 90px; text-align: center; background: rgba(255,255,255,0.9); z-index: 3; padding: 4px 0; border-radius: 4px; }
        .rel-text.action-rel { color: var(--craving); }
        ul.tree ul li::before { content: ''; position: absolute; left: -120px; top: 50%; width: 120px; height: 2px; background: var(--line-color); z-index: 1; }
        ul.tree ul li::after { content: ''; position: absolute; left: -120px; top: 0; bottom: 0; width: 2px; background: var(--line-color); z-index: 1; }
        ul.tree ul li:first-child::after { top: 50%; }
        ul.tree ul li:last-child::after { bottom: 50%; }
        ul.tree ul li:first-child:last-child::after { display: none; }

        /* ================= View 2: å››éšæ®µç·¨è¼¯å™¨ ================= */
        .editor-header { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .pipeline-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 15px; }
        .stage-box { flex: 1; min-width: 240px; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; min-height: 280px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 6px solid; transition: all 0.2s ease; }
        .stage-box.dragover { background: #F4F6F6; transform: scale(1.02); }
        #stage-cue { border-color: var(--cue); } #stage-craving { border-color: var(--craving); } #stage-response { border-color: var(--response); } #stage-reward { border-color: var(--reward); }
        
        /* Drop zone å…§éƒ¨ç½®ä¸­è¨­å®š */
        .drop-zone { flex: 1; border: 2px dashed #ccc; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 10px; min-height: 120px; margin-top: 15px; }
        
        #token-dock { flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; border-color: var(--st-color); }
        .dock-hint { width: 100%; text-align: center; color: #999; font-size: 0.95rem; user-select: none; }

        .token-creator { background: #EDF2F8; padding: 25px; border-radius: 12px; margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .cp-token { padding: 10px 15px; border-radius: 20px; color: white; cursor: grab; font-size: 0.95rem; font-weight: bold; display: flex; justify-content: space-between; box-shadow: 0 3px 6px rgba(0,0,0,0.2); user-select: none; z-index: 10; }
        .cp-token:active { cursor: grabbing; transform: scale(1.05); }
        .st-token { background: var(--st-color); } .lt-token { background: var(--lt-color); }
        .token-del { margin-left: 15px; cursor: pointer; color: #fff; opacity: 0.7; } .token-del:hover { opacity: 1; }

        .score-board { display: flex; justify-content: space-around; background: white; padding: 20px; border-radius: 12px; margin: 25px 0; font-size: 1.3rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* ç³»çµ±å¼·åˆ¶é˜²è­·çš„ HTML æ–‡å­—æ¡† */
        .alert-box {
            background: #FDEDEC; border: 2px solid var(--bad); border-left-width: 8px; padding: 20px; margin: 25px 0;
            color: #C0392B; display: none; font-weight: bold; border-radius: 8px; font-size: 1.1rem; line-height: 1.6;
        }
        .alert-box.success-box { background: #EAFAF1; border-color: var(--good); color: #1E8449; }
    </style>
</head>
<body>

<!-- HTML Toast æç¤ºå®¹å™¨ -->
<div id="toast-container" class="toast-container"></div>

<!-- ================= View 0: åˆå§‹ç•«é¢ ================= -->
<div id="view-welcome" class="view">
    <div class="container">
        <div class="welcome-box">
            <h1 style="color: var(--st-color);">ğŸ§  å¤§è…¦é‡å¡‘ç³»çµ±</h1>
            <p style="font-size: 1.1rem; line-height: 1.6;">
                ç³»çµ±å·²é è¼‰äº†ä¸€äº›çœŸå¯¦çš„äººé¡åº•å±¤éœ€æ±‚ï¼ˆå¦‚ï¼šç´“è§£å£“åŠ›ã€ç¤¾äº¤é€£çµï¼‰ã€‚<br>
                åœ¨é–‹å•Ÿç„¡é‚Šç•Œç•«å¸ƒä¹‹å‰ï¼Œè«‹å…ˆè¼¸å…¥ <strong>ä½ æƒ³åˆ†æçš„ç¬¬ä¸€å€‹ç¿’æ…£</strong>ï¼
            </p>
            <div style="text-align: left; margin-top: 30px;">
                <label style="font-weight: bold;">1. ä½ çœŸæ­£çš„ã€Œåº•å±¤éœ€æ±‚ (Base Demand)ã€æ˜¯ä»€éº¼ï¼Ÿ</label>
                <input type="text" id="init-demand" placeholder="ä¾‹å¦‚ï¼šç„¡èŠæƒ³æ‰¾åˆºæ¿€ã€è‚šå­é¤“ã€ç²å¾—èªåŒ...">
                
                <label style="margin-top: 20px; display: block; font-weight: bold;">2. ç‚ºäº†æ»¿è¶³é€™å€‹éœ€æ±‚ï¼Œä½ é€šå¸¸çš„ã€Œç¿’æ…£è¡Œå‹• (Action)ã€æ˜¯ï¼Ÿ</label>
                <input type="text" id="init-action" placeholder="ä¾‹å¦‚ï¼šæ»‘TikTokã€å–æ‰‹æ–é£²ã€å’¬æŒ‡ç”²...">
            </div>
            <button class="primary" onclick="initFirstAction()" style="margin-top: 35px; width: 100%; font-size: 1.2rem; padding: 15px;">
                ğŸš€ åˆå§‹åŒ–è³‡æ–™ä¸¦é–‹å§‹è¨­å®š
            </button>
        </div>
    </div>
</div>

<!-- ================= View 1: ç„¡é‚Šç•Œç•«å¸ƒæ¨¹ç‹€åœ– ================= -->
<div id="view-tree" class="view">
    <div class="canvas-ui-layer">
        <div>
            <h2 style="margin: 0; color: var(--text-main);">ğŸ§  å¤§è…¦è¡Œç‚ºæ±ºç­–æ¨¹</h2>
            <p style="margin: 5px 0 0 0; color: var(--craving); font-size: 0.95rem; font-weight: bold;">
                æŒ‰ä½æ»‘é¼ æ‹–æ›³å¹³ç§»ç•«å¸ƒï¼Œä½¿ç”¨æ»¾è¼ªç¸®æ”¾ã€‚<br>
                ğŸ‘‘ æ¨™è¨˜ä»£è¡¨å¤§è…¦é è¨­åŸ·è¡Œçš„æœ€é«˜æ€§åƒ¹æ¯”è¡Œå‹•ï¼
            </p>
        </div>
    </div>

    <!-- ç„¡é‚Šç•Œç•«å¸ƒå®¹å™¨ -->
    <div class="tree-canvas-container" id="tree-canvas">
        <div class="tree-zoom-layer" id="tree-zoom-layer">
            <div id="tree-render-area">
                <!-- Javascript å‹•æ…‹æ¸²æŸ“ Real Tree -->
            </div>
        </div>
    </div>
</div>

<!-- ================= View 2: å››éšæ®µç·¨è¼¯å™¨ ================= -->
<div id="view-editor" class="view">
    <div class="container">
        <div class="editor-header">
            <button id="btn-back-tree" onclick="goToTree()" style="background: var(--cue); margin-bottom: 20px;">â¬…ï¸ è¿”å›ç•«å¸ƒ</button>
            <h2 id="editor-title">åˆå§‹åŒ– / ç·¨è¼¯ç¿’æ…£</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label style="font-weight: bold;">è¡Œå‹•åç¨± (Action):</label>
                    <input type="text" id="action-name" placeholder="ä¾‹å¦‚ï¼šæŠ½è¸ã€è·‘æ­¥ã€å–æ°´...">
                </div>
            </div>
            <p style="color: #7f8c8d; font-size: 1rem; margin-top: 15px; line-height: 1.6;">
                ğŸ’¡ ç¿’æ…£é¤Šæˆå–æ±ºæ–¼ 4 å€‹éšæ®µï¼š<strong>æç¤º â” æ¸´æœ› â” å›æ‡‰ â” çè³</strong>ã€‚<br>
                ğŸ’¡ è«‹å°‡ CP å€¼ç‰©ä»¶æ‹–æ›³åˆ°å°æ‡‰éšæ®µ (é€™ä¸å½±éŸ¿ç¸½åˆ†ï¼Œä½†èƒ½å¹«åŠ©é‡æ¸…å•é¡Œ)ã€‚<br>
                ğŸ’¡ <strong style="color: var(--bad);">ã€ç³»çµ±é˜²è­·æ©Ÿåˆ¶ã€‘ç¬¬äºŒæ¬¡æª¢è¦–æ™‚ï¼Œç³»çµ±å°‡å¼·åˆ¶è¦æ±‚ï¼šå¥½ç¿’æ…£çŸ­æœŸ CP > 0ï¼Œå£ç¿’æ…£çŸ­æœŸ CP < 0ï¼</strong>
            </p>
        </div>

        <div class="token-creator">
            <input type="text" id="cp-name" placeholder="CP è®Šæ•¸åç¨± (ä¾‹ï¼šçœ‹åˆ°ç”œé»ã€å¤šå·´èƒºåˆ†æ³Œ)" style="flex: 2; min-width: 250px;">
            <input type="number" id="cp-score" placeholder="åˆ†æ•¸ (+/-)" style="flex: 1; min-width: 120px;">
            <select id="cp-time" style="flex: 1; min-width: 180px;">
                <option value="st">çŸ­æœŸ CP (Short-term)</option>
                <option value="lt">é•·æœŸ CP (Long-term)</option>
            </select>
            <button class="primary" onclick="createCPToken()">â• å»ºç«‹ CP ç‰©ä»¶</button>
        </div>

        <div id="token-dock" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event, 'dock')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
            <span class="dock-hint" id="dock-hint-text">(å‰›å»ºç«‹ã€æœªåˆ†é¡çš„ CP ç‰©ä»¶æœƒæ”¾åœ¨é€™è£¡ï¼Œè«‹ç”¨æ»‘é¼ æ‹–æ›³åˆ°ä¸‹æ–¹å››éšæ®µä¸­)</span>
        </div>

        <div class="pipeline-container">
            <div class="stage-box" id="stage-cue"><div style="color: var(--cue); font-weight: bold; text-align: center; font-size: 1.2rem;">1. æç¤º (Cue)</div><div class="drop-zone" id="zone-cue" ondragover="allowDrop(event)" ondrop="drop(event, 'cue')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div></div>
            <div class="stage-box" id="stage-craving"><div style="color: var(--craving); font-weight: bold; text-align: center; font-size: 1.2rem;">2. æ¸´æœ› (Craving)</div><div class="drop-zone" id="zone-craving" ondragover="allowDrop(event)" ondrop="drop(event, 'craving')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div></div>
            <div class="stage-box" id="stage-response"><div style="color: var(--response); font-weight: bold; text-align: center; font-size: 1.2rem;">3. å›æ‡‰ (Response)</div><div class="drop-zone" id="zone-response" ondragover="allowDrop(event)" ondrop="drop(event, 'response')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div></div>
            <div class="stage-box" id="stage-reward"><div style="color: var(--reward); font-weight: bold; text-align: center; font-size: 1.2rem;">4. çè³ (Reward)</div><div class="drop-zone" id="zone-reward" ondragover="allowDrop(event)" ondrop="drop(event, 'reward')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div></div>
        </div>

        <div class="score-board">
            <div style="color: var(--st-color);">çŸ­æœŸç¸½ CPï¼š<span id="score-st">0</span></div>
            <div style="color: var(--lt-color);">é•·æœŸç¸½ CPï¼š<span id="score-lt">0</span></div>
            <div>å¤§è…¦æœ€çµ‚è©•ä¼°ï¼š<span id="score-final">0</span></div>
        </div>

        <div id="alert-box" class="alert-box"></div>
        <button class="success" onclick="saveAction()" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-top: 10px;">ğŸ’¾ å„²å­˜ä¸¦å¯«å…¥å¤§è…¦æ±ºç­–ç¶²è·¯</button>
    </div>
</div>

<script>
    // =========================================================================
    // HTML æç¤ºç³»çµ± (å–ä»£ alert)
    // =========================================================================
    function showToast(message, type = 'warning') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let icon = type === 'error' ? 'ğŸš¨ ' : type === 'success' ? 'âœ… ' : 'ğŸ’¡ ';
        toast.className = `toast ${type}`;
        toast.innerHTML = icon + message;
        container.appendChild(toast);
        
        // 3.4 ç§’å¾Œè‡ªå‹•å¾ DOM ç§»é™¤ (é…åˆ CSS å‹•ç•«)
        setTimeout(() => toast.remove(), 3400);
    }

    // =========================================================================
    // ç„¡é‚Šç•Œç•«å¸ƒï¼šæ»‘é¼ ç¸®æ”¾èˆ‡å¹³ç§»é‚è¼¯
    // =========================================================================
    const canvas = document.getElementById('tree-canvas');
    const zoomLayer = document.getElementById('tree-zoom-layer');
    let scale = 1;
    let panX = 0, panY = 0;
    let isDragging = false;
    let startX, startY;

    // æ»‘é¼ æ»¾è¼ªï¼šå°æº–æ¸¸æ¨™ç¸®æ”¾
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const zoomSensitivity = 0.0015;
        const delta = -e.deltaY * zoomSensitivity;
        let newScale = scale * (1 + delta);
        newScale = Math.max(0.3, Math.min(newScale, 2.5)); // é™åˆ¶ç¸®æ”¾æ¯”ä¾‹

        // å–å¾—ç•«å¸ƒé‚Šç•Œï¼Œè¨ˆç®—æ»‘é¼ ç›¸å°ä½ç½®
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // æ•¸å­¸è¨ˆç®—ï¼šç¢ºä¿ç¸®æ”¾çš„ä¸­å¿ƒé»æ˜¯æ»‘é¼ æ¸¸æ¨™çš„ä½ç½®
        panX = mouseX - (mouseX - panX) * (newScale / scale);
        panY = mouseY - (mouseY - panY) * (newScale / scale);
        scale = newScale;

        updateCanvasTransform();
    });

    // æ»‘é¼ æ‹–æ›³ï¼šå¹³ç§»
    canvas.addEventListener('mousedown', (e) => {
        // å¦‚æœé»æ“Šçš„æ˜¯ç¯€é»æœ¬èº«ï¼Œå‰‡ä¸è§¸ç™¼å¹³ç§» (è®“ click äº‹ä»¶ç”Ÿæ•ˆ)
        if(e.target.closest('.node-box')) return;
        isDragging = true;
        startX = e.clientX - panX;
        startY = e.clientY - panY;
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        panX = e.clientX - startX;
        panY = e.clientY - startY;
        updateCanvasTransform();
    });

    window.addEventListener('mouseup', () => { isDragging = false; });

    function updateCanvasTransform() {
        zoomLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    }
    
    // å°‡è¦–è§’é‡ç½®ç½®ä¸­
    function resetCanvasView() {
        scale = 1; panX = 50; panY = 100; // é ç•™ä¸€é»ä¸Šå·¦é‚Šè·
        updateCanvasTransform();
    }

    // =========================================================================
    // ç³»çµ±ç‹€æ…‹èˆ‡è³‡æ–™åˆå§‹åŒ–
    // =========================================================================
    let humanTree = { name: "human", children: [] };
    let currentDemandId = null, currentActionId = null, currentTokens = [], draggedTokenId = null;
    let hasInitialized = false;

    function generateId() { return Math.random().toString(36).substr(2, 9); }

    // å»ºç«‹çœŸå¯¦ä¸”æœ‰æ„ç¾©çš„é è¨­è³‡æ–™ï¼Œå–ä»£åŸæœ¬çš„ 1-10
    function buildDefaultPythonTree() {
        const defaultData = [
            {
                demand: "ç´“è§£å·¥ä½œå£“åŠ›",
                actions: [
                    { name: "æŠ½è¸", st: 15, lt: -80 },
                    { name: "åƒé«˜ç†±é‡å®µå¤œ", st: 10, lt: -40 },
                    { name: "æ·±å‘¼å¸èˆ‡å†¥æƒ³", st: 2, lt: 30 }
                ]
            },
            {
                demand: "ç²å¾—ç¤¾äº¤é€£çµèˆ‡èªåŒ",
                actions: [
                    { name: "ç‹‚åˆ·çŸ­å½±éŸ³èˆ‡IG", st: 8, lt: -15 },
                    { name: "åƒåŠ å¯¦é«”ç¤¾ç¾¤èšæœƒ", st: 5, lt: 40 }
                ]
            }
        ];

        defaultData.forEach((d, i) => {
            let demandNode = { id: 'demand_def_' + i, name: d.demand, actions: [] };
            d.actions.forEach((a, j) => {
                let finalCp = a.st + (a.lt * 0.1);
                demandNode.actions.push({
                    id: `action_def_${i}_${j}`, name: a.name, cp: finalCp, st: a.st, lt: a.lt, isNew: false, tokens: []
                });
            });
            humanTree.children.push(demandNode);
        });
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        // åˆ‡æ› Body çš„ Overflow é˜²æ­¢ç•«é¢éŒ¯ä½
        if(viewId === 'view-tree') { document.body.style.overflow = 'hidden'; } 
        else { document.body.style.overflow = 'auto'; }
    }

    function initApp() {
        if (!hasInitialized) switchView('view-welcome');
        else { renderTree(); switchView('view-tree'); resetCanvasView(); }
    }

    function initFirstAction() {
        let demandInput = document.getElementById('init-demand').value.trim();
        let actionInput = document.getElementById('init-action').value.trim();
        
        if (!demandInput || !actionInput) return showToast("è«‹å®Œæ•´å¡«å¯«éœ€æ±‚èˆ‡è¡Œå‹•ï¼", "error");

        buildDefaultPythonTree();
        
        let newDemandId = generateId(), newActionId = generateId();
        humanTree.children.unshift({
            id: newDemandId, name: demandInput, actions: [{ id: newActionId, name: actionInput, cp: 0, st: 0, lt: 0, isNew: true, tokens: [] }]
        });

        hasInitialized = true;
        document.getElementById('btn-back-tree').style.display = 'none';
        openEditor(newDemandId, newActionId);
    }

    function addBaseDemand() {
        let name = prompt("è«‹è¼¸å…¥æ–°çš„åº•å±¤éœ€æ±‚ (ä¾‹å¦‚ï¼šé€ƒé¿ç¾å¯¦ã€å°‹æ±‚åˆºæ¿€)ï¼š");
        if (name && name.trim()) {
            humanTree.children.push({ id: generateId(), name: name, actions: [] });
            renderTree();
        }
    }

    function deleteDemand(demandId, event) {
        event.stopPropagation();
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹åº•å±¤éœ€æ±‚åŠæ‰€æœ‰è¡Œå‹•å—ï¼Ÿ")) {
            humanTree.children = humanTree.children.filter(d => d.id !== demandId);
            renderTree();
            showToast("åº•å±¤éœ€æ±‚å·²åˆªé™¤", "success");
        }
    }

    // =========================================================================
    // View 1: å¯¦é«”æ¨¹ç‹€åœ–æ¸²æŸ“é‚è¼¯ (ç„¡é‚Šç•Œç•«å¸ƒ)
    // =========================================================================
    function renderTree() {
        let renderArea = document.getElementById('tree-render-area');
        if (humanTree.children.length === 0) return renderArea.innerHTML = "<h2 style='color:#999;'>ç•«å¸ƒä¸Šç›®å‰ç©ºç„¡ä¸€ç‰©...</h2>";

        let html = `<ul class="tree"><li>
            <div class="node-box root-node has-children"><strong>Human (å¤§è…¦)</strong><br><small>é è¨­å°‹æ±‚é«˜æ€§åƒ¹æ¯”</small><div class="rel-text">ç”¢ç”Ÿéœ€æ±‚ â”</div></div><ul>`;
        
        humanTree.children.forEach(demand => {
            demand.actions.sort((a, b) => b.cp - a.cp); // é™å†ªæ’åº
            let hasActions = demand.actions.length > 0;
            html += `<li><div class="node-box demand-node ${hasActions ? "has-children" : ""}" onclick="deleteDemand('${demand.id}', event)">
                        <strong>Demand: <br>${demand.name}</strong><span class="hover-trash">ğŸ—‘ï¸ é»æ“Šåˆªé™¤æ­¤éœ€æ±‚</span>
                        ${hasActions ? `<div class="rel-text action-rel">å°‹æ‰¾æœ€ä½³è§£ â”</div>` : ''}
                     </div><ul>`;
            
            demand.actions.forEach((act, j) => {
                let cpColor = act.cp >= 0 ? 'var(--good)' : 'var(--bad)';
                html += `<li><div class="node-box action-node" onclick="openEditor('${demand.id}', '${act.id}')">
                                ${j === 0 ? '<div class="cp-crown">ğŸ‘‘</div>' : ''}
                                <strong>${act.name}</strong><div class="action-cp-text" style="color: ${cpColor};">æœ€çµ‚ CP: ${act.cp.toFixed(2)}</div>
                            </div></li>`;
            });
            html += `<li><div class="node-box add-node" onclick="openEditor('${demand.id}', null)">â• æ–°å¢è¡Œå‹•æ–¹æ¡ˆ</div></li></ul></li>`;
        });
        html += `<li><div class="node-box add-node" onclick="addBaseDemand()">â• æ–°å¢åº•å±¤éœ€æ±‚</div></li></ul></li></ul>`;
        renderArea.innerHTML = html;
    }

    // =========================================================================
    // View 2: å››éšæ®µç·¨è¼¯å™¨ (init_action_of_base_demand)
    // =========================================================================
    function openEditor(dId, aId) {
        currentDemandId = dId; currentActionId = aId; currentTokens = [];
        document.getElementById('alert-box').style.display = 'none';
        if (hasInitialized) document.getElementById('btn-back-tree').style.display = 'inline-block';

        ['zone-cue', 'zone-craving', 'zone-response', 'zone-reward', 'token-dock'].forEach(id => {
            Array.from(document.getElementById(id).children).forEach(c => { if(c.classList.contains('cp-token')) c.remove(); });
        });
        checkDockHint();

        if (aId !== null) {
            let action = humanTree.children.find(d => d.id === dId).actions.find(a => a.id === aId);
            document.getElementById('editor-title').innerText = `ç·¨è¼¯ç¿’æ…£ï¼š${action.name}`;
            document.getElementById('action-name').value = action.name;
            currentTokens = JSON.parse(JSON.stringify(action.tokens)); 
            currentTokens.forEach(t => renderToken(t));
        } else {
            document.getElementById('editor-title').innerText = `ç‚ºæ­¤éœ€æ±‚å»ºç«‹æ–°ç¿’æ…£`;
            document.getElementById('action-name').value = '';
        }
        updateScores();
        switchView('view-editor');
    }

    function goToTree() { initApp(); }

    function createCPToken() {
        let nameInput = document.getElementById('cp-name').value.trim();
        let scoreInput = parseFloat(document.getElementById('cp-score').value);
        if (!nameInput || isNaN(scoreInput)) return showToast("è«‹å¡«å¯«å®Œæ•´çš„åç¨±èˆ‡åˆ†æ•¸ï¼", "error");

        let newToken = { id: 'token_' + generateId(), name: nameInput, score: scoreInput, timeType: document.getElementById('cp-time').value, stage: 'dock' };
        currentTokens.push(newToken);
        renderToken(newToken);
        
        document.getElementById('cp-name').value = ''; document.getElementById('cp-score').value = '';
        updateScores();
    }

    function renderToken(token) {
        let el = document.createElement('div');
        el.className = `cp-token ${token.timeType === 'st' ? 'st-token' : 'lt-token'}`;
        el.id = token.id; el.draggable = true;
        el.innerHTML = `<span>${token.name} (${token.score > 0 ? '+'+token.score : token.score})</span><span class="token-del" onclick="deleteToken('${token.id}')">âœ–</span>`;
        
        el.addEventListener('dragstart', () => { draggedTokenId = token.id; setTimeout(() => el.style.opacity = '0.5', 0); });
        el.addEventListener('dragend', () => el.style.opacity = '1');

        document.getElementById(token.stage === 'dock' ? 'token-dock' : `zone-${token.stage}`).appendChild(el);
        checkDockHint();
    }

    function deleteToken(tokenId) {
        currentTokens = currentTokens.filter(t => t.id !== tokenId);
        document.getElementById(tokenId).remove();
        updateScores();
        checkDockHint();
    }

    function checkDockHint() {
        let dock = document.getElementById('token-dock');
        let hint = document.getElementById('dock-hint-text');
        // å¦‚æœ dock è£¡é¢é™¤äº† hint é‚„æœ‰å…¶ä»– tokenï¼Œå°±éš±è— hint
        if(dock.querySelectorAll('.cp-token').length > 0) hint.style.display = 'none';
        else hint.style.display = 'block';
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function dragEnter(ev) { ev.currentTarget.classList.add('dragover'); }
    function dragLeave(ev) { ev.currentTarget.classList.remove('dragover'); }
    
    function drop(ev, targetStage) {
        ev.preventDefault(); ev.currentTarget.classList.remove('dragover');
        if (draggedTokenId !== null) {
            ev.currentTarget.appendChild(document.getElementById(draggedTokenId));
            let tokenData = currentTokens.find(t => t.id === draggedTokenId);
            if (tokenData) tokenData.stage = targetStage;
            draggedTokenId = null;
            checkDockHint();
        }
    }

    function updateScores() {
        let stSum = currentTokens.filter(t => t.timeType === 'st').reduce((sum, t) => sum + t.score, 0);
        let ltSum = currentTokens.filter(t => t.timeType === 'lt').reduce((sum, t) => sum + t.score, 0);
        let finalCp = stSum + (ltSum * 0.1); 

        document.getElementById('score-st').innerText = stSum;
        document.getElementById('score-lt').innerText = ltSum;
        document.getElementById('score-final').innerText = finalCp.toFixed(2);
        return { st: stSum, lt: ltSum, final: finalCp };
    }

    // =========================================================================
    // å„²å­˜èˆ‡å¼·åˆ¶é˜²è­·é‚è¼¯ (ç¬¬äºŒæ¬¡ç·¨è¼¯æ™‚å¼·è¡Œæ ¡æ­£)
    // =========================================================================
    function saveAction() {
        let actionNameInput = document.getElementById('action-name').value.trim();
        if (!actionNameInput) return showToast("è«‹å¡«å¯«è¡Œå‹•åç¨±ï¼", "error");

        let scores = updateScores();
        let demand = humanTree.children.find(d => d.id === currentDemandId);
        let isGoodHabit = (scores.lt >= 0); 
        
        let existingAction = currentActionId !== null ? demand.actions.find(a => a.id === currentActionId) : null;
        let isNewAction = existingAction !== null ? existingAction.isNew : true;
        let alertBox = document.getElementById('alert-box');

        // ç¬¬äºŒæ¬¡çœ‹è¦‹ -> å¼·åˆ¶é˜²è­·æ©Ÿåˆ¶ (HTML æ¡†æ¡†å‘ˆç¾)
        if (!isNewAction) {
            if (isGoodHabit && scores.st <= 0) {
                alertBox.className = 'alert-box';
                alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±é˜²è­·æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå¥½ç¿’æ…£ (é•·æœŸ >= 0)ã€ï¼<br>
                ä½ çš„çŸ­æœŸ CP ç›®å‰æ˜¯ ${scores.st}ã€‚<br>
                å¤§è…¦æ˜¯çŸ­è¦–çš„ï¼Œå¦‚æœçŸ­æœŸç—›è‹¦æ²’æœ‰çå‹µï¼Œå¤§è…¦å°±æœƒæ”¾æ£„ï¼<br>
                ğŸ‘‰ <b>è«‹å¼·åˆ¶åŠ å…¥ã€ŒçŸ­æœŸçš„æ­£é¢ CP (çè³)ã€ï¼Œè®“çŸ­æœŸ CP > 0ï¼</b>`;
                alertBox.style.display = 'block';
                return;
            } else if (!isGoodHabit && scores.st >= 0) {
                alertBox.className = 'alert-box';
                alertBox.innerHTML = `ğŸš¨ã€ç³»çµ±é˜²è­·æ””æˆªã€‘é€™æ˜¯ä¸€å€‹ã€Œå£ç¿’æ…£ (é•·æœŸ < 0)ã€ï¼<br>
                ä½ çš„çŸ­æœŸ CP ç›®å‰æ˜¯ ${scores.st}ã€‚<br>
                åªè¦çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ï¼Œä½ çš„å¤§è…¦å°±æœƒè¦ºå¾—æ€§åƒ¹æ¯”å¾ˆé«˜è€Œç¹¼çºŒåšï¼<br>
                ğŸ‘‰ <b>è«‹å¼·åˆ¶åŠ å…¥ã€ŒçŸ­æœŸçš„è² é¢ CP (æ‘©æ“¦åŠ›/æ‡²ç½°)ã€ï¼Œè®“çŸ­æœŸ CP < 0ï¼</b>`;
                alertBox.style.display = 'block';
                return;
            }
        } else {
            // ç¬¬ä¸€æ¬¡ -> Toast æé†’ä½†ä¸é˜»æ“‹
            if (isGoodHabit && scores.st <= 0) {
                showToast("ã€ç³»çµ±æç¤ºã€‘ä½ æ­£åœ¨å»ºç«‹å¥½ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP å°šæœªå¤§æ–¼ 0ã€‚å¤§è…¦å¾ˆå®¹æ˜“æ”¾æ£„å–”ï¼(ä¸‹æ¬¡ç·¨è¼¯å°‡å¼·åˆ¶ä¿®æ­£)", "warning");
            } else if (!isGoodHabit && scores.st >= 0) {
                showToast("ã€ç³»çµ±æç¤ºã€‘ä½ æ­£åœ¨ç´€éŒ„å£ç¿’æ…£ï¼Œä½†çŸ­æœŸ CP é‚„æ˜¯æ­£çš„ã€‚å¤§è…¦é‚„æ˜¯æœƒç¹¼çºŒé€™å€‹è¿´è·¯ï¼(ä¸‹æ¬¡ç·¨è¼¯å°‡å¼·åˆ¶ä¿®æ­£)", "warning");
            }
        }

        alertBox.style.display = 'none';

        if (existingAction !== null) {
            existingAction.name = actionNameInput; existingAction.st = scores.st; existingAction.lt = scores.lt; 
            existingAction.cp = scores.final; existingAction.tokens = currentTokens; existingAction.isNew = false;
        } else {
            demand.actions.push({ id: generateId(), name: actionNameInput, st: scores.st, lt: scores.lt, cp: scores.final, tokens: currentTokens, isNew: false });
        }

        showToast("å·²æˆåŠŸå¯«å…¥å¤§è…¦æ±ºç­–ç¶²è·¯ï¼", "success");
        initApp();
    }

    initApp();
</script>
</body>
</html>